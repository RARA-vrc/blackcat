<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<title>くろねこひろば</title>
<meta name="color-scheme" content="light only">

<!-- ▼ タブアイコン（favicon / iOS用アイコン） -->
<link rel="icon" type="image/png" sizes="any" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png">
<link rel="shortcut icon" type="image/png" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png">
<link rel="apple-touch-icon" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png">
<!-- ▲ ここまで追記 -->

<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png" as="image" crossorigin>
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_sitting.png"  as="image" crossorigin>
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/angerCAT.png"    as="image" crossorigin>
<!-- ▼ 追加：ロゴのプリロード（スプラッシュ/ヘッダ） -->
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/kuronekologo2.png" as="image" crossorigin>
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/kuronekologo3.png" as="image" crossorigin>
<!-- ▲ -->

<style>
  :root{
    --bg:#fffdf9; --panel:#ffffff; --ink:#1a1a1a; --muted:#6b7280;
    --accent:#ff7aa2; --accent-ink:#fff; --border:#e5e7eb;
    --barH:60px; --ring:3px; --ringColor:rgba(255,122,162,.45);
    --pin-bg:#ffe7ef; --pin-bd:#ffc6d7;
    --burstA:#ff7aa2; --burstB:#ffc0d2;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%; margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Hiragino Kaku Gothic ProN",Meiryo,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--ink)}
  body,button,input{touch-action:manipulation}
  #app{position:fixed; inset:0; display:flex; flex-direction:column}

  header{position:sticky; top:0; z-index:50; padding:calc(env(safe-area-inset-top)+4px) 10px 8px; padding-right:calc(10px + env(safe-area-inset-right)); border-bottom:1px solid var(--border); background:var(--panel)}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px}
  .brand{display:flex; align-items:center; gap:10px; min-width:0}
  .brand h1{font-size:clamp(13px,2.2vw,16px); font-weight:800; margin:0; white-space:nowrap; cursor:pointer}
  /* ▼ ヘッダロゴ（入室後表示） & 視覚的非表示クラス */
  .vh{position:absolute!important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
  #brandLogo{height:22px; width:auto; display:none; cursor:pointer}
  @media (max-width:640px){ #brandLogo{height:18px} }
  /* ▲ */
  .chip{border:1px solid var(--border); background:#fafafa; border-radius:999px; padding:6px 10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:clamp(12px,1.6vw,14px)}
  #worldLabel{max-width:clamp(120px,38vw,360px)}
  #countDock{flex:0 0 auto; font-weight:800; background:#fff}

  .meta{display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none}
  .meta::-webkit-scrollbar{display:none}
  .btn{appearance:none; border:0; background:var(--accent); color:var(--accent-ink); border-radius:12px; padding:10px 12px; font-size:clamp(12px,1.7vw,14px); font-weight:800; cursor:pointer; min-height:40px; min-width:44px; display:inline-flex; align-items:center; gap:6px; white-space:nowrap}
  .btn.ghost{background:transparent; color:var(--ink); border:1px solid var(--border)}
  .btn.iconOnly{padding:10px; min-width:44px}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .btn:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  .icon{font-variant-emoji:emoji; font-size:18px}
  .txt{display:inline-block}
  @media (max-width:940px){ .btn.ghost .txt{display:none} }

  #play{position:relative; flex:1; overflow:hidden; background-image:radial-gradient(circle at 1px 1px,#f1f3f5 1px,transparent 0), radial-gradient(1200px 420px at 50% 120%, #f7f7f7 0%, transparent 60%); background-size:18px 18px, auto; user-select:none; touch-action:none; cursor:grab}
  #play.dragging{cursor:grabbing}
  #worldWrap{position:absolute; inset:0; transform-origin:0 0; will-change:transform}
  #world{position:absolute; left:0; top:0; width:100vmax; height:100vmax; border:2px dashed #e5e7eb; border-radius:16px; box-shadow:0 0 0 6px rgba(255,255,255,.6) inset}
  #notesLayer{position:absolute; inset:0; pointer-events:none; z-index:0}

  #bar{height:var(--barH); display:flex; align-items:center; gap:8px; border-top:1px solid var(--border); background:var(--panel); padding:8px 10px; padding-bottom:calc(8px + env(safe-area-inset-bottom)); overflow:hidden}
  #msgWrap{flex:1 1 auto; display:flex; align-items:center; gap:8px; min-width:0; overflow:hidden; white-space:nowrap}
  #msg{flex:1 1 auto; min-width:160px; font-size:16px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; outline:none; background:#fff; height:38px; line-height:22px; white-space:nowrap}
  #helper{flex:0 0 auto; display:flex; align-items:center; gap:8px; font-size:12px; color:#6b7280; max-width:34%; overflow:hidden; text-overflow:ellipsis; user-select:none}
  @media (max-width:980px){ #helper{display:none} }

  .p{position:absolute; width:78px; height:78px; transform:translate(-50%, -80%); z-index:10; will-change:left,top}
  .p.idle{opacity:.7}
  .catImg{width:78px; height:78px; display:block; object-fit:contain; pointer-events:none; transition:transform .18s ease; position:relative; z-index:0}
  .catImg.right{transform:scaleX(-1)}
  .catImg.sit{display:none}
  .catImg.angry{display:none}
  .sit .catImg.stand{display:none}
  .sit .catImg.sit{display:block}
  .emo-angry .catImg.stand,.emo-angry .catImg.sit{display:none}
  .emo-angry .catImg.angry{display:block}

  .name{position:absolute; left:50%; top:78px; transform:translateX(-50%); background:rgba(17,17,17,.95); color:#fff; font-size:12px; padding:2px 8px; border-radius:999px; white-space:nowrap; max-width:180px; text-overflow:ellipsis; overflow:hidden; letter-spacing:.2px; border:1px solid rgba(0,0,0,.6); z-index:20; pointer-events:none}
  .name.flip{top:auto; bottom:84px}

  .bubble{position:absolute; left:50%; transform:translateX(-50%); background:#fff; color:#111; border:1px solid var(--border); border-radius:12px; padding:8px 10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:min(86vw,520px); box-shadow:0 8px 22px rgba(0,0,0,.06); pointer-events:none; display:none}
  .bubble.chat{bottom:94px; font-size:14px; z-index:30}
  .bubble.pin{bottom:122px; background:var(--pin-bg); border-color:var(--pin-bd); font-size:12px; z-index:26}
  .bubble.chat.bump{bottom:148px}
  .bubble.pin.bump{bottom:182px}

  .noteItem{position:absolute; background:var(--pin-bg); border:1px solid var(--pin-bd); border-radius:10px; padding:4px 6px; font-size:0.5rem; color:#111; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; max-width:50vw; box-shadow:0 4px 12px rgba(0,0,0,.06); transform:translate(-50%, -120%)}
  .noteItem.flip{transform:translate(-50%, 18px)}

  .join-burst{position:absolute; left:0; top:0; pointer-events:none; width:0; height:0; z-index:5}
  .join-burst .ring{position:absolute; left:0; top:0; width:12px; height:12px; border:2px solid var(--burstA); border-radius:999px; transform:translate(-50%,-50%) scale(.3); opacity:.8; animation:joinRing .9s cubic-bezier(.2,.8,.2,1) forwards}
  @keyframes joinRing{60%{box-shadow:0 0 32px rgba(255,122,162,.45)} 100%{transform:translate(-50%,-50%) scale(9.5); opacity:0}}
  .join-burst .spark{position:absolute; left:0; top:0; width:6px; height:6px; background:radial-gradient(circle at 30% 30%, #fff 0, #fff 18%, var(--burstB) 19%, var(--burstA) 100%); border-radius:50%; transform:translate(-50%,-50%); opacity:.95; animation:joinSpark .9s ease-out forwards}
  @keyframes joinSpark{to{ transform:translate(var(--dx), var(--dy)); opacity:0 }}

  .spawn{position:absolute; width:26px; height:26px; border:2px solid var(--accent); border-radius:999px; transform:translate(-50%,-50%); pointer-events:none; animation:spawnPulse 1.6s ease-out infinite; z-index:4}
  @keyframes spawnPulse{0%{transform:translate(-50%,-50%) scale(.6); opacity:.9} 100%{transform:translate(-50%,-50%) scale(2.2); opacity:0}}

  #hint{position:fixed; right:10px; bottom:calc(var(--barH) + 10px + env(safe-area-inset-bottom)); background:#000; color:#fff; font-size:12px; padding:8px 10px; border-radius:10px; opacity:.92; z-index:4; display:flex; align-items:center; gap:8px}
  #hint button{background:transparent; border:0; color:#fff; font-weight:900; cursor:pointer; padding:0 2px}

  #join{position:fixed; inset:0; background:rgba(255,255,255,.9); display:flex; align-items:center; justify-content:center; z-index:100}
  #join .card{width:min(92vw,560px); border:1px solid var(--border); border-radius:18px; background:#fff; padding:18px 16px 16px; box-shadow:0 18px 60px rgba(0,0,0,.08)}
  #join h2{margin:0 0 8px; font-size:18px}
  #join p{margin:0 0 12px; font-size:14px; color:#555; line-height:1.6}
  #join .row{display:flex; gap:10px}
  #join input{flex:1; font-size:18px; padding:12px 12px; border:1px solid var(--border); border-radius:12px; outline:none; background:#fff}
  #join input:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  #join button{padding:12px 14px; border-radius:12px; background:var(--accent); color:#fff; font-weight:800; font-size:16px; border:0; cursor:pointer; white-space:nowrap}
  #warn{color:#b40000; font-size:13px; min-height:1.4em}
  .subtle{font-size:12px; color:#6b7280}
  #joinGuide{font-size:12px; color:#374151; background:#fafafa; border:1px solid var(--border); padding:10px 10px; border-radius:12px; line-height:1.65; margin-top:8px}
  #joinGuide b{color:#111}

  #namesPeek{position:fixed; left:50%; top:calc(8px + env(safe-area-inset-top)); transform:translateX(-50%); z-index:4; background:rgba(0,0,0,.84); color:#fff; font-size:13px; border-radius:12px; padding:8px 10px; max-width:90vw; white-space:normal; display:none; pointer-events:none}

  #migrate{position:fixed; left:50%; top:64px; transform:translateX(-50%); z-index:50; background:#111; color:#fff; border-radius:12px; padding:8px 10px; font-size:14px; display:none; align-items:center; gap:8px}
  #migrate .go{border:0; background:#fff; color:#111; font-weight:800; padding:6px 10px; border-radius:10px; cursor:pointer}
  #migrate .close{border:0; background:transparent; color:#fff; font-weight:800; padding:4px 8px; cursor:pointer}

  #full{position:fixed; inset:0; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; z-index:200}

  @media (prefers-reduced-motion: reduce){
    .p{transition:none} .join-burst{display:none} .spawn{animation:none} .ping{animation:none; display:none}
  }

  /* ▼ ズーム表示の視認性＆スマホでは非表示 */
  #zoomLabel{
    background:#fff; border:1px solid var(--border);
    min-width:64px; text-align:center; font-weight:800;
    padding:8px 12px; font-variant-numeric:tabular-nums; line-height:1.1;
  }
  @media (max-width:880px){
    #zoomLabel{ display:none; }
  }
  /* ▲ ここまで */

  /* ▼ 入室前スプラッシュ（フェードアウト追加） */
  #splash{position:fixed; inset:0; background:#fff; display:none; align-items:center; justify-content:center; z-index:3000; opacity:1}
  #splash.show{display:flex}
  #splash.fadeOut{ animation:splashFade .35s ease forwards }
  #splash img{width:min(60vw, 280px); height:auto; filter:drop-shadow(0 10px 24px rgba(0,0,0,.12))}
  @keyframes splashFade{to{opacity:0}}
  /* ▲ */
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="topbar">
      <div class="brand">
        <img id="brandLogo" src="" alt="logo">
        <h1 id="brandTitle">くろねこひろば</h1>
        <span class="chip" id="worldLabel"></span>
      </div>
      <span class="chip" id="countDock" aria-live="polite">🐈‍⬛ 0</span>
    </div>
    <div class="meta" id="meta">
      <button id="helpBtn"      class="btn ghost" title="使い方"><span class="icon">❔</span><span class="txt" id="lblHelp"> ヘルプ</span></button>

      <button id="poseTopBtn"   class="btn ghost" title="立つ/座る"><span class="icon">🪑</span><span class="txt" id="lblPose"> 座る</span></button>
      <button id="angerBtn"     class="btn ghost" title="威嚇"><span class="icon">💢</span><span class="txt" id="lblAnger"> 威嚇</span></button>
      <button id="muteBtn"      class="btn ghost" title="音のオン/オフ"><span class="icon" id="soundIcon">🔔</span><span class="txt" id="lblSound"> 音オン</span></button>
      <button id="newRoomBtn"   class="btn ghost" title="新しい部屋を作る"><span class="icon">🆕</span><span class="txt" id="lblNew"> 新部屋</span></button>
      <button id="shareBtn"     class="btn ghost" title="URLをコピー"><span class="icon">🔗</span><span class="txt" id="lblShare"> 共有</span></button>

      <button id="zoomOutBtn"   class="btn ghost iconOnly" title="ズームアウト"><span class="icon">➖</span></button>
      <span   id="zoomLabel"    class="chip" aria-live="polite">100%</span>
      <button id="zoomInBtn"    class="btn ghost iconOnly" title="ズームイン"><span class="icon">➕</span></button>

      <button id="leaveBtn"     class="btn ghost" title="退室"><span class="icon">🚪</span><span class="txt" id="lblLeave"> 退室</span></button>
      <button id="noteClearBtn" class="btn ghost" title="自分の書き置きを消す"><span class="icon">🗑️</span><span class="txt" id="lblClear"> クリア</span></button>
      <button id="langBtn"      class="btn ghost" title="言語切替"><span class="icon" id="langIcon">🇯🇵</span><span class="txt" id="lblLang"> 日本語</span></button>
    </div>
  </header>

  <div id="play" aria-label="play-area">
    <div id="worldWrap">
      <div id="world">
        <div id="notesLayer"></div>
      </div>
    </div>
  </div>

  <div id="bar">
    <div id="msgWrap">
      <input id="msg" type="text" inputmode="text" autocomplete="off" placeholder="(15文字 / 10 words)" aria-label="メッセージ入力">
      <div id="helper"><span id="hintLang">非英語：0/15</span><span id="hintKeys">Enterで送信  Sで座る</span></div>
    </div>
    <button id="pinBtn"  class="btn iconOnly" title="ピン留め"><span class="icon">📌</span></button>
    <button id="noteBtn" class="btn iconOnly" title="書き置き"><span class="icon">🖋️</span></button>
    <button id="send"    class="btn iconOnly" disabled title="送信"><span class="icon">📨</span></button>
  </div>

  <div id="hint" role="status" aria-live="polite">
    <span id="hintText">ドラッグでフィールド移動。ダブルタップ/ダブルクリックでネコが移動。ピンチでズーム。</span>
    <button id="hintClose" aria-label="閉じる">✕</button>
  </div>
</div>

<div id="namesPeek" aria-live="polite"></div>

<div id="migrate" role="alert">
  <span id="migrateText">🆕 新しい部屋が作られた</span>
  <button class="go" id="migrateGo">移動</button>
  <button class="close" id="migrateClose" aria-label="閉じる">✕</button>
</div>

<div id="join" role="dialog" aria-modal="true" aria-label="名前入力">
  <div class="card">
    <h2 id="joinTitle">名前を入れて参加</h2>
    <p id="joinDesc">名前は3文字まで。URLが同じなら同じ部屋。落ち着いて遊ぶ場。</p>
    <div class="row">
      <input id="nameInput" maxlength="3" aria-label="名前（3文字まで）">
      <button id="enterBtn">はじめる</button>
    </div>
    <div id="warn" role="status" aria-live="polite"></div>
    <div id="joinGuide" class="subtle"></div>
    <p class="subtle" id="joinHint">音が出ないときは一度画面をタップしてからミュートを確かめる。</p>
  </div>
</div>

<!-- ▼ 入室前スプラッシュ -->
<div id="splash"><img src="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/kuronekologo2.png" alt="logo"></div>
<!-- ▲ -->

<dialog id="helpDialog"></dialog>
<div id="full" style="display:none"></div>

<script type="module">
/* ===== 画像URL ===== */
const CAT_STAND_URL = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png";
const CAT_SIT_URL   = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_sitting.png";
const CAT_ANGRY_URL = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/angerCAT.png";
const LOGO_SPLASH_URL = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/kuronekologo2.png";  // 起動時
const LOGO_HEADER_URL = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/kuronekologo3.png";  // 入室後ヘッダ
const SPLASH_MS = 2000;

/* ===== パラメータ ===== */
const HEARTBEAT_MS   = 7000;
const IDLE_MS        = 90*1000;
const NOTE_TTL_MS    = 8*60*60*1000;
const EMO_SHOW_MS    = 3000;
const ROOM_CAP       = 10;
const MIGRATE_TTL_MS = 30000;
const SPEED_PX_PER_S = 120;
const NON_ASCII_LIMIT= 15;
const BUBBLE_MS      = 60000;
const ZMIN           = 0.4, ZMAX = 2.0;
const STALE_MS_PLAYERS = 60*60*1000;
const NAME_REASSERT_MS = 60*1000;

/* ===== i18n ===== */
const I18N={ /* 省略なし（元のまま） */ 
  ja:{brand:"くろねこひろば",roomCount:n=>`🐈‍⬛ ${n}`,namesPeek:list=>`いまの参加者： ${list}`,poseSit:"座る",poseStand:"立つ",anger:"威嚇",soundOn:"音オン",soundMute:"ミュート",newRoom:"新部屋",share:"共有",clear:"クリア",help:"ヘルプ",lang:"日本語",leave:"退室",msgPlaceholder:"(15文字 / 10 words)",hintKeys:"Enterで送信  Sで座る",hint:"ドラッグでフィールド移動。ダブルタップ/ダブルクリックでネコが移動。ピンチでズーム。",joinTitle:"名前を入れて参加",joinDesc:"名前は3文字まで。URLが同じなら同じ部屋。落ち着いて遊ぶ場。",joinStart:"はじめる",joinHint:"音が出ないときは一度画面をタップしてからミュートを確かめる。",confirmLeave:"今の部屋から退室する。OK？",left:"退室した",notify:{join:n=>`${n} が入室した`,leave:n=>`${n} が退室した`,pinOn:"ピンを固定した",pinOff:"ピンを外した",noteSaved:"書き置きを残した",noteUpdated:"書き置きを更新した",noteCleared:"書き置きを消した",urlCopied:"リンクをコピーした。フレンドを招待できる",newRoomBy:n=>`${n} が新しい部屋を作成`,full:n=>`満員だ。${n}人まで`,online:"オンライン",offline:"オフライン。再接続待ち",errorAuth:"認証エラー。設定を確認"}},
  en:{brand:"Black Cats Plaza",roomCount:n=>`🐈‍⬛ ${n}`,namesPeek:list=>`Players: ${list}`,poseSit:"Sit",poseStand:"Stand",anger:"Angry",soundOn:"Sound",soundMute:"Muted",newRoom:"New",share:"Share",clear:"Clear",help:"Help",lang:"English",leave:"Leave",msgPlaceholder:"(15 chars / 10 words)",hintKeys:"Enter to send  S to sit/stand",hint:"Drag to move the field. Double-tap/double-click to move your cat. Pinch to zoom.",joinTitle:"Enter name to join",joinDesc:"Up to 3 characters. Same URL, same room. A chill place.",joinStart:"Start",joinHint:"No sound? Tap once and toggle the bell.",confirmLeave:"Leave this room?",left:"Left",notify:{join:n=>`${n} joined`,leave:n=>`${n} left`,pinOn:"Pinned",pinOff:"Unpinned",noteSaved:"Note saved",noteUpdated:"Note updated",noteCleared:"Note cleared",urlCopied:"Link copied. Invite friends",newRoomBy:n=>`${n} created a new room`,full:n=>`Room is full (max ${n})`,online:"Online",offline:"Offline. Reconnecting",errorAuth:"Auth error"}}
};
let LANG="ja";

/* ===== Firebase ===== */
const firebaseConfig = {
  apiKey:"AIzaSyCUpt4XLfSSZLt0VhJon926--c-I2tRMkE",
  authDomain:"blackcat-67716.firebaseapp.com",
  databaseURL:"https://blackcat-67716-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"blackcat-67716",
  storageBucket:"blackcat-67716.appspot.com",
  messagingSenderId:"124690483795",
  appId:"1:124690483795:web:73b5b2ba28f4e4d503d4a6",
  measurementId:"G-R47HW00266"
};

/* ===== ルームID ===== */
const url=new URL(location.href);
const qp=url.searchParams.get("room");
const hp=(location.hash.match(/room=([^&]+)/)||[])[1];
function makeRoomId(){ const t=Date.now().toString(36).slice(-6); const r=crypto.getRandomValues(new Uint32Array(1))[0].toString(36).slice(-5); return `plaza-${t}-${r}`; }
function setURLRoom(id){ const u=new URL(location.href); u.searchParams.set("room",id); u.hash=u.hash.replace(/room=[^&]+&?/,'').replace(/[#&]$/,''); history.replaceState({}, "", u.toString()); }
let WORLD_ID=qp||hp||null; if(!WORLD_ID){ WORLD_ID=makeRoomId(); setURLRoom(WORLD_ID); }

/* ===== Firebase SDK ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set, update, onDisconnect, get, remove }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const auth=getAuth(app);

/* ===== DOM ===== */
const play=document.getElementById("play");
const worldWrap=document.getElementById("worldWrap");
const world=document.getElementById("world");
const notesLayer=document.getElementById("notesLayer");
const bar=document.getElementById("bar");

const msgInput=document.getElementById("msg");
const sendBtn=document.getElementById("send");
const pinBtn=document.getElementById("pinBtn");
const noteBtn=document.getElementById("noteBtn");
const noteClearBtn=document.getElementById("noteClearBtn");
const poseTopBtn=document.getElementById("poseTopBtn");
const angerBtn=document.getElementById("angerBtn");
const join=document.getElementById("join");
const nameInput=document.getElementById("nameInput");
const enterBtn=document.getElementById("enterBtn");
const warn=document.getElementById("warn");
const worldLabel=document.getElementById("worldLabel");
const countDock=document.getElementById("countDock");
const shareBtn=document.getElementById("shareBtn");
const helpBtn=document.getElementById("helpBtn");
const helpDialog=document.getElementById("helpDialog");
const hintLang=document.getElementById("hintLang");
const hintKeys=document.getElementById("hintKeys");
const muteBtn=document.getElementById("muteBtn");
const soundIcon=document.getElementById("soundIcon");
const namesPeek=document.getElementById("namesPeek");
const full=document.getElementById("full");
const newRoomBtn=document.getElementById("newRoomBtn");
const migrate=document.getElementById("migrate");
const migrateText=document.getElementById("migrateText");
const migrateGo=document.getElementById("migrateGo");
const migrateClose=document.getElementById("migrateClose");
const langBtn=document.getElementById("langBtn");
const brandTitle=document.getElementById("brandTitle");
const brandLogo=document.getElementById("brandLogo");
const splash=document.getElementById("splash");
const langIcon=document.getElementById("langIcon");
const lblPose=document.getElementById("lblPose");
const lblAnger=document.getElementById("lblAnger");
const lblSound=document.getElementById("lblSound");
const lblNew=document.getElementById("lblNew");
const lblShare=document.getElementById("lblShare");
const lblClear=document.getElementById("lblClear");
const lblHelp=document.getElementById("lblHelp");
const lblLang=document.getElementById("lblLang");
const lblLeave=document.getElementById("lblLeave");
const zoomOutBtn=document.getElementById("zoomOutBtn");
const zoomInBtn=document.getElementById("zoomInBtn");
const zoomLabel=document.getElementById("zoomLabel");
const hintBox=document.getElementById("hint");
const hintText=document.getElementById("hintText");
const hintClose=document.getElementById("hintClose");
const leaveBtn=document.getElementById("leaveBtn");

worldLabel.textContent=`room: ${WORLD_ID}`;
countDock.textContent="🐈‍⬛ 0";

/* ===== サウンド ===== */
let AC=null, masterGain=null; let muted=localStorage.getItem("yuru_mute")==="1";
function unlockAudio(){ const Ctx=window.AudioContext||window.webkitAudioContext; if(!AC && Ctx){ AC=new Ctx(); masterGain=AC.createGain(); masterGain.gain.value=muted?0:0.24; masterGain.connect(AC.destination);} if(AC&&AC.state==="suspended") AC.resume(); }
function setupAudioUnlock(){ const once=()=>{unlockAudio(); document.removeEventListener("pointerdown", once); document.removeEventListener("keydown", once);}; document.addEventListener("pointerdown", once, {passive:true}); document.addEventListener("keydown", once); enterBtn.addEventListener("click", unlockAudio, {once:true}); } setupAudioUnlock();
function tone({freq=880,dur=0.12,type="sine",vol=0.7,attack=0.005,release=0.12}={}){ if(!AC) return; const o=AC.createOscillator(); const g=AC.createGain(); o.type=type; o.frequency.value=freq; o.connect(g); g.connect(masterGain||AC.destination); const t=AC.currentTime; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+attack); g.gain.exponentialRampToValueAtTime(0.0001,t+attack+release); o.start(t); o.stop(t+dur+0.25); }
function playLogin(){ if(!muted&&AC){ tone({freq:880,type:"triangle",vol:0.55,dur:0.12}); setTimeout(()=>tone({freq:1320,type:"triangle",vol:0.55,dur:0.12}),140); } }
function playMessage(){ if(!muted&&AC){ tone({freq:700,type:"sine",vol:0.5,dur:0.09}); } }
/* ▼ 追加：かわいいログイン効果音（3音） */
function playCuteLogin(){
  if(muted || !AC) return;
  tone({freq:880,type:"sine",vol:0.55,dur:0.10});          // A5
  setTimeout(()=>tone({freq:1175,type:"sine",vol:0.50,dur:0.10}),140); // D6#
  setTimeout(()=>tone({freq:1568,type:"triangle",vol:0.55,dur:0.14}),280); // G6
}
/* ▲ */

/* ===== お知らせ ===== */
function notify(text, ttl=90000){ hintText.textContent=text; hintBox.style.display="flex"; hintBox.style.opacity=.95; clearTimeout(notify._t); notify._t=setTimeout(()=>{ hintBox.style.display="none"; }, ttl); }
function toast(text, ttl=2200){ notify(text, ttl); }
hintClose.addEventListener("click", ()=>{ hintBox.style.display="none"; clearTimeout(notify._t); });

/* ===== 状態 ===== */
const lastShownName=new Map();
let hasOwnNote=false;
let uid=null, joined=false, mounted=false;
let me={ name:"", x:0.5, y:0.7, dir:1, pose:"stand", msg:"", msgAt:0, pinMsg:"", emo:"none", emoAt:0 };
let target={x:me.x,y:me.y};
let lastSync=0, lastHeartbeat=0, lastNameAssert=0;
let zoom=1, panX=0, panY=0, userPanned=false;

/* ===== util ===== */
const clamp01=v=>Math.max(0,Math.min(1,v));
const isASCIIish=s=>/^[\x00-\x7F]+$/.test(s);
const countWordsASCII=s=>s.trim().split(/\s+/).filter(Boolean).length;
function worldSize(){ return {w:world.offsetWidth, h:world.offsetHeight}; }
function toPxLocal(nx,ny){ const {w,h}=worldSize(); return {x:nx*w, y:ny*h}; }
function toNormFromClient(cx,cy){ const r=world.getBoundingClientRect(); return {x:clamp01((cx-r.left)/r.width), y:clamp01((cy-r.top)/r.height)}; }
function normalizeName(s){ if(typeof s!=="string") return ""; const t=s.trim(); return t.length?Array.from(t).slice(0,3).join(""):""; }

/* ===== Refs ===== */
function playersRefOf(room){ return ref(db, `worlds/${room}/players`); }
function myRef(){ return ref(db, `worlds/${WORLD_ID}/players/${uid}`); }
function notesRootRef(){ return ref(db, `worlds/${WORLD_ID}/notes`); }
function noteRefOf(u){ return ref(db, `worlds/${WORLD_ID}/notes/${u}`); }
function metaRef(){ return ref(db, `worlds/${WORLD_ID}/meta`); }
const playersRef=playersRefOf(WORLD_ID);

/* ===== ヘルプ/文言適用 ===== */
function helpHtml(){
  if(LANG==="ja"){
    return `<h3 style="margin:0 0 8px">使い方</h3>
      <ul style="margin:0 0 12px 18px; line-height:1.7; color:#374151; font-size:14px">
        <li>マウス/指で<b>ドラッグしてフィールド移動</b>。二本指でズーム・パン</li>
        <li>📍 <b>ダブルクリック/ダブルタップでネコ移動</b></li>
        <li>📨 英語10語/日本語など15文字。60秒で消える</li>
        <li>📌 頭上固定（再押しで解除）</li>
        <li>🖋️ 足元に書き置き（ひとり一件・更新可・<b>8時間で自動削除</b>）</li>
        <li>🪑 立つ/座る、💢 威嚇（3秒）</li>
        <li>🐈‍⬛ 名簿表示、🔗 共有、🆕 新部屋、🚪 退室</li>
        <li>最大<b>${ROOM_CAP}人</b>。<b>1時間無反応は自動退室扱い</b></li>
      </ul>`;
  }else{
    return `<h3 style="margin:0 0 8px">How to play</h3>
      <ul style="margin:0 0 12px 18px; line-height:1.7; color:#374151; font-size:14px">
        <li><b>Drag</b> to move. Two fingers to zoom & pan</li>
        <li>📍 <b>Double-tap/double-click to move your cat</b></li>
        <li>📨 English ≤10 words / others ≤15 chars. Fades in 60s</li>
        <li>📌 Status above head (toggle to clear)</li>
        <li>🖋️ One note near feet (<b>auto-clears in 8h</b>)</li>
        <li>🪑 Sit/Stand, 💢 Angry (3s)</li>
        <li>🐈‍⬛ Roster, 🔗 share, 🆕 new room, 🚪 leave</li>
        <li>Max <b>${ROOM_CAP}</b>. <b>Inactive 1h ⇒ auto-removed</b></li>
      </ul>`;
  }
}
function joinGuideHtml(){
  if(LANG==="ja"){
    return `<div>📨 チャット：英語10語/日本語15文字、60秒で消える</div>
      <div>📌 頭上に固定（再押しで解除）</div>
      <div>🖋️ 書置は8時間で自動削除</div>
      <div>🖱️ ドラッグ移動／ダブルタップ移動／ピンチズーム</div>
      <div>👥 上限 <b>${ROOM_CAP}人</b>、<b>1時間無反応は自動退室扱い</b></div>`;
  }else{
    return `<div>📨 Chat fades in 60s</div>
      <div>📌 Small status above head</div>
      <div>🖋️ Notes auto-clear in 8h</div>
      <div>🖱️ Drag / double-tap / pinch-zoom</div>
      <div>👥 Max <b>${ROOM_CAP}</b>; <b>inactive 1h = auto-removed</b></div>`;
  }
}
function applyLang(){
  const T=I18N[LANG];
  document.getElementById("brandTitle").textContent=T.brand;
  msgInput.placeholder=T.msgPlaceholder;
  document.getElementById("hintKeys").textContent=T.hintKeys;
  notify(T.hint, 90000);
  lblPose.textContent  =" "+(me.pose==="stand"?T.poseSit:T.poseStand);
  lblAnger.textContent =" "+T.anger;
  lblNew.textContent   =" "+T.newRoom;
  lblShare.textContent =" "+T.share;
  lblClear.textContent =" "+T.clear;
  lblHelp.textContent  =" "+T.help;
  lblLang.textContent  =" "+T.lang;
  lblLeave.textContent =" "+T.leave;
  langIcon.textContent=(LANG==="ja")?"🇯🇵":"🇺🇸";
  document.getElementById("joinTitle").textContent=T.joinTitle;
  document.getElementById("joinDesc").textContent=T.joinDesc;
  document.getElementById("joinHint").textContent=(LANG==="ja"?"音が出ないときは一度画面をタップしてからミュートを確かめる。":"No sound? Tap once and toggle the bell.");
  document.getElementById("joinGuide").innerHTML = joinGuideHtml();
  renderMuteButton();
}
applyLang();
langBtn.addEventListener("click", ()=>{ LANG=(LANG==="ja")?"en":"ja"; applyLang(); });

worldLabel.textContent=`room: ${WORLD_ID}`;

/* ===== 参加 ===== */
nameInput.addEventListener("input", ()=>{ const n=nameInput.value.trim(); if([...n].length>3) nameInput.value=Array.from(n).slice(0,3).join(""); });
enterBtn.addEventListener("click", startJoin);
nameInput.addEventListener("keydown", e=>{ if(e.key==="Enter") startJoin(); });

/* ▼ アクセス直後スプラッシュ（名前入力前）— フェードアウト付き */
function showSplashOnBoot(){
  if(!splash) return;
  splash.firstElementChild?.setAttribute("src", LOGO_SPLASH_URL);
  splash.classList.add("show");
  splash.style.display="flex";
  // 指定時間の後にフェードアウト開始
  setTimeout(()=>{ splash.classList.add("fadeOut"); }, SPLASH_MS);
  // フェード終了で非表示に（prefers-reduced-motion でも安全）
  const onEnd=(e)=>{ if(e.animationName==="splashFade"){ splash.classList.remove("show","fadeOut"); splash.style.display="none"; splash.removeEventListener("animationend", onEnd); } };
  splash.addEventListener("animationend", onEnd);
}
/* ▲ */

async function startJoin(){
  const n=normalizeName(nameInput.value);
  if(!n){ warn.textContent=LANG==="ja"?"1〜3文字":"1–3 characters"; return; }
  warn.textContent="";
  me.name=n; joined=true; me.pose="stand"; me.pinMsg="";
  join.style.display="none";
  playCuteLogin();    // ★ 追加：かわいいログイン効果音
  if(uid && !mounted){ await initAfterAuth(); }
}

/* ===== 認証 ===== */
initAuthOnBoot();
async function initAuthOnBoot(){ try{ await signInAnonymously(auth); }catch(e){ console.error("[auth] anon failed:", e); toast(I18N[LANG].notify.errorAuth, 6000); } }
onAuthStateChanged(auth, async u=>{ if(!u) return; uid=u.uid; if(joined && !mounted){ await initAfterAuth(); } });

/* ===== 満員判定＆掃除 ===== */
async function ensureCapacity(){
  try{
    const snap=await get(playersRef);
    const now=Date.now(); let nActive=0;
    snap.forEach(ch=>{ const v=ch.val()||{}; const la=Number(v.lastActive||0); if(la && now-la<=STALE_MS_PLAYERS) nActive++; });
    return nActive < ROOM_CAP;
  }catch{ return true; }
}
async function cleanupStalePlayers(){
  try{
    const snap=await get(playersRef);
    const now=Date.now(); const jobs=[];
    snap.forEach(ch=>{
      const v=ch.val()||{}; const la=Number(v.lastActive||0);
      if(!la || (now-la)>STALE_MS_PLAYERS){ jobs.push( remove(ref(db,`worlds/${WORLD_ID}/players/${ch.key}`)).catch(()=>{}) ); }
    });
    if(jobs.length) await Promise.allSettled(jobs);
  }catch(e){ console.warn("cleanupStalePlayers failed:", e); }
}

/* ===== 名前の強制同期 ===== */
async function forceNameSync(){
  try{
    const snap = await get(myRef());
    const want = normalizeName(me.name);
    if(!snap.exists()){
      await set(myRef(), {name:want,x:me.x,y:me.y,dir:me.dir,pose:me.pose,msg:"",msgAt:0,pinMsg:me.pinMsg||"",pinAt:me.pinMsg?Date.now():0,emo:"none",emoAt:0,lastActive:Date.now()});
      try{ onDisconnect(myRef()).remove(); }catch{}
      return;
    }
    const cur = (snap.val()||{}).name || "";
    if(normalizeName(cur)!==want){
      await update(myRef(), { name: want, lastActive: Date.now() });
    }
  }catch(e){ console.warn("forceNameSync failed:", e); }
}

/* ===== 初期化 ===== */
async function initAfterAuth(){
  await cleanupStalePlayers();
  const ok=await ensureCapacity(); if(!ok){ showFull(); return; }

  me.x=Math.random()*0.8+0.1; me.y=Math.random()*0.4+0.5; target={x:me.x,y:me.y};
  centerWorld(); applyView();
  ensureMineDom();

  await mountPresence(true);
  await forceNameSync();

  // 入室後：ヘッダロゴに切替（kuronekologo3.png）
  if(brandLogo){
    brandLogo.src = LOGO_HEADER_URL;
    brandLogo.style.display = "block";
    brandLogo.alt = I18N[LANG].brand || "logo";
    brandLogo.addEventListener("click", peekNames);
    brandTitle.classList.add("vh");
  }

  startLoop();
  subscribePlayers();
  subscribeNotes();
  subscribeMeta();
  monitorReconnect();
  spawnPulse(me.x, me.y);
  mounted=true;

  setInterval(()=>cleanupStalePlayers(), 5*60*1000);
}
function showFull(){
  full.style.display="flex";
  const msg=(LANG==="ja")?I18N.ja.notify.full(ROOM_CAP):I18N.en.notify.full(ROOM_CAP);
  full.innerHTML=`<div class="card"><h3>${msg.split("。")[0]}</h3><p>${ROOM_CAP}${LANG==="ja"?"人まで":" max"}</p></div>`;
}

/* ===== プレゼンス ===== */
async function mountPresence(forceStand=false){
  try{
    await set(myRef(), {name:normalizeName(me.name), x:me.x, y:me.y, dir:me.dir, pose:forceStand?"stand":me.pose, msg:"", msgAt:0, pinMsg:me.pinMsg||"", pinAt:me.pinMsg?Date.now():0, emo:"none", emoAt:0, lastActive:Date.now()});
  }catch(e){ console.error("[rtdb] initial set failed:", e); }
  try{ onDisconnect(myRef()).remove(); }catch(e){ console.warn("[rtdb] onDisconnect set failed:", e); }
}
window.addEventListener("visibilitychange", ()=>{ try{ update(myRef(), {lastActive:Date.now()}); }catch{} });
window.addEventListener("pagehide", ()=>{ try{ update(myRef(), {lastActive:Date.now()}); }catch{} });

/* 再接続監視 */
function monitorReconnect(){
  const conn=ref(db,".info/connected");
  onValue(conn, async s=>{
    const c=s.val();
    if(c===true && uid && joined){
      try{
        const snap=await get(myRef());
        if(snap.exists()){
          await update(myRef(), { lastActive:Date.now(), name:normalizeName(me.name) });
        }else{
          await mountPresence(false);
          await forceNameSync();
        }
      }catch(e){ console.warn("reconnect ensure presence failed:", e); }
    }
  });
}

/* ===== players購読 ===== */
const domMap=new Map();
let initialPlayersLoaded=false;
let latestPlayers={};
function subscribePlayers(){
  onValue(playersRef, snap=>{
    const data=snap.val()||{}; latestPlayers=data; const ids=Object.keys(data);

    const now=Date.now(); let nActive=0;
    for(const id of ids){ const la=Number((data[id]||{}).lastActive||0); if(la && now-la<=STALE_MS_PLAYERS) nActive++; }
    countDock.textContent=(LANG==="ja"?I18N.ja.roomCount:I18N.en.roomCount)(nActive);

    const seen=new Set(ids); const nowMs=Date.now();

    for(const id of ids){
      const p=data[id]||{};
      let pdom=domMap.get(id);
      const isNew=!pdom;
      if(isNew){
        pdom=createPlayerDom(id);
        domMap.set(id,pdom);
        world.appendChild(pdom.wrap);
        if(initialPlayersLoaded && id!==uid){
          joinBurstAt(p.x??0.5, p.y??0.7);
          playLogin();
          const nm=normalizeName(p?.name||"");
          if(nm) toast((LANG==="ja"?I18N.ja:I18N.en).notify.join(nm), 2200);
        }
      }
      const ts=Number(p.lastActive||0);
      const isIdle = ts>0 && (nowMs - ts) > IDLE_MS;
      pdom.wrap.classList.toggle("idle", isIdle);

      renderPlayer(pdom, p, id===uid);
    }
    for(const [id,pdom] of domMap){
      if(!seen.has(id)){
        const nm=normalizeName((latestPlayers[id]?.name)||"");
        if(initialPlayersLoaded && id!==uid && nm){ toast((LANG==="ja"?I18N.ja:I18N.en).notify.leave(nm), 2200); }
        pdom.wrap.remove(); domMap.delete(id);
      }
    }
    if(!initialPlayersLoaded && ids.includes(uid)) initialPlayersLoaded=true;
  });
}

/* ===== DOM生成・描画 ===== */
function joinBurstAt(nx,ny){
  const r=world.getBoundingClientRect();
  const x=r.left + nx*r.width, y=r.top + ny*r.height;
  const fx=document.createElement("div"); fx.className="join-burst"; fx.style.left=`${x}px`; fx.style.top=`${y}px`;
  const ring=document.createElement("div"); ring.className="ring"; fx.appendChild(ring);
  const N=14; for(let i=0;i<N;i++){ const th=(Math.PI*2/N)*i + Math.random()*0.25; const dist=64+Math.random()*36; const dx=Math.cos(th)*dist, dy=Math.sin(th)*dist; const s=document.createElement("span"); s.className="spark"; s.style.setProperty("--dx", `${dx.toFixed(1)}px`); s.style.setProperty("--dy", `${dy.toFixed(1)}px`); s.style.animationDelay=`${(Math.random()*0.06).toFixed(3)}s`; fx.appendChild(s); }
  document.body.appendChild(fx); setTimeout(()=>fx.remove(), 950);
}
function spawnPulse(nx,ny){
  const {x,y}=toPxLocal(nx,ny);
  const el=document.createElement("div"); el.className="spawn"; el.style.left=`${x}px`; el.style.top=`${y}px`;
  world.appendChild(el); setTimeout(()=>el.remove(), 3000);
}
function createPlayerDom(id){
  const wrap=document.createElement("div"); wrap.className="p stand";
  const nameEl=document.createElement("div"); nameEl.className="name";
  const bubble=document.createElement("div"); bubble.className="bubble chat";
  const pinBubble=document.createElement("div"); pinBubble.className="bubble pin";
  const standImg=new Image(); standImg.src=CAT_STAND_URL; standImg.className="catImg stand";
  const sitImg  =new Image(); sitImg.src  =CAT_SIT_URL;   sitImg.className="catImg sit";
  const angryImg=new Image(); angryImg.src=CAT_ANGRY_URL; angryImg.className="catImg angry";
  wrap.appendChild(nameEl); wrap.appendChild(pinBubble); wrap.appendChild(bubble); wrap.appendChild(standImg); wrap.appendChild(sitImg); wrap.appendChild(angryImg);
  return {wrap, nameEl, bubbleEl:bubble, pinBubbleEl:pinBubble, standImg, sitImg, angryImg, _lastShownMsgAt:0, _flip:false, _id:id};
}
function normalizeNameOrCache(id, name){
  const n=normalizeName(name||""); if(n){ lastShownName.set(id,n); return n; } return lastShownName.get(id)||"";
}
function renderPlayer(pdom, data, isSelf){
  const {w,h}=worldSize();
  const px=(data.x??0.5)*w, py=(data.y??0.7)*h;
  pdom.wrap.style.left=`${px}px`; pdom.wrap.style.top=`${py}px`;

  if(data.pose==="sit"){ pdom.wrap.classList.add("sit"); pdom.wrap.classList.remove("stand"); }
  else { pdom.wrap.classList.add("stand"); pdom.wrap.classList.remove("sit"); }

  const right=(data.dir===1);
  pdom.standImg.classList.toggle("right", right);
  pdom.sitImg.classList.toggle("right", right);
  pdom.angryImg.classList.toggle("right", right);

  const emoActive=(data.emo==="angry") && (Date.now()-Number(data.emoAt||0) <= EMO_SHOW_MS);
  pdom.wrap.classList.toggle("emo-angry", emoActive);

  const decidedName=normalizeNameOrCache(pdom._id, data?.name||"");
  pdom.nameEl.style.display = decidedName ? "block":"none";
  if(decidedName && pdom.nameEl.textContent!==decidedName) pdom.nameEl.textContent=decidedName;

  const wr=world.getBoundingClientRect();
  const screenY = wr.top + (data.y??0.7)*wr.height;
  const visibleBottom = window.innerHeight - (bar.getBoundingClientRect().height||0);
  const wantFlip = (screenY + 110) > visibleBottom;
  if(!pdom._flip && wantFlip){ pdom.nameEl.classList.add("flip"); pdom._flip=true; }
  else if(pdom._flip && (screenY + 130) < visibleBottom){ pdom.nameEl.classList.remove("flip"); pdom._flip=false; }
  pdom.bubbleEl.classList.toggle("bump", pdom._flip);
  pdom.pinBubbleEl.classList.toggle("bump", pdom._flip);

  const raw=data.msg||""; const msgAt=Number(data.msgAt||0);
  if(raw && msgAt>0){
    const nowAbs=Date.now(); const REPLAY_GUARD_MS=4000;
    const isReplaySelf=isSelf && (msgAt - pdom._lastShownMsgAt < REPLAY_GUARD_MS);
    if(msgAt>pdom._lastShownMsgAt && !isReplaySelf){
      pdom.bubbleEl.textContent=raw; pdom.bubbleEl.style.display="block";
      clearTimeout(pdom._bubbleTimer);
      const age=Math.max(0, nowAbs-msgAt); const remain=Math.max(1200, BUBBLE_MS - age);
      pdom._bubbleTimer=setTimeout(()=>{ pdom.bubbleEl.style.display="none"; }, remain);
      pdom._lastShownMsgAt=msgAt; if(!isSelf) playMessage();
    }
  }else{ pdom.bubbleEl.style.display="none"; }

  const pinText=data.pinMsg||"";
  if(pinText){ pdom.pinBubbleEl.textContent=pinText; pdom.pinBubbleEl.style.display="block"; }
  else{ pdom.pinBubbleEl.style.display="none"; }
}

/* ===== 自分DOM ===== */
function ensureMineDom(){
  if(!uid) return;
  if(!domMap.get(uid)){ const d=createPlayerDom(uid); domMap.set(uid,d); world.appendChild(d.wrap); }
  const data={x:me.x,y:me.y,dir:me.dir,pose:me.pose,msg:me.msg,msgAt:me.msgAt,pinMsg:me.pinMsg,name:normalizeName(me.name),emo:me.emo,emoAt:me.emoAt};
  renderPlayer(domMap.get(uid), data, true);
}

/* ===== 入力/ピン/書置/威嚇/退室 ===== */
let lastSentAt=0;
function validateMessage(raw){
  if(!raw) return {ok:false};
  if(isASCIIish(raw)){ if(countWordsASCII(raw)>10 || raw.length>100) return {ok:false}; }
  else { if(Array.from(raw).length>NON_ASCII_LIMIT) return {ok:false}; }
  return {ok:true};
}
msgInput.addEventListener("input", ()=>{
  const v=msgInput.value;
  if(isASCIIish(v)){ const w=countWordsASCII(v); hintLang.textContent=`英語：${Math.min(w,10)}/10`; }
  else{ const len=Array.from(v).length; hintLang.textContent=`非英語：${Math.min(len,NON_ASCII_LIMIT)}/15`; }
  sendBtn.disabled=!validateMessage(v).ok;
});
sendBtn.addEventListener("click", sendMsg);
msgInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMsg(); }});
function sendMsg(){
  const raw=msgInput.value.trim(); if(!validateMessage(raw).ok) return;
  const nowMs=Date.now(); if(nowMs-lastSentAt<500) return; lastSentAt=nowMs;
  me.msg=raw; me.msgAt=nowMs; ensureMineDom(); const mine=domMap.get(uid); if(mine){ mine._lastShownMsgAt=nowMs; }
  msgInput.value=""; sendBtn.disabled=true;
  safeUpdate({msg:raw, msgAt:Date.now()});
}

/* ピン */
function renderPinBtn(){ pinBtn.setAttribute("aria-pressed", me.pinMsg?"true":"false"); } renderPinBtn();
pinBtn.addEventListener("click", ()=>{
  if(me.pinMsg){
    me.pinMsg=""; renderPinBtn(); safeUpdate({pinMsg:"", pinAt:0});
    const mine=domMap.get(uid); if(mine){ mine.pinBubbleEl.style.display="none"; }
    toast((LANG==="ja"?I18N.ja:I18N.en).notify.pinOff, 1800); return;
  }
  const typed=msgInput.value.trim(); const pick=typed?typed:(me.msg?me.msg:"");
  if(!pick){ toast(LANG==="ja"?"ピンに入れる文がない":"Nothing to pin", 2200); return; }
  if(typed && !validateMessage(typed).ok){ toast(LANG==="ja"?"文字数の上限":"Too long", 2200); return; }
  me.pinMsg=pick; renderPinBtn();
  const mine=domMap.get(uid); if(mine){ mine.pinBubbleEl.textContent=pick; mine.pinBubbleEl.style.display="block"; }
  safeUpdate({pinMsg:pick, pinAt:Date.now()});
  toast((LANG==="ja"?I18N.ja:I18N.en).notify.pinOn, 1800);
});

/* 書き置き */
noteBtn.addEventListener("click", async ()=>{
  const typed=msgInput.value.trim(); const pick=typed?typed:(me.msg?me.msg:"");
  if(!pick){ toast(LANG==="ja"?"書き置きする文がない":"Nothing to note", 2200); return; }
  if(typed && !validateMessage(typed).ok){ toast(LANG==="ja"?"文字数の上限":"Too long", 2200); return; }
  try{
    const r=noteRefOf(uid); const nowXY={x:me.x,y:me.y}; const snap=await get(r);
    const authorName=normalizeName(me.name);
    if(snap.exists()){
      await update(r,{text:pick,author:authorName,uid:uid,x:nowXY.x,y:nowXY.y,updatedAt:Date.now()});
      toast((LANG==="ja"?I18N.ja:I18N.en).notify.noteUpdated, 1800);
    }else{
      await set(r,{text:pick,author:authorName,uid:uid,x:nowXY.x,y:nowXY.y,at:Date.now(),updatedAt:Date.now()});
      toast((LANG==="ja"?I18N.ja:I18N.en).notify.noteSaved, 1800);
    }
  }catch(e){ console.error("note set/update failed:", e); toast(LANG==="ja"?"書き置きに失敗":"Failed to save note", 2200); }
});
noteClearBtn.addEventListener("click", async ()=>{
  if(!uid) return;
  try{ await remove(noteRefOf(uid)); toast((LANG==="ja"?I18N.ja:I18N.en).notify.noteCleared, 1800); }
  catch(e){ console.error("note clear failed:", e); toast(LANG==="ja"?"削除に失敗":"Delete failed", 2200); }
});

/* エモ */
angerBtn.addEventListener("click", ()=>{
  me.emo="angry"; me.emoAt=Date.now(); ensureMineDom();
  safeUpdate({emo:"angry", emoAt:Date.now()});
  setTimeout(()=>{ if(Date.now()-me.emoAt>=EMO_SHOW_MS){ me.emo="none"; ensureMineDom(); } }, EMO_SHOW_MS+120);
});

/* ポーズ */
function renderPoseTopBtn(){ lblPose.textContent=" "+(me.pose==="stand"?I18N[LANG].poseSit:I18N[LANG].poseStand); } renderPoseTopBtn();
poseTopBtn.addEventListener("click", togglePose);
window.addEventListener("keydown", e=>{ const tag=(e.target&&e.target.tagName)?e.target.tagName.toLowerCase():""; if(tag==="input"||tag==="textarea"||(e.target&&e.target.isContentEditable)) return; if(e.key.toLowerCase()==="s"){ togglePose(); }});
function togglePose(){ me.pose=(me.pose==="stand")?"sit":"stand"; renderPoseTopBtn(); safeUpdate({pose:me.pose}); }

/* 退室 */
leaveBtn.addEventListener("click", async ()=>{
  if(!uid) return;
  if(!confirm(I18N[LANG].confirmLeave)) return;
  try{ await remove(myRef()); }catch(e){ console.warn("leave remove failed:", e); }
  mounted=false; joined=false;
  me.msg=""; me.pinMsg=""; me.emo="none";
  const mine=domMap.get(uid); if(mine){ mine.wrap.remove(); domMap.delete(uid); }
  nameInput.value=""; warn.textContent="";
  join.style.display="flex"; toast(I18N[LANG].left, 2000);
});

/* ===== ズーム/パン ===== */
function centerWorld(){
  const r=play.getBoundingClientRect();
  const {w,h}=worldSize();
  zoom=1;
  panX=(r.width-w*zoom)/2;
  panY=(r.height-h*zoom)/2;
}
function applyView(){ worldWrap.style.transform=`translate(${panX}px, ${panY}px) scale(${zoom})`; zoomLabel.textContent=`${Math.round(zoom*100)}%`; }
function setZoomCentered(nz){
  nz=Math.max(ZMIN,Math.min(ZMAX,nz));
  const r=play.getBoundingClientRect();
  const cx=r.width/2, cy=r.height/2;
  const worldX=(cx - panX)/zoom, worldY=(cy - panY)/zoom;
  zoom=nz;
  panX=cx - worldX*zoom;
  panY=cy - worldY*zoom;
  userPanned=true; applyView();
}
zoomInBtn.addEventListener("click", ()=> setZoomCentered(zoom*1.15));
zoomOutBtn.addEventListener("click", ()=> setZoomCentered(zoom/1.15));
play.addEventListener("wheel", e=>{
  e.preventDefault();
  const r=play.getBoundingClientRect();
  const cx=e.clientX - r.left, cy=e.clientY - r.top;
  const beforeX=(cx - panX)/zoom, beforeY=(cy - panY)/zoom;
  const k=Math.exp(-e.deltaY*0.0015);
  const nz=Math.max(ZMIN,Math.min(ZMAX,zoom*k));
  zoom=nz;
  panX=cx - beforeX*zoom;
  panY=cy - beforeY*zoom;
  userPanned=true; applyView();
},{passive:false});

/* ===== Pointer Events：スマホのパン/ピンチ ===== */
const pointers=new Map(); let panning=false, panStartX=0, panStartY=0, dragStartX=0, dragStartY=0, panningTouchId=null; let pinch=null;
function isTouchPointer(e){ return e.pointerType==="touch"; }
play.addEventListener("pointerdown", e=>{
  if(isTouchPointer(e)){
    pointers.set(e.pointerId,{x:e.clientX,y:e.clientY});
    if(pointers.size===1){
      panning=true; panningTouchId=e.pointerId;
      dragStartX=e.clientX; dragStartY=e.clientY; panStartX=panX; panStartY=panY;
    }else if(pointers.size===2){
      panning=false; panningTouchId=null;
      const ids=[...pointers.keys()]; const a=pointers.get(ids[0]); const b=pointers.get(ids[1]);
      const dx=a.x-b.x, dy=a.y-b.y;
      pinch={id1:ids[0],id2:ids[1],prevDist:Math.hypot(dx,dy),prevCx:(a.x+b.x)/2,prevCy:(a.y+b.y)/2};
    }
    try{ play.setPointerCapture(e.pointerId); }catch{}; return;
  }
  if(e.button!==0 && e.buttons!==1) return; if(pointers.size>0) return;
  panning=true; dragStartX=e.clientX; dragStartY=e.clientY; panStartX=panX; panStartY=panY; try{ play.setPointerCapture(e.pointerId); }catch{};
});
play.addEventListener("pointermove", e=>{
  if(isTouchPointer(e)){
    if(!pointers.has(e.pointerId)) return;
    pointers.get(e.pointerId).x=e.clientX;
    pointers.get(e.pointerId).y=e.clientY;

    if(pinch && pointers.has(pinch.id1) && pointers.has(pinch.id2)){
      const a=pointers.get(pinch.id1), b=pointers.get(pinch.id2);
      const cx=(a.x+b.x)/2, cy=(a.y+b.y)/2;
      const dx=a.x-b.x, dy=a.y-b.y;
      const dist=Math.hypot(dx,dy);
      const scale=dist/pinch.prevDist || 1;
      const nz=Math.max(ZMIN,Math.min(ZMAX,zoom*scale));

      const worldX=(cx - panX)/zoom, worldY=(cy - panY)/zoom;
      zoom=nz;
      panX=cx - worldX*zoom;
      panY=cy - worldY*zoom;

      panX += (cx - pinch.prevCx);
      panY += (cy - pinch.prevCy);

      pinch.prevDist=dist; pinch.prevCx=cx; pinch.prevCy=cy;

      userPanned=true; applyView();
      return;
    }

    if(panning && panningTouchId===e.pointerId){
      const dx=e.clientX-dragStartX, dy=e.clientY-dragStartY;
      panX=panStartX+dx; panY=panStartY+dy; userPanned=true; applyView();
    }
    return;
  }

  if(panning && pointers.size===0){
    const dx=e.clientX-dragStartX, dy=e.clientY-dragStartY;
    panX=panStartX+dx; panY=panStartY+dy; userPanned=true; applyView();
  }
});
function endPointer(e){
  if(isTouchPointer(e)){
    pointers.delete(e.pointerId);
    if(pinch && (e.pointerId===pinch.id1 || e.pointerId===pinch.id2)){ pinch=null; }
    if(panning && panningTouchId===e.pointerId){ panning=false; panningTouchId=null; }
    try{ play.releasePointerCapture(e.pointerId); }catch{}; return;
  }
  if(panning){ panning=false; try{ play.releasePointerCapture(e.pointerId); }catch{} }
}
play.addEventListener("pointerup", endPointer);
play.addEventListener("pointercancel", endPointer);

/* ダブルクリック/タップ移動 */
play.addEventListener("dblclick", e=>{
  e.preventDefault();
  const {x,y}=toNormFromClient(e.clientX, e.clientY);
  const pxNow=toPxLocal(me.x, me.y).x; const pxNext=toPxLocal(x, y).x;
  target.x=x; target.y=y; me.dir=(pxNext>=pxNow)?1:-1;
  safeUpdate({dir:me.dir});
});
let lastTapTime=0,lastTapX=0,lastTapY=0;
play.addEventListener("touchend", e=>{
  if(e.touches.length>0) return;
  const t=Date.now(); const touch=e.changedTouches[0];
  const x=touch.clientX, y=touch.clientY;
  const dt=t-lastTapTime, dist=Math.hypot(x-lastTapX, y-lastTapY);
  if(dt<300 && dist<24){
    const p=toNormFromClient(x,y);
    const pxNow=toPxLocal(me.x, me.y).x; const pxNext=toPxLocal(p.x, p.y).x;
    target=p; me.dir=(pxNext>=pxNow)?1:-1; safeUpdate({dir:me.dir});
    lastTapTime=0;
  }else{
    lastTapTime=t; lastTapX=x; lastTapY=y;
  }
},{passive:true});

/* リサイズ */
window.addEventListener("resize", ()=>{ if(!userPanned){ centerWorld(); applyView(); }});

/* ===== ループ ===== */
let loopStarted=false; let lastT=performance.now();
function startLoop(){ if(loopStarted) return; loopStarted=true; requestAnimationFrame(loop); }
function loop(){
  const t=performance.now(); const dt=Math.max(0, Math.min(0.05,(t-lastT)/1000)); lastT=t;
  const {w}=worldSize();
  const dxn=target.x - me.x, dyn=target.y - me.y;
  const distn=Math.hypot(dxn,dyn);
  const stepNorm=(SPEED_PX_PER_S * dt) / w;
  if(distn>stepNorm){ me.x += dxn/distn*stepNorm; me.y += dyn/distn*stepNorm; } else { me.x=target.x; me.y=target.y; }
  ensureMineDom();

  if(mounted && (t-lastSync)>=80){ safeUpdate({x:me.x,y:me.y}); lastSync=t; }
  if(mounted && (t-lastHeartbeat)>=HEARTBEAT_MS){
    const patch={ lastActive:Date.now() };
    if(Date.now()-lastNameAssert >= NAME_REASSERT_MS){ patch.name = normalizeName(me.name); lastNameAssert = Date.now(); }
    safeUpdate(patch);
    lastHeartbeat=t;
  }
  requestAnimationFrame(loop);
}

/* ===== 安全更新 ===== */
async function safeUpdate(patch){ if(!uid || !mounted) return; try{ await update(myRef(), patch); }catch(e){ console.error("[rtdb] update failed]", patch, e); } }

/* ===== 書き置き購読 ===== */
const notesDomMap=new Map();
function subscribeNotes(){
  onValue(notesRootRef(), snap=>{
    const nowMs=Date.now(); const seen=new Set(); hasOwnNote=false;
    snap.forEach(ch=>{
      const v=ch.val()||{}; const ts=Number(v.updatedAt||v.at||0);
      const alive=ts>0 && (nowMs-ts)<=NOTE_TTL_MS; const id=ch.key;
      if(alive){ upsertNoteDom(id,v); seen.add(id); if(id===uid) hasOwnNote=true; }
      else{ remove(noteRefOf(id)).catch(()=>{}); }
    });
    for(const [id,el] of notesDomMap){ if(!seen.has(id)){ el.remove(); notesDomMap.delete(id); } }
    noteClearBtn.disabled=!hasOwnNote;
  });
}
function upsertNoteDom(ownerUid,data){
  let el=notesDomMap.get(ownerUid);
  if(!el){ el=document.createElement("div"); el.className="noteItem"; world.appendChild(el); notesDomMap.set(ownerUid, el); }
  el.textContent=data.text||"";
  const {x,y}=toPxLocal(Number(data.x??0.5), Number(data.y??0.7));
  el.style.left=`${x}px`; el.style.top=`${y}px`;
  const wr=world.getBoundingClientRect();
  const screenY=wr.top + (Number(data.y??0.7))*wr.height;
  const visibleBottom=window.innerHeight - (bar.getBoundingClientRect().height||0);
  if(screenY<120) el.classList.add("flip"); else if(screenY>140) el.classList.remove("flip");
}

/* ===== 新部屋通知 ===== */
let NEXT_ROOM_ID=null; let migrateHideTimer=null;
function showLocalMigrate(nextRoomId, byName){
  NEXT_ROOM_ID=nextRoomId;
  const T=I18N[LANG];
  migrateText.textContent=`🆕 ${T.notify.newRoomBy(byName|| (LANG==="ja"?"だれか":"someone"))}`;
  migrate.style.display="flex";
  clearTimeout(migrateHideTimer);
  migrateHideTimer=setTimeout(()=>{ migrate.style.display="none"; }, MIGRATE_TTL_MS+50);
}
function subscribeMeta(){
  onValue(metaRef(), snap=>{
    const m=snap.val()||{};
    clearTimeout(migrateHideTimer);
    const at=Number(m.at||0);
    const fresh = m.nextRoom && at>0 && (Date.now() - at) <= MIGRATE_TTL_MS;
    if(fresh){
      const byName=(latestPlayers[m.by]?.name)?normalizeName(latestPlayers[m.by].name):"";
      showLocalMigrate(m.nextRoom, byName);
    }else{
      migrate.style.display="none";
    }
  });
}
newRoomBtn.addEventListener("click", async ()=>{
  const id=makeRoomId();
  try{
    await update(metaRef(), {nextRoom:id, by:uid||"", at:Date.now()});
    const byName = normalizeName(me.name) || (LANG==="ja"?"自分":"me");
    showLocalMigrate(id, byName);
  }catch(e){ console.error("set nextRoom failed:", e); toast(LANG==="ja"?"新しい部屋の作成に失敗":"Failed to create room", 2500); }
});
migrateGo.addEventListener("click", ()=>{
  if(!NEXT_ROOM_ID) return;
  const u=new URL(location.href);
  u.searchParams.set("room", NEXT_ROOM_ID);
  location.href=u.toString();
});
migrateClose.addEventListener("click", ()=>{ migrate.style.display="none"; });

/* 名簿・共有・ヘルプ */
function peekNames(){
  const list = Object.entries(latestPlayers).map(([id,p])=> id===uid ? normalizeName(me.name) : normalizeName(p.name||"")).filter(Boolean).join(" / ") || (LANG==="ja"?"いまは誰もいない":"no one");
  namesPeek.textContent=(LANG==="ja"?I18N.ja:I18N.en).namesPeek(list);
  namesPeek.style.display="block";
  clearTimeout(peekNames._t); peekNames._t=setTimeout(()=>namesPeek.style.display="none", 2500);
}
brandTitle.addEventListener("click", peekNames);
if(brandLogo) brandLogo.addEventListener("click", peekNames);

shareBtn.addEventListener("click", async ()=>{
  const invite=new URL(location.href);
  invite.searchParams.set("room", WORLD_ID);
  invite.hash=invite.hash.replace(/room=[^&]+&?/,'').replace(/[#&]$/,'');
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(invite.toString());
      toast((LANG==="ja"?I18N.ja:I18N.en).notify.urlCopied, 2600);
    }else{
      prompt(LANG==="ja"?"このURLをコピーして共有してね":"Copy this URL to invite", invite.toString());
    }
  }catch(e){ console.warn("clipboard failed:", e); }
});

helpBtn.addEventListener("click", ()=>{
  helpDialog.innerHTML=`<div style="padding:16px 16px 12px; max-width:560px">${helpHtml()}<div style="display:flex; gap:8px; justify-content:flex-end"><button id="helpClose" class="btn">OK</button></div></div>`;
  helpDialog.showModal();
  helpDialog.querySelector("#helpClose").addEventListener("click", ()=>helpDialog.close(), {once:true});
});

/* 起動 */
(function(){
  worldLabel.textContent=`room: ${WORLD_ID}`;
  renderMuteButton();
  msgInput.dispatchEvent(new Event("input"));
  centerWorld(); applyView();
  notify(I18N[LANG].hint, 90000);
  // 起動時スプラッシュ（名前入力前）：フェードアウト付き
  showSplashOnBoot();
})();
function renderMuteButton(){
  const T = I18N[LANG];
  soundIcon.textContent = muted ? "🔇" : "🔔";
  lblSound.textContent = " " + (muted ? T.soundMute : T.soundOn);
}
muteBtn.addEventListener("click", ()=>{
  muted=!muted;
  localStorage.setItem("yuru_mute", muted ? "1":"0");
  if(masterGain) masterGain.gain.value = muted ? 0 : 0.24;
  renderMuteButton();
});

</script>
</body>
</html>
