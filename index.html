<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<title>ã‚†ã‚‹ãƒã‚³ã²ã‚ã°</title>
<meta name="color-scheme" content="light only">

<!-- çŒ«ç”»åƒï¼ˆå·¦å‘ããŒæ­£ï¼‰ã‚’å…ˆèª­ã¿ -->
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png" as="image" crossorigin>
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_sitting.png"  as="image" crossorigin>

<style>
  :root{
    --bg:#fffdf9; --panel:#ffffff; --ink:#1a1a1a; --muted:#6b7280;
    --accent:#ff7aa2; --accent-ink:#fff; --border:#e5e7eb;
    --barH:60px; --ring:3px; --ringColor:rgba(255,122,162,.45);
    --pin-bg:#ffe7ef; --pin-bd:#ffc6d7;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%; margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Hiragino Kaku Gothic ProN",Meiryo,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--ink)}
  body,button,input{touch-action:manipulation}
  #app{position:fixed; inset:0; display:flex; flex-direction:column}

  /* ==== ä¸Šéƒ¨ãƒ˜ãƒƒãƒ€ï¼ˆ2æ®µã¾ã§è¨±å®¹ï¼‰ ==== */
  header{
    padding: calc(env(safe-area-inset-top) + 4px) 12px 8px;
    border-bottom:1px solid var(--border); background:var(--panel); position:relative; z-index:3;
  }
  header .row{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; row-gap:6px}
  .brand{display:flex; align-items:center; gap:10px; min-width:0; flex:1 1 260px}
  .brand .catBtn{width:28px; height:28px; border-radius:8px; display:grid; place-items:center; cursor:pointer; border:1px solid var(--border); background:#fff}
  .brand h1{font-size:clamp(14px, 2.6vw, 16px); font-weight:800; margin:0; white-space:nowrap}
  .chip{border:1px solid var(--border); background:#fafafa; border-radius:999px; padding:6px 10px; white-space:nowrap; max-width:50vw; overflow:hidden; text-overflow:ellipsis}
  .meta{display:flex; align-items:center; gap:8px; flex:0 0 auto}
  .btn{appearance:none; border:0; background:var(--accent); color:var(--accent-ink); border-radius:12px; padding:10px 12px; font-size:14px; font-weight:800; cursor:pointer; min-height:40px; display:inline-flex; align-items:center; gap:6px; white-space:nowrap; flex:0 0 auto}
  .btn.ghost{background:transparent; color:var(--ink); border:1px solid var(--border)}
  .btn.iconOnly{padding:10px; min-width:44px} /* â†ä¸‹éƒ¨ã®ã‚¢ã‚¤ã‚³ãƒ³å°‚ç”¨ãƒœã‚¿ãƒ³ */
  .btn:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  .icon{font-variant-emoji:emoji; font-size:16px}
  .txt{display:inline-block}
  @media (max-width:560px){
    .chip{max-width:60vw; font-size:12px}
    .btn.ghost .txt{display:none}
    .btn.ghost{padding:10px}
  }

  /* ==== ãƒ—ãƒ¬ã‚¤ã‚¨ãƒªã‚¢ ==== */
  #play{
    position:relative; flex:1; overflow:hidden; cursor:crosshair;
    background-image:
      radial-gradient(circle at 1px 1px, #f1f3f5 1px, transparent 0),
      radial-gradient(1200px 420px at 50% 120%, #f7f7f7 0%, transparent 60%);
    background-size:18px 18px, auto; background-position:0 0, 0 0;
    user-select:none; touch-action:none;
  }
  .ping{position:absolute; width:10px; height:10px; border-radius:999px; border:2px solid var(--accent); opacity:.7; pointer-events:none; transform:translate(-50%,-50%) scale(.2); animation:ping .8s ease-out forwards}
  @keyframes ping{80%{opacity:.15; transform:translate(-50%,-50%) scale(2.0)} 100%{opacity:0; transform:translate(-50%,-50%) scale(2.6)}}

  /* ==== æ›¸ãç½®ããƒ‘ãƒãƒ«ï¼ˆéƒ¨å±‹æ°¸ç¶šï¼‰ ==== */
  #notesPanel{
    position:absolute; left:8px; top:8px; z-index:2;
    display:flex; flex-direction:column; gap:6px; max-width:min(92vw, 360px); pointer-events:none;
  }
  .note{
    pointer-events:auto;
    background:var(--pin-bg); border:1px solid var(--pin-bd); border-radius:10px; padding:8px 10px;
    font-size:13px; color:#111; box-shadow:0 6px 18px rgba(0,0,0,.06);
    display:flex; flex-direction:column; gap:4px;
  }
  .note .by{font-size:12px; color:#444}
  .note .txt{white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600}

  /* ==== ä¸‹éƒ¨ãƒãƒ¼ï¼šå…¥åŠ›ã‚’æœ€å„ªå…ˆã§åºƒã ==== */
  #bar{
    height:var(--barH); display:flex; align-items:center; gap:8px;
    border-top:1px solid var(--border); background:var(--panel);
    padding:8px 10px; padding-bottom:calc(8px + env(safe-area-inset-bottom));
    flex-wrap:nowrap; white-space:nowrap; overflow:hidden;
  }
  #msgWrap{flex:1 1 auto; display:flex; align-items:center; gap:8px; min-width:0; overflow:hidden; white-space:nowrap}
  #msg{
    flex:1 1 auto; min-width:160px; font-size:16px; padding:8px 10px;
    border:1px solid var(--border); border-radius:12px; outline:none; background:#fff;
    height:38px; line-height:22px; white-space:nowrap;
  }
  #msg:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  #helper{flex:0 0 auto; display:flex; align-items:center; gap:8px; font-size:12px; color:#6b7280; max-width:34%; overflow:hidden; text-overflow:ellipsis; user-select:none}
  @media (max-width:980px){ #helper{display:none} }

  /* ==== ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ï¼ˆç”»åƒãƒ™ãƒ¼ã‚¹ï¼å·¦å‘ãåŸºæº–ï¼‰ ==== */
  .p{position:absolute; left:0; top:0; transform:translate3d(0,0,0) translate(-50%, -80%); will-change:transform; width:78px; height:78px}
  .catImg{width:78px; height:78px; display:block; object-fit:contain; image-rendering:auto; pointer-events:none; transition:transform .18s ease}
  .catImg.right{transform:scaleX(-1)}
  .catImg.sit{display:none}
  .sit .catImg.stand{display:none}
  .sit .catImg.sit{display:block}

  /* åæœ­ï¼ˆè‡ªå‹•ãƒ•ãƒªãƒƒãƒ—ï¼‹ãƒ’ã‚¹ãƒ†ãƒªã‚·ã‚¹ï¼‰ */
  .name{
    position:absolute; left:50%; top:78px; transform:translateX(-50%);
    background:rgba(17,17,17,.95); color:#fff; font-size:12px; padding:2px 8px; border-radius:999px; white-space:nowrap;
    max-width:180px; text-overflow:ellipsis; overflow:hidden; letter-spacing:.2px; border:1px solid rgba(0,0,0,.6);
    z-index:2; pointer-events:none; will-change:transform;
  }
  .name.flip{top:auto; bottom:84px}

  /* é€šå¸¸å¹ãå‡ºã—ï¼šæ¨ªä¸€è¡Œãƒ»60ç§’ */
  .bubble{
    position:absolute; left:50%; bottom:94px; transform:translateX(-50%);
    background:#fff; color:#111; border:1px solid var(--border); border-radius:12px; padding:8px 10px; font-size:14px;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:min(86vw, 520px);
    box-shadow:0 8px 22px rgba(0,0,0,.06); z-index:1; display:none; pointer-events:none;
  }
  /* ãƒ”ãƒ³å¹ãå‡ºã—ï¼šå¸¸æ™‚è¡¨ç¤ºï¼æ·¡ãƒ”ãƒ³ã‚¯ï¼2/3ã‚µã‚¤ã‚º */
  .bubble.pin{
    display:none;
    bottom:122px;
    background:var(--pin-bg);
    border-color:var(--pin-bd);
    font-size:0.66em;
    padding:6px 9px;
  }

  /* ä¸€æ™‚çš„ãªåå‰ä¸€è¦§ */
  #namesPeek{
    position:fixed; left:50%; top:calc(8px + env(safe-area-inset-top));
    transform:translateX(-50%); z-index:5; background:rgba(0,0,0,.8); color:#fff;
    font-size:13px; border-radius:12px; padding:8px 10px; max-width:90vw; white-space:normal; display:none;
  }

  #join{position:fixed; inset:0; background:rgba(255,255,255,.9); display:flex; align-items:center; justify-content:center; z-index:10}
  #join .card{width:min(92vw,520px); border:1px solid var(--border); border-radius:18px; background:#fff; padding:18px 16px 16px; box-shadow:0 18px 60px rgba(0,0,0,.08)}
  #join h2{margin:0 0 8px; font-size:18px}
  #join p{margin:0 0 12px; font-size:14px; color:#555; line-height:1.6}
  #join .row{display:flex; gap:10px}
  #join input{flex:1; font-size:18px; padding:12px 12px; border:1px solid var(--border); border-radius:12px; outline:none; background:#fff}
  #join input:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  #join button{padding:12px 14px; border-radius:12px; background:var(--accent); color:#fff; font-weight:800; font-size:16px; border:0; cursor:pointer; white-space:nowrap}
  #warn{color:#b40000; font-size:13px; min-height:1.4em}
  .subtle{font-size:12px; color:#6b7280}

  #hint{position:fixed; right:10px; bottom:calc(var(--barH) + 10px + env(safe-area-inset-bottom)); background:#000; color:#fff; font-size:12px; padding:8px 10px; border-radius:10px; opacity:.85; z-index:4}

  /* æº€å“¡ãƒ€ã‚¤ã‚¢ãƒ­ã‚° */
  #full{position:fixed; inset:0; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; z-index:20}
  #full .card{width:min(92vw,520px); border:1px solid var(--border); border-radius:18px; background:#fff; padding:18px 16px 16px; box-shadow:0 18px 60px rgba(0,0,0,.08)}
  #full .card h3{margin:0 0 8px}
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="row">
      <div class="brand">
        <div id="playersBtn" class="catBtn" role="button" tabindex="0" title="ã„ã¾ã®åå‰ä¸€è¦§ï¼ˆ2.5ç§’è¡¨ç¤ºï¼‰">ğŸ±</div>
        <h1>ã‚†ã‚‹ãƒã‚³ã²ã‚ã°</h1>
        <span class="chip" id="worldLabel" aria-live="polite"></span>
        <span class="chip" id="countLabel" aria-live="polite" title="ã„ã¾ã„ã‚‹ãƒã‚³ã®æ•°">ğŸ˜º 0</span>
      </div>
      <div class="meta">
        <button id="poseTopBtn" class="btn ghost" title="ç«‹ã¤/åº§ã‚‹ åˆ‡æ›¿"><span class="icon" aria-hidden="true">ğŸª‘</span><span class="txt"> åº§ã‚‹</span></button>
        <button id="muteBtn" class="btn ghost" title="éŸ³ã®ã‚ªãƒ³/ã‚ªãƒ•"><span class="icon" aria-hidden="true">ğŸ””</span><span class="txt"> éŸ³</span></button>
        <button id="shareBtn" class="btn ghost" title="URLã‚’ã‚³ãƒ”ãƒ¼"><span class="icon" aria-hidden="true">ğŸ”—</span><span class="txt"> å…±æœ‰</span></button>
        <button id="helpBtn" class="btn ghost" title="ä½¿ã„æ–¹"><span class="icon" aria-hidden="true">â”</span><span class="txt"> ãƒ˜ãƒ«ãƒ—</span></button>
      </div>
    </div>
  </header>

  <div id="play" aria-label="play-area">
    <!-- éƒ¨å±‹ã«æ®‹ã‚‹æ›¸ãç½®ã -->
    <div id="notesPanel" aria-live="polite"></div>
  </div>

  <!-- ä¸‹éƒ¨ãƒãƒ¼ï¼šã‚¢ã‚¤ã‚³ãƒ³3ã¤ï¼‹åºƒã„å…¥åŠ›æ¬„ -->
  <div id="bar">
    <div id="msgWrap">
      <input id="msg" type="text" inputmode="text" autocomplete="off" placeholder="çŸ­ã„ã“ã¨ã°â€¦ï¼ˆéè‹±èª15 / è‹±èª10èªï¼‰" aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›ï¼ˆ1è¡Œï¼‰">
      <div id="helper">
        <span id="hintLang">éè‹±èªï¼š0/15</span>
        <span aria-hidden="true">Enteré€ä¿¡ / Sã§åº§ã‚‹</span>
      </div>
    </div>
    <button id="pinBtn"  class="btn iconOnly" title="ãƒ”ãƒ³ç•™ã‚"><span class="icon" aria-hidden="true">ğŸ“Œ</span></button>
    <button id="noteBtn" class="btn iconOnly" title="éƒ¨å±‹ã«æ›¸ãç½®ã"><span class="icon" aria-hidden="true">ğŸ–‹ï¸</span></button>
    <button id="send"    class="btn iconOnly" disabled title="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡"><span class="icon" aria-hidden="true">ğŸ“¨</span></button>
  </div>

  <div id="hint" aria-live="polite">ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã§è‡ªåˆ†ã®çŒ«ãŒã‚†ã£ãã‚Šç§»å‹•</div>
</div>

<div id="namesPeek" aria-live="polite"></div>

<div id="join" role="dialog" aria-modal="true" aria-label="åå‰å…¥åŠ›">
  <div class="card">
    <h2>åå‰ã‚’å…¥ã‚Œã¦å‚åŠ </h2>
    <p>åå‰ã¯<strong>3æ–‡å­—ã¾ã§</strong>ã€‚åŒã˜URLã§åŒã˜éƒ¨å±‹ã€‚ã‚†ã£ãã‚ŠéŠã¶å ´æ‰€ã€‚</p>
    <div class="row">
      <input id="nameInput" maxlength="3" placeholder="ãŸã¨ãˆã°ã€ãƒ©ãƒ©ã€" aria-label="åå‰ï¼ˆ3æ–‡å­—ã¾ã§ï¼‰">
      <button id="enterBtn">ã¯ã˜ã‚ã‚‹</button>
    </div>
    <div id="warn" role="status" aria-live="polite"></div>
    <p class="subtle">éŸ³ãŒå‡ºãªã„å ´åˆã¯ç”»é¢ã‚’ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰ãƒŸãƒ¥ãƒ¼ãƒˆã‚’ç¢ºèªã€‚</p>
  </div>
</div>

<dialog id="helpDialog">
  <div style="padding:16px 16px 12px; max-width:560px">
    <h3 style="margin:0 0 8px">ä½¿ã„æ–¹</h3>
    <ul style="margin:0 0 12px 18px; line-height:1.7; color:#374151; font-size:14px">
      <li>ã‚¿ãƒƒãƒ—/ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ‰€ã¸ã‚†ã£ãã‚Šç§»å‹•ã™ã‚‹</li>
      <li>ä¸‹ã®å…¥åŠ›æ¬„ã¯æ¨ªä¸€è¡Œã€‚Enterã§é€ä¿¡</li>
      <li>è‹±èªã¯10èªã€éè‹±èªã¯15æ–‡å­—ã¾ã§</li>
      <li>åº§ã‚‹/ç«‹ã¤ã¯ä¸Šéƒ¨ã® <b>ğŸª‘</b> ã‹ <b>S</b> ã‚­ãƒ¼ï¼ˆå…¥åŠ›ä¸­ã¯ç„¡åŠ¹ï¼‰</li>
      <li><b>ğŸ“Œãƒ”ãƒ³</b>ã§è‡ªåˆ†ã®é ­ä¸Šã«å›ºå®šï¼ˆæ·¡ã„ãƒ”ãƒ³ã‚¯ãƒ»2/3ã‚µã‚¤ã‚ºï¼‰ï¼å†åº¦ã§è§£é™¤</li>
      <li><b>ğŸ–‹ï¸æ›¸ãç½®ã</b>ã§éƒ¨å±‹ã«æ®‹ã™ï¼ˆä½œè€…åä»˜ãã€å·¦ä¸Šã«ä¸€è¦§ï¼‰</li>
      <li>å·¦ä¸Šã® <b>ğŸ±</b> ã‚’æŠ¼ã™ã¨å‚åŠ è€…åã‚’2.5ç§’è¡¨ç¤º</li>
      <li>åŒã˜éƒ¨å±‹ã¯æœ€å¤§10äººã¾ã§</li>
    </ul>
    <div style="background:#f8fafc; border:1px solid #e5e7eb; padding:10px; border-radius:10px; font-size:13px; color:#374151; margin-bottom:12px">
      éŸ³ãŒå‡ºãªã„å ´åˆï¼šãƒšãƒ¼ã‚¸ã‚’ä¸€åº¦ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚µã‚¤ãƒˆè¨­å®šã§ã€ŒéŸ³å£°ã‚’è¨±å¯ã€ã€‚iOSã¯æœ¬ä½“ã®ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã‚¹ã‚¤ãƒƒãƒã‚‚ç¢ºèªã€‚
    </div>
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button id="helpClose" class="btn">OK</button>
    </div>
  </div>
</dialog>

<!-- æº€å“¡ãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
<div id="full">
  <div class="card">
    <h3>æº€å“¡ã ï¼ˆ10äººã¾ã§ï¼‰</h3>
    <p style="margin-top:0">ã“ã®éƒ¨å±‹ã¯ä¸Šé™ã«é”ã—ã¦ã„ã‚‹ã€‚æ–°ã—ã„éƒ¨å±‹ã‚’ä½œæˆã—ã¦å…¥å®¤ã™ã‚‹ã€‚</p>
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button id="newRoomBtn" class="btn">æ–°ã—ã„éƒ¨å±‹ã‚’ä½œã‚‹</button>
    </div>
  </div>
</div>

<script type="module">
/* ===== ç”»åƒURLï¼ˆå·¦å‘ãç”»åƒï¼‰ ===== */
const CAT_STAND_URL = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png";
const CAT_SIT_URL   = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_sitting.png";

/* ===== Firebase config ===== */
const firebaseConfig = {
  apiKey:"AIzaSyCUpt4XLfSSZLt0VhJon926--c-I2tRMkE",
  authDomain:"blackcat-67716.firebaseapp.com",
  databaseURL:"https://blackcat-67716-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"blackcat-67716",
  storageBucket:"blackcat-67716.appspot.com",
  messagingSenderId:"124690483795",
  appId:"1:124690483795:web:73b5b2ba28f4e4d503d4a6",
  measurementId:"G-R47HW00266"
};

/* ===== RoomID ===== */
const url = new URL(location.href);
const qp = url.searchParams.get("room");
const hp = (location.hash.match(/room=([^&]+)/)||[])[1];
function makeRoomId(){ const t=Date.now().toString(36).slice(-6); const r=crypto.getRandomValues(new Uint32Array(1))[0].toString(36).slice(-5); return `plaza-${t}-${r}`; }
function setURLRoom(id){ const u=new URL(location.href); u.searchParams.set("room",id); u.hash=u.hash.replace(/room=[^&]+&?/,'').replace(/[#&]$/,''); history.replaceState({}, "", u.toString()); }
let WORLD_ID = qp || hp || null; if(!WORLD_ID){ WORLD_ID = makeRoomId(); setURLRoom(WORLD_ID); }

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set, update, serverTimestamp, onDisconnect, get, push }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* DOM */
const play = document.getElementById("play");
const notesPanel = document.getElementById("notesPanel");
const bar = document.getElementById("bar");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const pinBtn = document.getElementById("pinBtn");
const noteBtn = document.getElementById("noteBtn");
const poseTopBtn = document.getElementById("poseTopBtn");
const join = document.getElementById("join");
const nameInput = document.getElementById("nameInput");
const enterBtn = document.getElementById("enterBtn");
const warn = document.getElementById("warn");
const worldLabel = document.getElementById("worldLabel");
const countLabel = document.getElementById("countLabel");
const shareBtn = document.getElementById("shareBtn");
const helpBtn = document.getElementById("helpBtn");
const helpDialog = document.getElementById("helpDialog");
const helpClose = document.getElementById("helpClose");
const hintLang = document.getElementById("hintLang");
const muteBtn = document.getElementById("muteBtn");
const playersBtn = document.getElementById("playersBtn");
const namesPeek = document.getElementById("namesPeek");
const full = document.getElementById("full");
const newRoomBtn = document.getElementById("newRoomBtn");

worldLabel.textContent = `room: ${WORLD_ID}`;

/* ===== ã‚µã‚¦ãƒ³ãƒ‰ ===== */
let AC=null, masterGain=null; let muted=localStorage.getItem("yuru_mute")==="1";
function unlockAudio(){ if(!AC){ const Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) return; AC=new Ctx(); masterGain=AC.createGain(); masterGain.gain.value=muted?0:0.24; masterGain.connect(AC.destination); } if(AC&&AC.state==="suspended") AC.resume(); }
function setupAudioUnlock(){ const once=()=>{unlockAudio(); document.removeEventListener("pointerdown", once); document.removeEventListener("keydown", once); }; document.addEventListener("pointerdown", once, {passive:true}); document.addEventListener("keydown", once); enterBtn.addEventListener("click", unlockAudio, {once:true}); } setupAudioUnlock();
function tone({freq=880,dur=0.12,type="sine",vol=0.7,attack=0.005,release=0.12}={}){ if(!AC) return; const osc=AC.createOscillator(); const g=AC.createGain(); osc.type=type; osc.frequency.value=freq; osc.connect(g); g.connect(masterGain||AC.destination); const t=AC.currentTime; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+attack); g.gain.exponentialRampToValueAtTime(0.0001,t+attack+release); osc.start(t); osc.stop(t+dur+0.25); }
function playLogin(){ if(!muted && AC){ tone({freq:880,type:"triangle",vol:0.55,dur:0.12}); setTimeout(()=>tone({freq:1320,type:"triangle",vol:0.55,dur:0.12}),140); } }
function playMessage(){ if(!muted && AC){ tone({freq:700,type:"sine",vol:0.5,dur:0.09}); } }
function renderMuteButton(){ muteBtn.innerHTML = `<span class="icon" aria-hidden="true">${muted ? "ğŸ”‡" : "ğŸ””"}</span><span class="txt"> ${muted ? "ãƒŸãƒ¥ãƒ¼ãƒˆ" : "éŸ³ã‚ªãƒ³"}</span>`; }
muteBtn.addEventListener("click", ()=>{ muted=!muted; if(masterGain) masterGain.gain.value=muted?0:0.24; localStorage.setItem("yuru_mute", muted?"1":"0"); renderMuteButton(); });
renderMuteButton();

/* ===== çŠ¶æ…‹ ===== */
let uid=null;
let me={ name:"", x:0.5, y:0.7, dir:1, pose:"stand", msg:"", msgAt:0, pinMsg:"" };
let target={x:me.x,y:me.y};
let lastSync=0, lastHeartbeat=0; let SPEED_PX_PER_S=120;
const SYNC_INTERVAL_MS=80, HEARTBEAT_MS=15000;
const BUBBLE_MS=60000;
const NON_ASCII_LIMIT=15;
const ROOM_CAP = 10;

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const now = ()=>performance.now();
const clamp01 = v=>Math.max(0,Math.min(1,v));
const isASCIIish = s=>/^[\x00-\x7F]+$/.test(s);
const countWordsASCII = s=>s.trim().split(/\s+/).filter(Boolean).length;
function getPlayRect(){ const r=play.getBoundingClientRect(); if(r.width<=0||r.height<=0) return null; return r; }
function toNorm(cx,cy){ const r=getPlayRect(); if(!r) return {x:target.x,y:target.y}; return {x:clamp01((cx-r.left)/r.width), y:clamp01((cy-r.top)/r.height)}; }
function toPx(nx,ny){ const r=getPlayRect(); if(!r) return {x:0,y:0}; return {x:nx*r.width, y:ny*r.height}; }
function pingAt(nx,ny){ const r=getPlayRect(); if(!r) return; const {x,y}=toPx(nx,ny); const s=document.createElement("span"); s.className="ping"; s.style.left=`${x}px`; s.style.top=`${y}px`; play.appendChild(s); s.addEventListener("animationend",()=>s.remove()); }
function roundPx(v){ return Math.round(v); }
function toast(text){ const el=document.getElementById("hint"); el.textContent=text; el.style.opacity=.95; clearTimeout(toast._t); toast._t=setTimeout(()=> el.style.opacity=.85, 1500); }

/* ===== Refs ===== */
function playersRefOf(room){ return ref(db, `worlds/${room}/players`); }
function myRef(){ return ref(db, `worlds/${WORLD_ID}/players/${uid}`); }
function notesRef(){ return ref(db, `worlds/${WORLD_ID}/notes`); }
const playersRef = playersRefOf(WORLD_ID);

/* ===== å‚åŠ  ===== */
const remembered=localStorage.getItem("yuru_name"); if(remembered) nameInput.value=remembered.slice(0,3);
nameInput.addEventListener("input", ()=>{ const n=nameInput.value.trim(); if([...n].length>3) nameInput.value=Array.from(n).slice(0,3).join(""); });
enterBtn.addEventListener("click", startJoin);
nameInput.addEventListener("keydown", e=>{ if(e.key==="Enter") startJoin(); });
async function startJoin(){
  const n=nameInput.value.trim();
  if([...n].length===0){ warn.textContent="1ã€œ3æ–‡å­—"; return; }
  if([...n].length>3){ warn.textContent="3æ–‡å­—ã¾ã§"; return; }
  me.name=n; me.pose="stand"; me.pinMsg="";
  join.style.display="none";
  localStorage.setItem("yuru_name", me.name);
  await initAuth();
}
async function initAuth(){ try{ await signInAnonymously(auth); }catch(e){ alert("åŒ¿åèªè¨¼ã«å¤±æ•—ã€‚Authenticationè¨­å®šã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã€‚"); console.error("[auth] signIn failed:", e); } }

onAuthStateChanged(auth, async user=>{
  if(!user) return;
  uid=user.uid;
  me.x=Math.random()*0.8+0.1; me.y=Math.random()*0.4+0.5; target={x:me.x,y:me.y};
  me.pose="stand"; me.pinMsg="";
  const ok = await ensureCapacity();
  if(!ok){ showFull(); return; }
  ensureMineDom();
  await mountPresence(true);
  startLoop();
  subscribePlayers();
  subscribeNotes();
});

/* ===== ä¸Šé™ãƒã‚§ãƒƒã‚¯ ===== */
async function ensureCapacity(){
  try{
    const snap = await get(playersRef);
    const n = snap.exists() ? snap.numChildren() : 0;
    return n < ROOM_CAP;
  }catch(e){
    console.warn("capacity check failed:", e);
    return true;
  }
}
function showFull(){
  full.style.display = "flex";
  newRoomBtn.onclick = ()=>{
    const nid = makeRoomId();
    setURLRoom(nid);
    location.reload();
  };
}

/* ===== ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ ===== */
async function mountPresence(forceStand=false){
  try{
    await set(myRef(), {
      name: me.name, x: me.x, y: me.y, dir: me.dir,
      pose: forceStand ? "stand" : me.pose,
      msg: "", msgAt: 0, pinMsg: "", pinAt: 0,
      lastActive: serverTimestamp()
    });
  }catch(e){ console.error("[rtdb] initial set failed:", e); }
  try{ onDisconnect(myRef()).remove(); }catch(e){ console.warn("[rtdb] onDisconnect set failed:", e); }
}

/* ===== è³¼èª­ ===== */
const domMap=new Map();
let initialPlayersLoaded=false;
let latestPlayers = {};
function subscribePlayers(){
  onValue(playersRef, snap=>{
    const data=snap.val()||{};
    latestPlayers = data;
    const ids=Object.keys(data);
    countLabel.textContent=`ğŸ˜º ${ids.length}`;

    if(initialPlayersLoaded){
      for(const id of ids){
        if(!domMap.has(id) && id!==uid){
          playLogin();
          const n=(data[id] && data[id].name) ? data[id].name : "ãªãªã—";
          toast(`${n} ãŒå…¥å®¤ã—ãŸ`);
        }
      }
    }

    const seen=new Set(ids);
    for(const id of ids){
      let pdom=domMap.get(id);
      if(!pdom){ pdom=createPlayerDom(id); domMap.set(id,pdom); play.appendChild(pdom.wrap); }
      renderPlayer(pdom, data[id], id===uid);
    }
    for(const [id,pdom] of domMap){ if(!seen.has(id)){ pdom.wrap.remove(); domMap.delete(id); } }

    initialPlayersLoaded=true;
  });
}

/* ===== æ›¸ãç½®ãè³¼èª­ ===== */
function subscribeNotes(){
  onValue(notesRef(), snap=>{
    const list = [];
    snap.forEach(child=>{
      const v = child.val();
      if(v && v.text) list.push({id:child.key, ...v});
    });
    list.sort((a,b)=>(a.at||0)-(b.at||0));
    renderNotes(list);
  });
}
function renderNotes(list){
  notesPanel.innerHTML = "";
  for(const n of list){
    const el = document.createElement("div");
    el.className = "note";
    const who = document.createElement("div");
    who.className = "by";
    who.textContent = (n.author || "ãªãªã—") + " ã®æ›¸ãç½®ã";
    const txt = document.createElement("div");
    txt.className = "txt";
    txt.textContent = n.text;
    el.appendChild(who); el.appendChild(txt);
    notesPanel.appendChild(el);
  }
}

/* ===== ç”»åƒçŒ«DOM ===== */
function createPlayerDom(id){
  const wrap=document.createElement("div"); wrap.className="p stand";
  const nameEl=document.createElement("div"); nameEl.className="name";
  const bubble=document.createElement("div"); bubble.className="bubble";
  const pinBubble=document.createElement("div"); pinBubble.className="bubble pin";
  const standImg=new Image(); standImg.src=CAT_STAND_URL; standImg.alt="cat standing"; standImg.decoding="async"; standImg.className="catImg stand";
  const sitImg  =new Image(); sitImg.src  =CAT_SIT_URL;   sitImg.alt  ="cat sitting";  sitImg.decoding="async";  sitImg.className="catImg sit";
  wrap.appendChild(nameEl); wrap.appendChild(pinBubble); wrap.appendChild(bubble); wrap.appendChild(standImg); wrap.appendChild(sitImg);
  return {wrap, nameEl, bubbleEl:bubble, pinBubbleEl:pinBubble, standImg, sitImg, _lastShownMsgAt:0, _flip:false};
}

/* ===== æç”» ===== */
function renderPlayer(pdom, data, isSelf){
  const r=getPlayRect(); if(!r) return;
  const px=roundPx(data.x*r.width), py=roundPx(data.y*r.height);
  pdom.wrap.style.transform=`translate3d(${px}px, ${py}px, 0) translate(-50%, -80%)`;
  if(data.pose==="sit"){ pdom.wrap.classList.add("sit"); pdom.wrap.classList.remove("stand"); }
  else{ pdom.wrap.classList.add("stand"); pdom.wrap.classList.remove("sit"); }
  const right=(data.dir===1); pdom.standImg.classList.toggle("right", right); pdom.sitImg.classList.toggle("right", right);
  pdom.nameEl.textContent = data.name || "";
  const barH = bar.getBoundingClientRect().height || 0;
  const visibleBottom = r.height - barH;
  const wantFlip = (py + 90 > visibleBottom - 8);
  if(!pdom._flip && wantFlip){ pdom.nameEl.classList.add("flip"); pdom._flip=true; }
  else if(pdom._flip && (py + 90 < visibleBottom - 24)){ pdom.nameEl.classList.remove("flip"); pdom._flip=false; }

  const raw=data.msg || ""; const msgAt=Number(data.msgAt || 0);
  if(raw && msgAt>0){
    const REPLAY_GUARD_MS=4000; const nowAbs=Date.now(); const isReplaySelf=isSelf && (msgAt - pdom._lastShownMsgAt < REPLAY_GUARD_MS);
    if(msgAt > pdom._lastShownMsgAt && !isReplaySelf){
      pdom.bubbleEl.textContent=raw; pdom.bubbleEl.style.display="block";
      clearTimeout(pdom._bubbleTimer);
      const age=Math.max(0, nowAbs - msgAt); const remain=Math.max(1200, BUBBLE_MS - age);
      pdom._bubbleTimer=setTimeout(()=>{ pdom.bubbleEl.style.display="none"; }, remain);
      pdom._lastShownMsgAt=msgAt; if(!isSelf) playMessage();
    }
  }else{ pdom.bubbleEl.style.display="none"; }

  const pinText=data.pinMsg || "";
  pdom.pinBubbleEl.style.display = pinText ? "block" : "none";
  if(pinText) pdom.pinBubbleEl.textContent = pinText;
}

/* ===== è‡ªåˆ†DOMä¿è¨¼ ===== */
function ensureMineDom(){ if(!uid) return; if(!domMap.get(uid)){ const d=createPlayerDom(uid); domMap.set(uid,d); play.appendChild(d.wrap); } renderPlayer(domMap.get(uid), me, true); }

/* ===== å…¥åŠ›UI ===== */
let lastSentAt=0;
msgInput.addEventListener("input", ()=>{
  const v=msgInput.value;
  if(isASCIIish(v)){ const w=countWordsASCII(v); hintLang.textContent=`è‹±èªï¼š${Math.min(w,10)}/10`; }
  else{ const len=Array.from(v).length; hintLang.textContent=`éè‹±èªï¼š${Math.min(len,NON_ASCII_LIMIT)}/${NON_ASCII_LIMIT}`; }
  sendBtn.disabled=!validateMessage(v).ok;
});
sendBtn.addEventListener("click", sendMsg);
msgInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMsg(); }});
function validateMessage(raw){ if(!raw) return {ok:false}; if(isASCIIish(raw)){ if(countWordsASCII(raw)>10 || raw.length>100) return {ok:false}; } else{ if(Array.from(raw).length>NON_ASCII_LIMIT) return {ok:false}; } return {ok:true}; }

/* ===== ãƒ”ãƒ³ç•™ã‚ï¼ˆé ­ä¸Šï¼‰ ===== */
function renderPinBtn(){ const pressed=!!me.pinMsg; pinBtn.setAttribute("aria-pressed", pressed?"true":"false"); }
renderPinBtn();
pinBtn.addEventListener("click", ()=>{
  if(me.pinMsg){ me.pinMsg=""; renderPinBtn(); safeUpdate({pinMsg:"", pinAt:0}); const mine=domMap.get(uid); if(mine){ mine.pinBubbleEl.style.display="none"; } return; }
  const typed=msgInput.value.trim(); const pick=typed?typed:(me.msg?me.msg:"");
  if(!pick){ toast("ãƒ”ãƒ³ç•™ã‚ã™ã‚‹æ–‡ãŒãªã„"); return; }
  if(typed && !validateMessage(typed).ok){ toast("æ–‡å­—æ•°åˆ¶é™ã‚’è¶…ãˆã¦ã„ã‚‹"); return; }
  me.pinMsg=pick; renderPinBtn(); const mine=domMap.get(uid); if(mine){ mine.pinBubbleEl.textContent=pick; mine.pinBubbleEl.style.display="block"; }
  safeUpdate({pinMsg: pick, pinAt: serverTimestamp()});
});

/* ===== æ›¸ãç½®ãï¼ˆéƒ¨å±‹ã«æ°¸ç¶šï¼‰ ===== */
noteBtn.addEventListener("click", async ()=>{
  const typed = msgInput.value.trim();
  const pick = typed ? typed : (me.msg ? me.msg : "");
  if(!pick){ toast("æ›¸ãç½®ãã™ã‚‹æ–‡ãŒãªã„"); return; }
  if(typed && !validateMessage(typed).ok){ toast("æ–‡å­—æ•°åˆ¶é™ã‚’è¶…ãˆã¦ã„ã‚‹"); return; }
  try{
    await push(notesRef(), { text: pick, author: me.name || "ãªãªã—", uid: uid || "", at: serverTimestamp() });
    toast("æ›¸ãç½®ãã‚’æ®‹ã—ãŸ");
  }catch(e){
    console.error("note push failed:", e);
    const msg = (e && (e.code || e.message || e.name)) ? String(e.code || e.message || e.name) : "unknown";
    // ã‚ˆãã‚ã‚‹ï¼šPERMISSION_DENIEDï¼ˆãƒ«ãƒ¼ãƒ«ä¸è¨±å¯ï¼‰ï¼ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä¸€æ™‚éšœå®³
    toast(`æ›¸ãç½®ãã«å¤±æ•—: ${msg}`);
  }
});

/* ===== ãƒãƒ¼ã‚ºï¼ˆä¸Šéƒ¨ğŸª‘ & Sã‚­ãƒ¼ã€‚å…¥åŠ›ä¸­ã¯Sç„¡åŠ¹ï¼‰ ===== */
function renderPoseTopBtn(){ poseTopBtn.innerHTML=`<span class="icon" aria-hidden="true">ğŸª‘</span><span class="txt"> ${me.pose==="stand"?"åº§ã‚‹":"ç«‹ã¤"}</span>`; poseTopBtn.setAttribute("aria-pressed", me.pose==="sit"?"true":"false"); }
renderPoseTopBtn();
poseTopBtn.addEventListener("click", togglePose);
window.addEventListener("keydown", e=>{
  const tag=(e.target && e.target.tagName)?e.target.tagName.toLowerCase():"";
  const editable = tag==="input" || tag==="textarea" || (e.target && e.target.isContentEditable);
  if(editable) return;
  if(e.key.toLowerCase()==="s"){ togglePose(); }
});
function togglePose(){ me.pose=(me.pose==="stand")?"sit":"stand"; renderPoseTopBtn(); safeUpdate({pose:me.pose}); }

/* ===== ã‚¿ãƒƒãƒ—ç§»å‹•ãƒ»å‘ãåˆ¤å®š ===== */
function setTargetFromEvent(e){
  const pt=(e.touches && e.touches[0]) ? e.touches[0] : e;
  const {x,y}=toNorm(pt.clientX, pt.clientY);
  const pxNow=toPx(me.x, me.y).x; const pxNext=toPx(x, y).x;
  target.x=x; target.y=y; me.dir=(pxNext>=pxNow)?1:-1;
  safeUpdate({dir:me.dir}); pingAt(x,y);
}
play.addEventListener("pointerdown", setTargetFromEvent);
play.addEventListener("touchstart", setTargetFromEvent, {passive:true});
play.addEventListener("dblclick", e=>{ e.preventDefault(); }, {passive:false});

/* ===== ãƒ«ãƒ¼ãƒ— ===== */
let loopStarted=false; let lastT=now();
function startLoop(){ if(loopStarted) return; loopStarted=true; requestAnimationFrame(loop); }
function loop(){
  const t=now(); const dt=Math.max(0, Math.min(0.05,(t-lastT)/1000)); lastT=t;
  const r=getPlayRect(); if(!r){ requestAnimationFrame(loop); return; }
  const pxPos=toPx(me.x,me.y), pxTarget=toPx(target.x,target.y);
  const dx=pxTarget.x-pxPos.x, dy=pxTarget.y-pxPos.y, dist=Math.hypot(dx,dy);
  const step=SPEED_PX_PER_S*dt;
  if(dist>1){ const nx=pxPos.x+(dx/dist)*step, ny=pxPos.y+(dy/dist)*step; const nn=toNorm(nx+r.left, ny+r.top); me.x=nn.x; me.y=nn.y; }
  else{ me.x=target.x; me.y=target.y; }
  ensureMineDom();
  const tt=performance.now();
  if((tt-lastSync)>=SYNC_INTERVAL_MS){ safeUpdate({x:me.x,y:me.y}); lastSync=tt; }
  if((tt-lastHeartbeat)>=HEARTBEAT_MS){ safeUpdate({lastActive: serverTimestamp()}); lastHeartbeat=tt; }
  requestAnimationFrame(loop);
}

/* ===== æ›¸ãè¾¼ã¿ ===== */
async function safeUpdate(patch){ if(!uid) return; try{ await update(myRef(), patch); }catch(e){ console.error("[rtdb] update failed:", patch, e); } }

/* ===== é€ä¿¡ ===== */
function sendMsg(){
  const raw=msgInput.value.trim(); if(!validateMessage(raw).ok) return;
  const nowMs=Date.now(); if(nowMs-lastSentAt<500) return; lastSentAt=nowMs;
  me.msg=raw; me.msgAt=nowMs; ensureMineDom();
  const mine=domMap.get(uid); if(mine){ mine._lastShownMsgAt = nowMs; }
  msgInput.value=""; sendBtn.disabled=true;
  safeUpdate({ msg: raw, msgAt: serverTimestamp() });
}

/* ===== åç°¿ï¼ˆ2.5ç§’è¡¨ç¤ºï¼‰ ===== */
function peekNames(){
  let names = Object.values(latestPlayers).map(p=>p && p.name ? p.name : null).filter(Boolean);
  if(names.length===0 && (me.name || uid)){ names = [me.name || "ãªãªã—"]; } // â†1äººã®ã¨ãã¯è‡ªåˆ†ã ã‘
  namesPeek.textContent = names.length ? `ã„ã¾ã®å‚åŠ è€…ï¼š${names.join(" / ")}` : "ã„ã¾ã¯èª°ã‚‚ã„ãªã„";
  namesPeek.style.display = "block";
  clearTimeout(peekNames._t); peekNames._t = setTimeout(()=> namesPeek.style.display="none", 2500);
}
["click","keydown"].forEach(ev=>{
  playersBtn.addEventListener(ev, e=>{
    if(ev==="keydown" && e.key!=="Enter" && e.key!==" ") return;
    peekNames();
  });
});

/* ===== å…±æœ‰ãƒ»ãƒ˜ãƒ«ãƒ— ===== */
shareBtn.addEventListener("click", async ()=>{
  const invite=new URL(location.href);
  invite.searchParams.set("room", WORLD_ID);
  invite.hash=invite.hash.replace(/room=[^&]+&?/,'').replace(/[#&]$/,'');
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(invite.toString()); toast("URLã‚’ã‚³ãƒ”ãƒ¼ã—ãŸï¼ˆåŒã˜éƒ¨å±‹ã«å…¥ã‚Œã‚‹ï¼‰"); }
    else{ prompt("ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ã­", invite.toString()); }
  }catch(e){ console.warn("clipboard failed:", e); }
});
helpBtn.addEventListener("click", ()=>helpDialog.showModal());
helpClose.addEventListener("click", ()=>helpDialog.close());

/* ===== ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ ===== */
window.addEventListener("online",  ()=> toast("ã‚ªãƒ³ãƒ©ã‚¤ãƒ³"));
window.addEventListener("offline", ()=> toast("ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼šå†æ¥ç¶šå¾…ã¡"));

/* ===== èµ·å‹•å‰ãƒã‚§ãƒƒã‚¯ ===== */
(function(){ const needs=["apiKey","authDomain","databaseURL","projectId","appId"]; if(needs.some(k=>!firebaseConfig[k])) toast("Firebaseã®configã‚’å…¥ã‚Œã¦ã‹ã‚‰ä½¿ã†"); worldLabel.textContent=`room: ${WORLD_ID}`; })();
msgInput.dispatchEvent(new Event("input"));
startLoop();
</script>
</body>
</html>
