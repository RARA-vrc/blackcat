<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no">
<title>ゆるネコひろば</title>
<meta name="color-scheme" content="light only">
<style>
  :root{
    --bg: #fffdf9;
    --panel: #ffffff;
    --ink: #1a1a1a;
    --muted: #6b7280;
    --accent: #ff7aa2;
    --accent-ink:#fff;
    --barH: 74px;
    --ring: 3px;
    --ringColor: rgba(255,122,162,.45);
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
  html,body{height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, Segoe UI, Roboto, sans-serif; background:var(--bg); color:var(--ink)}
  #app{position:fixed; inset:0; display:flex; flex-direction:column}

  header{
    height:56px; display:flex; align-items:center; justify-content:space-between;
    gap:8px; padding:0 12px; border-bottom:1px solid #eee; background:var(--panel);
    position:relative; z-index:2;
  }
  .brand{display:flex; align-items:center; gap:10px}
  .brand .dot{width:14px; height:14px; border-radius:50%; background:#000}
  .brand h1{font-size:16px; font-weight:800; margin:0}
  .meta{display:flex; align-items:center; gap:10px; color:var(--muted); font-size:12px}
  .chip{border:1px solid #eee; background:#fafafa; border-radius:999px; padding:6px 10px}
  .btn{
    appearance:none; border:0; background:var(--accent); color:var(--accent-ink);
    border-radius:12px; padding:10px 12px; font-size:13px; font-weight:800; cursor:pointer;
  }
  .btn:focus-visible{outline: var(--ring) solid var(--ringColor); outline-offset: 2px}
  .ghost{ background:transparent; color:var(--ink); border:1px solid #e5e7eb; }
  .icon{font-variant-emoji: emoji; font-size:16px}

  #play{
    position:relative; flex:1; overflow:hidden; touch-action:none; cursor:crosshair;
    background-image:
      radial-gradient(circle at 1px 1px, #f1f3f5 1px, transparent 0),
      radial-gradient(1200px 420px at 50% 120%, #f7f7f7 0%, transparent 60%);
    background-size: 18px 18px, auto;
    background-position: 0 0, 0 0;
  }

  .ping{
    position:absolute; width:10px; height:10px; border-radius:999px;
    border:2px solid var(--accent); opacity:.7; pointer-events:none;
    transform:translate(-50%,-50%) scale(.2); animation:ping .8s ease-out forwards;
  }
  @keyframes ping{
    80%{ opacity:.15; transform:translate(-50%,-50%) scale(2.0); }
    100%{ opacity:0; transform:translate(-50%,-50%) scale(2.6); }
  }

  #bar{
    height:var(--barH); display:flex; align-items:center; gap:8px; padding:8px 10px;
    border-top:1px solid #eee; background:var(--panel);
    padding-bottom: calc(8px + env(safe-area-inset-bottom));
  }
  #poseBtn{min-width:74px}
  #msgWrap{flex:1; display:flex; flex-direction:column; gap:6px}
  #msg{
    width:100%; font-size:16px; padding:12px 12px; border:1px solid #e5e7eb; border-radius:12px; outline:none; background:#fff;
  }
  #msg:focus-visible{outline: var(--ring) solid var(--ringColor); outline-offset: 2px}
  #helper{display:flex; align-items:center; justify-content:space-between; font-size:12px; color:var(--muted); padding:0 4px}
  #send{min-width:74px}
  #send:disabled{opacity:.5; cursor:not-allowed}

  .p{position:absolute; width:78px; height:78px; transform:translate(-50%, -80%); transition: left .25s ease, top .25s ease}
  .p.self .name{background: var(--accent)}
  .name{
    position:absolute; left:50%; top:78px; transform:translateX(-50%);
    background:#111; color:#fff; font-size:12px; padding:2px 8px; border-radius:999px; white-space:nowrap;
    max-width:160px; text-overflow:ellipsis; overflow:hidden; letter-spacing:.2px;
  }
  .bubble{
    position:absolute; left:50%; bottom:94px; transform:translateX(-50%);
    background:#fff; color:#111; border:1px solid #e5e7eb; border-radius:14px; padding:9px 11px; font-size:14px; max-width:240px;
    box-shadow:0 10px 26px rgba(0,0,0,.06);
  }
  .bubble::after{
    content:""; position:absolute; left:50%; bottom:-7px; transform:translateX(-50%) rotate(45deg);
    width:14px; height:14px; background:#fff; border-left:1px solid #e5e7eb; border-bottom:1px solid #e5e7eb;
  }

  .cat{width:78px; height:78px; display:block}
  .stand .cat{transition:transform .18s ease}
  .sit .cat{transition:transform .18s ease; opacity:.96}
  .face-left{transform:scaleX(-1)}
  @keyframes wag { 0%,100%{ transform: rotate(0deg) } 50%{ transform: rotate(-6deg) } }
  .wag { transform-origin: 24px 60px; animation: wag 1.2s ease-in-out infinite }

  #join{
    position:fixed; inset:0; background:rgba(255,255,255,.9); display:flex; align-items:center; justify-content:center; z-index:10;
  }
  #join .card{
    width:min(92vw, 520px); border:1px solid #eee; border-radius:18px; background:#fff; padding:18px 16px 16px;
    box-shadow:0 18px 60px rgba(0,0,0,.08);
  }
  #join h2{margin:0 0 8px; font-size:18px}
  #join p{margin:0 0 12px; font-size:14px; color:#555; line-height:1.6}
  #join .row{display:flex; gap:10px}
  #join input{
    flex:1; font-size:18px; padding:12px 12px; border:1px solid #e5e7eb; border-radius:12px; outline:none; background:#fff;
  }
  #join input:focus-visible{outline: var(--ring) solid var(--ringColor); outline-offset: 2px}
  #join button{
    padding:12px 14px; border-radius:12px; background:var(--accent); color:#fff; font-weight:800; font-size:16px; border:0; cursor:pointer; white-space:nowrap;
  }
  #warn{color:#b40000; font-size:13px; min-height:1.4em}
  .subtle{font-size:12px; color:var(--muted)}

  #hint{
    position:fixed; right:10px; bottom:calc(var(--barH) + 10px + env(safe-area-inset-bottom));
    background:#000; color:#fff; font-size:12px; padding:8px 10px; border-radius:10px; opacity:.75; z-index:1;
  }

  @media (max-width:480px){
    .p{width:70px; height:70px}
    .cat{width:70px; height:70px}
    .bubble{font-size:13px; bottom:86px}
    .name{top:70px}
  }
  @media (prefers-reduced-motion: reduce){
    .p{transition:none}
    .cat, .sit .cat, .stand .cat{transition:none}
    .wag{animation:none}
    .ping{animation:none; display:none}
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="brand">
      <div class="dot" aria-hidden="true"></div>
      <h1>ゆるネコひろば</h1>
      <span class="chip" id="worldLabel" aria-live="polite"></span>
      <span class="chip" id="countLabel" aria-live="polite" title="いまいるネコの数">😺 0</span>
    </div>
    <div class="meta">
      <!-- 追加: サウンドのオン/オフトグル -->
      <button id="muteBtn" class="btn ghost" title="音のオン/オフ"><span class="icon" aria-hidden="true">🔔</span> 音</button>
      <button id="shareBtn" class="btn ghost" title="URLをコピー"><span class="icon" aria-hidden="true">🔗</span> 共有</button>
      <button id="helpBtn" class="btn ghost" title="使い方"><span class="icon" aria-hidden="true">❔</span> ヘルプ</button>
    </div>
  </header>

  <div id="play" aria-label="play-area"></div>

  <div id="bar">
    <button id="poseBtn" class="btn" title="立つ/座るの切替" aria-pressed="false"><span class="icon" aria-hidden="true">🪑</span> 座る</button>
    <div id="msgWrap">
      <input id="msg" type="text" inputmode="text" autocomplete="off" placeholder="短いことば…（非英語10文字 / 英語10語）" aria-label="メッセージ入力。非英語は10文字まで、英語は10語まで">
      <div id="helper">
        <span id="hintLang">非英語モード：0 / 10</span>
        <span>Enterで送信 / Sで座る</span>
      </div>
    </div>
    <button id="send" class="btn" disabled title="メッセージ送信"><span class="icon" aria-hidden="true">📨</span> 送信</button>
  </div>

  <div id="hint" aria-live="polite">画面をタップで自分の猫がゆっくり移動</div>
</div>

<div id="join" role="dialog" aria-modal="true" aria-label="名前入力">
  <div class="card">
    <h2>名前を入れて参加</h2>
    <p>名前は<strong>3文字まで</strong>。全員同じ場を共有する。ゆっくり遊ぶ場所。</p>
    <div class="row">
      <input id="nameInput" maxlength="3" placeholder="たとえば『ララ』" aria-label="名前（3文字まで）">
      <button id="enterBtn">はじめる</button>
    </div>
    <div id="warn" role="status" aria-live="polite"></div>
    <p class="subtle">ヒント：同じURLを開くと同じひろばに入る。共有ボタンでURLコピー。</p>
  </div>
</div>

<dialog id="helpDialog">
  <div style="padding:16px 16px 12px; max-width:560px">
    <h3 style="margin:0 0 8px">使い方</h3>
    <ul style="margin:0 0 12px 18px; line-height:1.7; color:#374151; font-size:14px">
      <li>画面をタップすると、ネコがゆっくり移動する</li>
      <li>座る/立つの切替はボタンかキーボードの <b>S</b></li>
      <li>メッセージは非英語10文字まで／英語10語まで。吹き出しは少しで消える</li>
      <li>同じURLの人たち全員でプレイエリアを共有する</li>
    </ul>
    <div style="display:flex; gap:8px; justify-content:flex-end">
      <button id="helpClose" class="btn">OK</button>
    </div>
  </div>
</dialog>

<script type="module">
const firebaseConfig = {
  apiKey: "AIzaSyCUpt4XLfSSZLt0VhJon926--c-I2tRMkE",
  authDomain: "blackcat-67716.firebaseapp.com",
  databaseURL: "https://blackcat-67716-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "blackcat-67716",
  storageBucket: "blackcat-67716.appspot.com",
  messagingSenderId: "124690483795",
  appId: "1:124690483795:web:73b5b2ba28f4e4d503d4a6",
  measurementId: "G-R47HW00266"
};

// WORLD_ID: ?room=xxx または #room=xxx、無ければ既定
const url = new URL(location.href);
const qp = url.searchParams.get("room");
const hp = (location.hash.match(/room=([^&]+)/)||[])[1];
const WORLD_ID = qp || hp || "global-plaza-1";

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set, update, serverTimestamp, onDisconnect }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

/* DOM */
const play = document.getElementById("play");
const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const poseBtn = document.getElementById("poseBtn");
const join = document.getElementById("join");
const nameInput = document.getElementById("nameInput");
const enterBtn = document.getElementById("enterBtn");
const warn = document.getElementById("warn");
const worldLabel = document.getElementById("worldLabel");
const countLabel = document.getElementById("countLabel");
const shareBtn = document.getElementById("shareBtn");
const helpBtn = document.getElementById("helpBtn");
const helpDialog = document.getElementById("helpDialog");
const helpClose = document.getElementById("helpClose");
const hintLang = document.getElementById("hintLang");
const muteBtn = document.getElementById("muteBtn");

/* 状態 */
let uid = null;
let me = { name:"", x:0.5, y:0.7, dir:1, pose:"stand", msg:"", msgAt:0 };
let target = {x: me.x, y: me.y};
let lastSync = 0, lastHeartbeat = 0;
let SPEED_PX_PER_S = 120;
const SYNC_INTERVAL_MS = 80, HEARTBEAT_MS = 15000, BUBBLE_MS = 12000;

worldLabel.textContent = `room: ${WORLD_ID}`;

/* ===== サウンド（Web Audio） ===== */
let AC = null, masterGain = null;
let muted = localStorage.getItem("yuru_mute")==="1";

function unlockAudio(){
  if (!AC) {
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if (!Ctx) return; // 古いブラウザ
    AC = new Ctx();
    masterGain = AC.createGain();
    masterGain.gain.value = muted ? 0 : 0.24;
    masterGain.connect(AC.destination);
  }
  if (AC && AC.state === "suspended") AC.resume();
}
function setupAudioUnlock(){
  // 最初のユーザー操作でAudioContextを起動
  const once = ()=>{ unlockAudio(); document.removeEventListener("pointerdown", once); document.removeEventListener("keydown", once); };
  document.addEventListener("pointerdown", once, {passive:true});
  document.addEventListener("keydown", once);
  enterBtn.addEventListener("click", unlockAudio, {once:true});
}
setupAudioUnlock();

function tone({freq=880, dur=0.12, type="sine", vol=0.7, attack=0.005, release=0.12}={}){
  if (!AC) return; // まだunlockされていない
  const osc = AC.createOscillator();
  const g = AC.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  osc.connect(g);
  g.connect(masterGain || AC.destination);
  const t = AC.currentTime;
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(vol, t + attack);
  g.gain.exponentialRampToValueAtTime(0.0001, t + attack + release);
  osc.start(t);
  osc.stop(t + dur + 0.25);
}
function playLogin(){
  if (muted || !AC) return;
  tone({freq:880, type:"triangle", vol:0.55, dur:0.12});
  setTimeout(()=> tone({freq:1320, type:"triangle", vol:0.55, dur:0.12}), 140);
}
function playMessage(){
  if (muted || !AC) return;
  tone({freq:700, type:"sine", vol:0.5, dur:0.09});
}
function renderMuteButton(){
  muteBtn.innerHTML = `<span class="icon" aria-hidden="true">${muted ? "🔇" : "🔔"}</span> ${muted ? "ミュート" : "音オン"}`;
}
muteBtn.addEventListener("click", ()=>{
  muted = !muted;
  if (masterGain) masterGain.gain.value = muted ? 0 : 0.24;
  localStorage.setItem("yuru_mute", muted ? "1":"0");
  renderMuteButton();
});
renderMuteButton();

/* ユーティリティ */
const now = ()=>performance.now();
const clamp01 = v => Math.max(0, Math.min(1, v));
const escapeHTML = s => s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
const isASCIIish = s => /^[\x00-\x7F]+$/.test(s);
const countWordsASCII = s => s.trim().split(/\s+/).filter(Boolean).length;
function toNorm(cx,cy){ const r=play.getBoundingClientRect(); return {x:clamp01((cx-r.left)/r.width), y:clamp01((cy-r.top)/r.height)}; }
function toPx(nx,ny){ const r=play.getBoundingClientRect(); return {x:nx*r.width, y:ny*r.height}; }
function pingAt(nx,ny){ const {x,y}=toPx(nx,ny); const s=document.createElement("span"); s.className="ping"; s.style.left=`${x}px`; s.style.top=`${y}px`; play.appendChild(s); s.addEventListener("animationend",()=>s.remove());}
function validateMessage(raw){
  if(!raw) return {ok:false}; 
  if(isASCIIish(raw)){ if(countWordsASCII(raw)>10 || raw.length>100) return {ok:false}; }
  else { if(Array.from(raw).length>10) return {ok:false}; }
  return {ok:true};
}

/* 参加 */
nameInput.addEventListener("input", ()=>{
  const n = nameInput.value.trim();
  if([...n].length>3) nameInput.value = Array.from(n).slice(0,3).join("");
});
enterBtn.addEventListener("click", startJoin);
nameInput.addEventListener("keydown", e=>{ if(e.key==="Enter") startJoin(); });
function startJoin(){
  const n = nameInput.value.trim();
  if([...n].length===0){ warn.textContent="1〜3文字"; return; }
  if([...n].length>3){ warn.textContent="3文字まで"; return; }
  me.name = n;
  join.style.display = "none";
  localStorage.setItem("yuru_name", me.name);
  initAuth();
}
const remembered = localStorage.getItem("yuru_name"); if(remembered) nameInput.value = remembered.slice(0,3);

/* 認証 */
async function initAuth(){
  try{ await signInAnonymously(auth); }
  catch(e){ alert("匿名認証に失敗。Authentication設定を確認。"); console.error("[auth] signIn failed:", e); }
}
onAuthStateChanged(auth, user=>{
  if(!user) return;
  uid = user.uid;
  me.x = Math.random()*0.8 + 0.1; me.y = Math.random()*0.4 + 0.5; target={x:me.x,y:me.y};
  // 自分DOMは即作る（DBが弾かれても見える）
  ensureMineDom();
  mountPresence();
  listenWorld();
  loop();
});

/* DB refs */
const playersRef = ref(db, `worlds/${WORLD_ID}/players`);
const myRef = ()=> ref(db, `worlds/${WORLD_ID}/players/${uid}`);

/* プレゼンス */
async function mountPresence(){
  try{
    await set(myRef(), {
      name: me.name, x: me.x, y: me.y, dir: me.dir, pose: me.pose,
      msg: "", msgAt: 0, lastActive: serverTimestamp()
    });
  }catch(e){
    console.error("[rtdb] initial set failed:", e);
  }
  try{ onDisconnect(myRef()).remove(); }catch(e){ console.warn("[rtdb] onDisconnect set failed:", e); }
}

/* 購読＆描画 */
const domMap = new Map(); // uid -> {wrap,...}
let initialPlayersLoaded = false;

onValue(playersRef, snap=>{
  const data = snap.val() || {};
  const ids = Object.keys(data);
  countLabel.textContent = `😺 ${ids.length}`;

  // 新規参加の検出（初期ロード後のみ音を鳴らす）
  if (initialPlayersLoaded) {
    for (const id of ids) {
      if (!domMap.has(id) && id !== uid) playLogin();
    }
  }

  const seen = new Set(ids);
  for(const id of ids){
    let pdom = domMap.get(id);
    if(!pdom){ pdom = createPlayerDom(id); domMap.set(id, pdom); play.appendChild(pdom.wrap); }
    renderPlayer(pdom, data[id], id===uid);
  }
  for(const [id,pdom] of domMap){ if(!seen.has(id)){ pdom.wrap.remove(); domMap.delete(id); } }

  initialPlayersLoaded = true;
});

function createPlayerDom(id){
  const wrap = document.createElement("div");
  wrap.className = "p stand";
  const nameEl = document.createElement("div"); nameEl.className = "name";
  const bubble = document.createElement("div"); bubble.className = "bubble"; bubble.style.display = "none";
  const svg = document.createElementNS("http://www.w3.org/2000/svg","svg");
  svg.setAttribute("viewBox","0 0 100 100"); svg.classList.add("cat");

  const body = document.createElementNS(svg.namespaceURI,"path");
  body.setAttribute("fill","#000"); body.setAttribute("d","M28,68 Q40,48 58,46 Q78,46 84,60 Q86,74 64,80 Q42,82 28,68 Z");
  const head = document.createElementNS(svg.namespaceURI,"circle"); head.setAttribute("cx","80"); head.setAttribute("cy","48"); head.setAttribute("r","11"); head.setAttribute("fill","#000");
  const ear1 = document.createElementNS(svg.namespaceURI,"path"); ear1.setAttribute("fill","#000"); ear1.setAttribute("d","M75,40 L80,33 L82,42 Z");
  const ear2 = document.createElementNS(svg.namespaceURI,"path"); ear2.setAttribute("fill","#000"); ear2.setAttribute("d","M85,40 L90,33 L88,42 Z");
  const tail = document.createElementNS(svg.namespaceURI,"path"); tail.setAttribute("fill","#000"); tail.setAttribute("d","M24,62 C18,54 24,42 38,40 C50,38 56,44 56,50 C40,54 32,60 30,68 Z"); tail.classList.add("wag");
  const backLeg = document.createElementNS(svg.namespaceURI,"rect"); backLeg.setAttribute("x","50"); backLeg.setAttribute("y","72"); backLeg.setAttribute("width","6"); backLeg.setAttribute("height","14"); backLeg.setAttribute("fill","#000");
  const frontLeg = document.createElementNS(svg.namespaceURI,"rect"); frontLeg.setAttribute("x","66"); frontLeg.setAttribute("y","72"); frontLeg.setAttribute("width","6"); frontLeg.setAttribute("height","14"); frontLeg.setAttribute("fill","#000");

  const sitGroup = document.createElementNS(svg.namespaceURI,"g"); sitGroup.setAttribute("display","none");
  const sBody = document.createElementNS(svg.namespaceURI,"path"); sBody.setAttribute("fill","#000"); sBody.setAttribute("d","M30,72 Q42,54 64,54 Q82,54 84,66 Q86,80 62,84 Q40,86 30,72 Z");
  const sHead = document.createElementNS(svg.namespaceURI,"circle"); sHead.setAttribute("cx","78"); sHead.setAttribute("cy","50"); sHead.setAttribute("r","11"); sHead.setAttribute("fill","#000");
  const sEar1 = document.createElementNS(svg.namespaceURI,"path"); sEar1.setAttribute("fill","#000"); sEar1.setAttribute("d","M73,42 L78,35 L80,44 Z");
  const sEar2 = document.createElementNS(svg.namespaceURI,"path"); sEar2.setAttribute("fill","#000"); sEar2.setAttribute("d","M83,42 L88,35 L86,44 Z");
  const sTail = document.createElementNS(svg.namespaceURI,"path"); sTail.setAttribute("fill","#000"); sTail.setAttribute("d","M28,70 C20,66 22,56 32,52 C40,50 46,54 44,60 C38,66 34,70 30,74 Z"); sTail.classList.add("wag");

  svg.appendChild(body); svg.appendChild(head); svg.appendChild(ear1); svg.appendChild(ear2);
  svg.appendChild(tail); svg.appendChild(backLeg); svg.appendChild(frontLeg);
  sitGroup.appendChild(sBody); sitGroup.appendChild(sHead); sitGroup.appendChild(sEar1); sitGroup.appendChild(sEar2); sitGroup.appendChild(sTail);
  svg.appendChild(sitGroup);

  wrap.appendChild(nameEl); wrap.appendChild(bubble); wrap.appendChild(svg);
  return {wrap, nameEl, bubbleEl: bubble, svg, sitGroup, standParts:[body,head,ear1,ear2,tail,backLeg,frontLeg], _lastMsgKey:null, _ready:false};
}

function renderPlayer(pdom, data, isSelf){
  const r = play.getBoundingClientRect();
  pdom.wrap.style.left = `${data.x * r.width}px`;
  pdom.wrap.style.top  = `${data.y * r.height}px`;
  pdom.nameEl.textContent = data.name || "";
  pdom.wrap.classList.toggle("self", !!isSelf);

  if(data.dir === -1) pdom.svg.classList.add("face-left"); else pdom.svg.classList.remove("face-left");
  if(data.pose === "sit"){ pdom.wrap.classList.remove("stand"); pdom.wrap.classList.add("sit"); pdom.sitGroup.setAttribute("display","block"); pdom.standParts.forEach(n=>n.setAttribute("display","none")); }
  else { pdom.wrap.classList.add("stand"); pdom.wrap.classList.remove("sit"); pdom.sitGroup.setAttribute("display","none"); pdom.standParts.forEach(n=>n.setAttribute("display","block")); }

  const text = data.msg || ""; const msgAt = data.msgAt || 0; const key = `${text}|${msgAt}`;
  if(text && key !== pdom._lastMsgKey){
    const firstRender = !pdom._ready;
    pdom._ready = true;
    pdom._lastMsgKey = key;
    pdom.bubbleEl.innerHTML = escapeHTML(text);
    pdom.bubbleEl.style.display = "block";
    const age = typeof msgAt==="number" ? (Date.now()-msgAt) : 0; const remain = Math.max(1200, 12000 - Math.max(0,age));
    clearTimeout(pdom._bubbleTimer); pdom._bubbleTimer = setTimeout(()=>{ pdom.bubbleEl.style.display = "none"; }, remain);
    // 受信メッセージ音（初回描画や自分の送信は鳴らさない）
    if (!firstRender && !isSelf) playMessage();
  }else if(!text){
    pdom.bubbleEl.style.display = "none";
  }
}

/* 自分DOMを保証（初期setに失敗しても出す） */
function ensureMineDom(){
  if(!uid) return;
  if(!domMap.get(uid)){ const d=createPlayerDom(uid); domMap.set(uid,d); play.appendChild(d.wrap); }
  renderPlayer(domMap.get(uid), me, true);
}

/* 入力UI */
let lastSentAt = 0;
msgInput.addEventListener("input", ()=>{
  const v = msgInput.value;
  if(isASCIIish(v)){ const w=countWordsASCII(v); hintLang.textContent=`英語モード：${Math.min(w,10)} / 10 語`; }
  else { const len=Array.from(v).length; hintLang.textContent=`非英語モード：${Math.min(len,10)} / 10 文字`; }
  sendBtn.disabled = !validateMessage(v).ok;
});
sendBtn.addEventListener("click", sendMsg);
msgInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMsg(); }});
poseBtn.addEventListener("click", togglePose);
window.addEventListener("keydown", e=>{ if(e.key.toLowerCase()==="s"){ togglePose(); }});
function togglePose(){
  me.pose = (me.pose === "stand") ? "sit" : "stand";
  // 既存の実装を尊重（アイコンは消えるが動作優先）
  poseBtn.textContent = (me.pose === "stand") ? "座る" : "立つ";
  poseBtn.setAttribute("aria-pressed", me.pose === "sit" ? "true":"false");
  safeUpdate({pose: me.pose});
}

/* タップ移動 */
function setTargetFromEvent(e){
  const pt = (e.touches && e.touches[0]) ? e.touches[0] : e;
  const {x,y} = toNorm(pt.clientX, pt.clientY);
  const pxNow = toPx(me.x, me.y).x; const pxNext = toPx(x, y).x;
  target.x=x; target.y=y; me.dir = (pxNext >= pxNow) ? 1 : -1;
  safeUpdate({dir: me.dir}); pingAt(x,y);
}
play.addEventListener("pointerdown", setTargetFromEvent);
play.addEventListener("touchstart", setTargetFromEvent, {passive:true});

/* ループ */
let lastT = now();
function loop(){
  const t=now(); const dt=Math.max(0, Math.min(0.05,(t-lastT)/1000)); lastT=t;
  const r=play.getBoundingClientRect();
  const pxPos=toPx(me.x,me.y), pxTarget=toPx(target.x,target.y);
  const dx=pxTarget.x-pxPos.x, dy=pxTarget.y-pxPos.y, dist=Math.hypot(dx,dy);
  const step=SPEED_PX_PER_S*dt;
  if(dist>1){ const nx=pxPos.x+(dx/dist)*step, ny=pxPos.y+(dy/dist)*step; const nn=toNorm(nx+r.left, ny+r.top); me.x=nn.x; me.y=nn.y; }
  else { me.x=target.x; me.y=target.y; }

  ensureMineDom();

  if((t-lastSync)>=SYNC_INTERVAL_MS){ safeUpdate({x:me.x, y:me.y}); lastSync=t; }
  if((t-lastHeartbeat)>=HEARTBEAT_MS){ safeUpdate({lastActive: serverTimestamp()}); lastHeartbeat=t; }
  requestAnimationFrame(loop);
}

/* 書き込み（ログ付き） */
async function safeUpdate(patch){
  if(!uid) return;
  try{ await update(myRef(), patch); }
  catch(e){ console.error("[rtdb] update failed:", patch, e); }
}

/* 送信（即時表示＋サーバ時刻） */
function sendMsg(){
  const raw = msgInput.value.trim(); if(!validateMessage(raw).ok) return;
  const nowMs = Date.now(); if(nowMs - lastSentAt < 500) return; lastSentAt = nowMs;
  me.msg = raw; me.msgAt = nowMs; ensureMineDom();
  msgInput.value=""; sendBtn.disabled=true;
  safeUpdate({ msg: raw, msgAt: serverTimestamp() });
  // 自分は音を鳴らさない（必要ならここで鳴らす）
}

/* 購読 */
function listenWorld(){}

/* 共有ボタン：常に ?room= を付与 */
shareBtn.addEventListener("click", async ()=>{
  const invite = new URL(location.href);
  invite.searchParams.set("room", WORLD_ID);
  invite.hash = invite.hash.replace(/room=[^&]+&?/,'').replace(/[#&]$/,'');
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(invite.toString());
      toast("URLをコピーした（同じ部屋に入れる）");
    }else{
      prompt("このURLをコピーして共有してね", invite.toString());
    }
  }catch(e){ console.warn("clipboard failed:", e); }
});
helpBtn.addEventListener("click", ()=> helpDialog.showModal());
helpClose.addEventListener("click", ()=> helpDialog.close());

/* オンライン表示 */
window.addEventListener("online",  ()=> toast("オンライン"));
window.addEventListener("offline", ()=> toast("オフライン：再接続待ち"));
function toast(text){ const el=document.getElementById("hint"); el.textContent=text; el.style.opacity=.95; clearTimeout(toast._t); toast._t=setTimeout(()=> el.style.opacity=.75,1500); }

/* 起動前チェック */
(function(){ const needs=["apiKey","authDomain","databaseURL","projectId","appId"]; if(needs.some(k=>!firebaseConfig[k])) toast("Firebaseのconfigを入れてから使う"); })();
msgInput.dispatchEvent(new Event("input"));
</script>
</body>
</html>
