<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<title>ãã‚ã­ã“ã²ã‚ã° / Black Cats Plaza</title>
<meta name="color-scheme" content="light only">
<!-- ç”»åƒã¯äº‹å‰ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãŠã -->
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png" as="image" crossorigin>
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_sitting.png"  as="image" crossorigin>
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/angerCAT.png"    as="image" crossorigin>
<style>
  :root{
    --bg:#fffdf9; --panel:#ffffff; --ink:#1a1a1a; --muted:#6b7280;
    --accent:#ff7aa2; --accent-ink:#fff; --border:#e5e7eb;
    --barH:60px; --ring:3px; --ringColor:rgba(255,122,162,.45);
    --pin-bg:#ffe7ef; --pin-bd:#ffc6d7;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%; margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Hiragino Kaku Gothic ProN",Meiryo,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--ink)}
  body,button,input{touch-action:manipulation}
  #app{position:fixed; inset:0; display:flex; flex-direction:column}

  /* ===== Top ===== */
  header{position:sticky; top:0; z-index:2000; padding:calc(env(safe-area-inset-top)+4px) 10px 8px; padding-right:calc(10px + env(safe-area-inset-right)); border-bottom:1px solid var(--border); background:var(--panel)}
  .topbar{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px}
  .brand{display:flex; align-items:center; gap:10px; min-width:0}
  .brand h1{font-size:clamp(13px,2.2vw,16px); font-weight:800; margin:0; white-space:nowrap; cursor:pointer}
  .chip{border:1px solid var(--border); background:#fafafa; border-radius:999px; padding:6px 10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:clamp(12px,1.6vw,14px)}
  #worldLabel{max-width:clamp(120px,38vw,360px)}
  #countDock{flex:0 0 auto; font-weight:800; background:#fff}
  .meta{display:flex; gap:8px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:none}
  .meta::-webkit-scrollbar{display:none}
  .btn{appearance:none; border:0; background:var(--accent); color:var(--accent-ink); border-radius:12px; padding:10px 12px; font-size:clamp(12px,1.7vw,14px); font-weight:800; cursor:pointer; min-height:40px; min-width:44px; display:inline-flex; align-items:center; gap:6px; white-space:nowrap; pointer-events:auto}
  .btn.ghost{background:transparent; color:var(--ink); border:1px solid var(--border)}
  .btn.iconOnly{padding:10px; min-width:44px}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .btn:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  .icon{font-variant-emoji:emoji; font-size:18px}
  .txt{display:inline-block}
  @media (max-width:940px){ .btn.ghost .txt{display:none} }

  /* ===== Play field ===== */
  #play{position:relative; flex:1; overflow:hidden;
        background-image:radial-gradient(circle at 1px 1px,#f1f3f5 1px,transparent 0),
                         radial-gradient(1200px 420px at 50% 120%, #f7f7f7 0%, transparent 60%);
        background-size:18px 18px, auto; user-select:none; touch-action:none; cursor:grab; z-index:0}
  #play.dragging{cursor:grabbing}
  #worldWrap{position:absolute; inset:0; transform-origin:0 0; will-change:transform}
  /* ãƒ¯ãƒ¼ãƒ«ãƒ‰ã¯ç«¯æœ«ã®é•·è¾º=æ­£æ–¹å½¢ï¼ˆ100vmaxï¼‰ */
  #world{position:absolute; left:0; top:0; width:100vmax; height:100vmax; border:2px dashed #e5e7eb; border-radius:16px; box-shadow:0 0 0 6px rgba(255,255,255,.6) inset}
  #notesLayer{position:absolute; inset:0; pointer-events:none; z-index:0}

  /* ===== Bottom bar ===== */
  #bar{height:var(--barH); display:flex; align-items:center; gap:8px; border-top:1px solid var(--border); background:var(--panel); padding:8px 10px; padding-bottom:calc(8px + env(safe-area-inset-bottom)); overflow:hidden}
  #msgWrap{flex:1 1 auto; display:flex; align-items:center; gap:8px; min-width:0; overflow:hidden; white-space:nowrap}
  #msg{flex:1 1 auto; min-width:160px; font-size:16px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; outline:none; background:#fff; height:38px; line-height:22px; white-space:nowrap}
  #helper{flex:0 0 auto; display:flex; align-items:center; gap:8px; font-size:12px; color:#6b7280; max-width:34%; overflow:hidden; text-overflow:ellipsis; user-select:none}
  @media (max-width:980px){ #helper{display:none} }

  /* ===== Players ===== */
  .p{position:absolute; width:78px; height:78px; transform:translate(-50%, -80%); z-index:10; will-change:left,top}
  .p.idle{opacity:.78}
  .p.offline{opacity:.6; filter:saturate(.85)}
  .catImg{width:78px; height:78px; display:block; object-fit:contain; pointer-events:none; transition:transform .18s ease; position:relative; z-index:0}
  .catImg.right{transform:scaleX(-1)}
  .catImg.sit{display:none}
  .catImg.angry{display:none}
  .sit .catImg.stand{display:none}
  .sit .catImg.sit{display:block}
  .emo-angry .catImg.stand,.emo-angry .catImg.sit{display:none}
  .emo-angry .catImg.angry{display:block}

  .name{position:absolute; left:50%; top:78px; transform:translateX(-50%); background:rgba(17,17,17,.95); color:#fff; font-size:12px; padding:2px 8px; border-radius:999px; white-space:nowrap; max-width:180px; text-overflow:ellipsis; overflow:hidden; letter-spacing:.2px; border:1px solid rgba(0,0,0,.6); z-index:20; pointer-events:none}
  .name.flip{top:auto; bottom:84px}

  /* Chat / Pin bubblesï¼ˆé‡ãªã‚Šé †ï¼šchat > name > pin > noteï¼‰ */
  .bubble{position:absolute; left:50%; transform:translateX(-50%); background:#fff; color:#111; border:1px solid var(--border); border-radius:12px; padding:8px 10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:min(86vw,520px); box-shadow:0 8px 22px rgba(0,0,0,.06); pointer-events:none; display:none}
  .bubble.chat{bottom:94px; font-size:14px; z-index:30}
  .bubble.pin{bottom:122px; background:var(--pin-bg); border-color:var(--pin-bd); font-size:0.66em; padding:6px 9px; z-index:10}
  .bubble.chat.bump{bottom:148px}
  .bubble.pin.bump{bottom:182px}

  /* Notes (æ›¸ãç½®ã) ã¯ä¸€ç•ªå¾Œã‚ */
  .noteItem{position:absolute; background:var(--pin-bg); border:1px solid var(--pin-bd); border-radius:10px; padding:4px 6px; font-size:0.5rem; color:#111; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; max-width:50vw; box-shadow:0 4px 12px rgba(0,0,0,.06); transform:translate(-50%, -120%)}
  .noteItem.flip{transform:translate(-50%, 18px)}

  /* Names peek + hint + dialogs */
  #namesPeek{position:fixed; left:50%; top:calc(8px + env(safe-area-inset-top)); transform:translateX(-50%); z-index:2600; background:rgba(0,0,0,.84); color:#fff; font-size:13px; border-radius:12px; padding:8px 10px; max-width:90vw; white-space:normal; display:none; pointer-events:none}
  #migrate{position:fixed; left:50%; top:70px; transform:translateX(-50%); z-index:3200; background:#111; color:#fff; border-radius:12px; padding:8px 10px; font-size:14px; display:none; align-items:center; gap:8px; box-shadow:0 12px 40px rgba(0,0,0,.25)}
  #migrate .go{border:0; background:#fff; color:#111; font-weight:800; padding:6px 10px; border-radius:10px; cursor:pointer}
  #migrate .close{border:0; background:transparent; color:#fff; font-weight:800; padding:4px 8px; cursor:pointer}

  #reconnect{position:fixed; inset:0; background:rgba(255,255,255,.92); display:none; align-items:center; justify-content:center; z-index:3000}
  #reconnect .card{width:min(92vw,520px); border:1px solid var(--border); border-radius:18px; background:#fff; padding:18px 16px 16px; box-shadow:0 18px 60px rgba(0,0,0,.08)}
  #reconnect h3{margin:0 0 8px}
  #reconnect .row{display:flex; gap:10px; justify-content:flex-end}

  #hint{position:fixed; right:10px; bottom:calc(var(--barH) + 10px + env(safe-area-inset-bottom)); background:#000; color:#fff; font-size:12px; padding:8px 10px; border-radius:10px; opacity:.92; z-index:2500; display:flex; align-items:center; gap:8px}
  #hint button{background:transparent; border:0; color:#fff; font-weight:900; cursor:pointer; padding:0 2px}

  /* Join */
  #join{position:fixed; inset:0; background:rgba(255,255,255,.9); display:flex; align-items:center; justify-content:center; z-index:2800}
  #join .card{width:min(92vw,560px); border:1px solid var(--border); border-radius:18px; background:#fff; padding:18px 16px 16px; box-shadow:0 18px 60px rgba(0,0,0,.08)}
  #join h2{margin:0 0 8px; font-size:18px}
  #join p{margin:0 0 12px; font-size:14px; color:#555; line-height:1.6}
  #join .row{display:flex; gap:10px}
  #join input{flex:1; font-size:18px; padding:12px 12px; border:1px solid var(--border); border-radius:12px; outline:none; background:#fff}
  #join input:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  #join button{padding:12px 14px; border-radius:12px; background:var(--accent); color:#fff; font-weight:800; font-size:16px; border:0; cursor:pointer; white-space:nowrap}
  #warn{color:#b40000; font-size:13px; min-height:1.4em}
  .subtle{font-size:12px; color:#6b7280}
  #joinGuide{font-size:12px; color:#374151; background:#fafafa; border:1px solid var(--border); padding:10px 10px; border-radius:12px; line-height:1.65; margin-top:8px}
  #joinGuide b{color:#111}

  #full{position:fixed; inset:0; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; z-index:2900}
  #full .card{width:min(92vw,520px); border:1px solid var(--border); border-radius:18px; background:#fff; padding:18px 16px 16px; box-shadow:0 18px 60px rgba(0,0,0,.08); text-align:center}

  @media (prefers-reduced-motion: reduce){ .p{transition:none} }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="topbar">
      <div class="brand">
        <h1 id="brandTitle">ãã‚ã­ã“ã²ã‚ã°</h1>
        <span class="chip" id="worldLabel"></span>
      </div>
      <span class="chip" id="countDock" aria-live="polite">ğŸˆâ€â¬› 0</span>
    </div>
    <div class="meta" id="meta">
      <button id="helpBtn"      class="btn ghost" title="ä½¿ã„æ–¹"><span class="icon">â”</span><span class="txt" id="lblHelp"> ãƒ˜ãƒ«ãƒ—</span></button>
      <button id="poseTopBtn"   class="btn ghost" title="ç«‹ã¤/åº§ã‚‹"><span class="icon">ğŸª‘</span><span class="txt" id="lblPose"> åº§ã‚‹</span></button>
      <button id="angerBtn"     class="btn ghost" title="å¨åš‡"><span class="icon">ğŸ’¢</span><span class="txt" id="lblAnger"> å¨åš‡</span></button>
      <button id="muteBtn"      class="btn ghost" title="éŸ³ã®ã‚ªãƒ³/ã‚ªãƒ•"><span class="icon" id="soundIcon">ğŸ””</span><span class="txt" id="lblSound"> éŸ³ã‚ªãƒ³</span></button>
      <button id="newRoomBtn"   class="btn ghost" title="æ–°ã—ã„éƒ¨å±‹ã‚’ä½œã‚‹"><span class="icon">ğŸ†•</span><span class="txt" id="lblNew"> æ–°éƒ¨å±‹</span></button>
      <button id="shareBtn"     class="btn ghost" title="URLã‚’ã‚³ãƒ”ãƒ¼"><span class="icon">ğŸ”—</span><span class="txt" id="lblShare"> å…±æœ‰</span></button>
      <button id="zoomOutBtn"   class="btn ghost iconOnly" title="ã‚ºãƒ¼ãƒ ã‚¢ã‚¦ãƒˆ"><span class="icon">â–</span></button>
      <span   id="zoomLabel"    class="chip" aria-live="polite">100%</span>
      <button id="zoomInBtn"    class="btn ghost iconOnly" title="ã‚ºãƒ¼ãƒ ã‚¤ãƒ³"><span class="icon">â•</span></button>
      <button id="leaveBtn"     class="btn ghost" title="é€€å®¤"><span class="icon">ğŸšª</span><span class="txt" id="lblLeave"> é€€å®¤</span></button>
      <button id="noteClearBtn" class="btn ghost" title="è‡ªåˆ†ã®æ›¸ãç½®ãã‚’æ¶ˆã™"><span class="icon">ğŸ—‘ï¸</span><span class="txt" id="lblClear"> ã‚¯ãƒªã‚¢</span></button>
      <button id="langBtn"      class="btn ghost" title="è¨€èªåˆ‡æ›¿"><span class="icon" id="langIcon">ğŸ‡¯ğŸ‡µ</span><span class="txt" id="lblLang"> æ—¥æœ¬èª</span></button>
    </div>
  </header>

  <div id="play" aria-label="play-area">
    <div id="worldWrap">
      <div id="world"><div id="notesLayer"></div></div>
    </div>
  </div>

  <div id="bar">
    <div id="msgWrap">
      <input id="msg" type="text" inputmode="text" autocomplete="off" placeholder="(15æ–‡å­— / 10 words)" aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›">
      <div id="helper"><span id="hintLang">éè‹±èªï¼š0/15</span><span id="hintKeys">Enteré€ä¿¡ / Sã§åº§ã‚‹</span></div>
    </div>
    <button id="pinBtn"  class="btn iconOnly" title="ãƒ”ãƒ³ç•™ã‚"><span class="icon">ğŸ“Œ</span></button>
    <button id="noteBtn" class="btn iconOnly" title="æ›¸ãç½®ã"><span class="icon">ğŸ–‹ï¸</span></button>
    <button id="send"    class="btn iconOnly" disabled title="é€ä¿¡"><span class="icon">ğŸ“¨</span></button>
  </div>

  <div id="hint" role="status" aria-live="polite">
    <span id="hintText">ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç§»å‹•ã€‚ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—/ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚³ãŒç§»å‹•ã€‚ãƒ”ãƒ³ãƒã§ã‚ºãƒ¼ãƒ ã€‚</span>
    <button id="hintClose" aria-label="é–‰ã˜ã‚‹">âœ•</button>
  </div>
</div>

<div id="namesPeek" aria-live="polite"></div>

<div id="migrate" role="alert">
  <span id="migrateText">ğŸ†• æ–°ã—ã„éƒ¨å±‹ãŒä½œã‚‰ã‚ŒãŸ</span>
  <button class="go" id="migrateGo">ç§»å‹•</button>
  <button class="close" id="migrateClose" aria-label="é–‰ã˜ã‚‹">âœ•</button>
</div>

<div id="reconnect" role="alertdialog" aria-modal="true">
  <div class="card">
    <h3 id="rcTitle">æ¥ç¶šãŒåˆ‡ã‚ŒãŸ</h3>
    <p id="rcDesc">ã“ã®ã‚¿ãƒ–ã¯ä¼‘æ†©ä¸­ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯åº§ã£ã¦æ®‹ã£ã¦ã„ã‚‹ã€‚å†æ¥ç¶šã§å‹•ã‘ã‚‹ã€‚</p>
    <div class="row"><button id="reconnectBtn" class="btn">å†æ¥ç¶š</button><button id="reconnectClose" class="btn ghost">é–‰ã˜ã‚‹</button></div>
  </div>
</div>

<div id="join" role="dialog" aria-modal="true" aria-label="åå‰å…¥åŠ›">
  <div class="card">
    <h2 id="joinTitle">åå‰ã‚’å…¥ã‚Œã¦å‚åŠ </h2>
    <p id="joinDesc">åå‰ã¯3æ–‡å­—ã¾ã§ã€‚URLãŒåŒã˜ãªã‚‰åŒã˜éƒ¨å±‹ã€‚è½ã¡ç€ã„ã¦éŠã¶å ´ã€‚</p>
    <div class="row">
      <input id="nameInput" maxlength="3" aria-label="åå‰ï¼ˆ3æ–‡å­—ã¾ã§ï¼‰">
      <button id="enterBtn">ã¯ã˜ã‚ã‚‹</button>
    </div>
    <div id="warn" role="status" aria-live="polite"></div>
    <div id="joinGuide" class="subtle">
      <div>ğŸ“¨ ãƒãƒ£ãƒƒãƒˆé€ä¿¡ è‹±èªã¯10èªãƒ»æ—¥æœ¬èªã¯15æ–‡å­—ã¾ã§ã€‚60ç§’ã§æ¶ˆãˆã‚‹</div>
      <div>ğŸ“Œ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ é ­ä¸Šã«å°ã•ãå›ºå®šã€‚ã‚‚ã†ä¸€åº¦ğŸ“Œã‚¿ãƒƒãƒ—ã§è§£é™¤</div>
      <div>ğŸ–‹ï¸ æ›¸ç½® è¶³å…ƒã«å°ã•ãæ®‹ã™ã€‚ã²ã¨ã‚Šä¸€ä»¶ã€‚æ›´æ–°å¯ã€‚ğŸ—‘ï¸ã§ã‚¯ãƒªã‚¢ã€‚8æ™‚é–“ã§è‡ªå‹•å‰Šé™¤</div>
      <div>ğŸ–±ï¸ PCï¼š<b>ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç§»å‹•</b>ãƒ»<b>ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚³ç§»å‹•</b> / ğŸ“± ã‚¹ãƒãƒ›ï¼š<b>ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç§»å‹•</b>ãƒ»<b>ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ãƒã‚³ç§»å‹•</b>ãƒ»ãƒ”ãƒ³ãƒã§ã‚ºãƒ¼ãƒ </div>
      <div>ğŸ”— ã§ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’æ‹›å¾…</div>
    </div>
  </div>
</div>

<dialog id="helpDialog"></dialog>

<div id="full" style="display:none">
  <div class="card">
    <h3>æº€å®¤ ğŸˆâ€â¬›</h3>
    <p>ã“ã®éƒ¨å±‹ã¯ä¸Šé™ã«é”ã—ã¦ã„ã‚‹ã€‚ğŸ†• ã§æ–°ã—ã„éƒ¨å±‹ã‚’ä½œã‚‹ã‹ã€ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å…¥å®¤ã—ã¦ã­ã€‚</p>
  </div>
</div>

<script type="module">
/* ===== Firebase è¨­å®š ===== */
const firebaseConfig = {
  apiKey: "AIzaSyCUpt4XLfSSZLt0VhJon926--c-I2tRMkE",
  authDomain: "blackcat-67716.firebaseapp.com",
  databaseURL: "https://blackcat-67716-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "blackcat-67716",
  storageBucket: "blackcat-67716.appspot.com",
  messagingSenderId: "124690483795",
  appId: "1:124690483795:web:73b5b2ba28f4e4d503d4a6",
  measurementId: "G-R47HW00266"
};

/* ===== å®šæ•° ===== */
const CAT_STAND_URL="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png";
const CAT_SIT_URL  ="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_sitting.png";
const CAT_ANGRY_URL="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/angerCAT.png";

const HEARTBEAT_MS=7000;              // å¿ƒæ‹ï¼ˆlastActiveæ›´æ–°ï¼‰
const IDLE_MS=90*1000;                // å…¥åŠ›ç„¡ã—â†’idle
const NOTE_TTL_MS=8*60*60*1000;       // æ›¸ãç½®ãTTL
const EMO_SHOW_MS=3000;               // å¨åš‡è¡¨ç¤º
const ROOM_CAP=10;                    // ä¸Šé™
const MIGRATE_TTL_MS=30000;           // æ–°éƒ¨å±‹ãƒãƒƒãƒ—
const SPEED_PX_PER_S=120;             // çŒ«é€Ÿåº¦
const NON_ASCII_LIMIT=15;             // æ—¥æœ¬èªãªã©
const BUBBLE_MS=60000;                // ãƒãƒ£ãƒƒãƒˆè¡¨ç¤º60ç§’
const ZMIN=0.4, ZMAX=2.0;             // ç”»é¢ã‚ºãƒ¼ãƒ 
const PARK_GRACE_MS=6*60*60*1000;     // ä¼‘çœ è¨±å®¹ï¼ˆäººæ•°ã‚«ã‚¦ãƒ³ãƒˆã®ä¸Šé™åˆ¤å®šï¼‰

/* ===== ãƒ«ãƒ¼ãƒ ID ===== */
const url = new URL(location.href);
const qp = url.searchParams.get("room");
const hp = (location.hash.match(/room=([^&]+)/)||[])[1];
function makeRoomId(){
  const t = Date.now().toString(36).slice(-6);
  const r = crypto.getRandomValues(new Uint32Array(1))[0].toString(36).slice(-5);
  return `plaza-${t}-${r}`;
}
function setURLRoom(id){
  const u = new URL(location.href);
  u.searchParams.set("room", id);
  u.hash = u.hash.replace(/room=[^&]+&?/,'').replace(/[#&]$/,'');
  history.replaceState({}, "", u.toString());
}
let WORLD_ID = qp || hp || null;
if(!WORLD_ID){ WORLD_ID = makeRoomId(); setURLRoom(WORLD_ID); }

/* ===== Firebase init ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set, update, serverTimestamp, onDisconnect, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app = initializeApp(firebaseConfig);
const db  = getDatabase(app);
const auth= getAuth(app);

/* ===== DOM ===== */
const play = document.getElementById("play");
const worldWrap = document.getElementById("worldWrap");
const world = document.getElementById("world");
const notesLayer = document.getElementById("notesLayer");

const msgInput = document.getElementById("msg");
const sendBtn = document.getElementById("send");
const pinBtn = document.getElementById("pinBtn");
const noteBtn = document.getElementById("noteBtn");
const noteClearBtn = document.getElementById("noteClearBtn");

const poseTopBtn = document.getElementById("poseTopBtn");
const angerBtn = document.getElementById("angerBtn");
const muteBtn = document.getElementById("muteBtn");
const newRoomBtn = document.getElementById("newRoomBtn");
const shareBtn = document.getElementById("shareBtn");
const leaveBtn = document.getElementById("leaveBtn");
const helpBtn = document.getElementById("helpBtn");
const helpDialog = document.getElementById("helpDialog");
const langBtn = document.getElementById("langBtn");
const brandTitle = document.getElementById("brandTitle");
const namesPeek = document.getElementById("namesPeek");
const worldLabel = document.getElementById("worldLabel");
const countDock = document.getElementById("countDock");

const join = document.getElementById("join");
const nameInput = document.getElementById("nameInput");
const enterBtn = document.getElementById("enterBtn");
const warn = document.getElementById("warn");

const reconnect = document.getElementById("reconnect");
const reconnectBtn = document.getElementById("reconnectBtn");
const reconnectClose = document.getElementById("reconnectClose");

const full = document.getElementById("full");

const zoomInBtn = document.getElementById("zoomInBtn");
const zoomOutBtn = document.getElementById("zoomOutBtn");
const zoomLabel = document.getElementById("zoomLabel");

const hint = document.getElementById("hint");
const hintText = document.getElementById("hintText");
const hintClose = document.getElementById("hintClose");

worldLabel.textContent = `room: ${WORLD_ID}`;

/* ===== i18n ===== */
const I18N = {
  ja:{
    brand:"ãã‚ã­ã“ã²ã‚ã°",
    help:"ãƒ˜ãƒ«ãƒ—",
    poseSit:"åº§ã‚‹", poseStand:"ç«‹ã¤",
    anger:"å¨åš‡",
    soundOn:"éŸ³ã‚ªãƒ³", soundMute:"ãƒŸãƒ¥ãƒ¼ãƒˆ",
    newRoom:"æ–°éƒ¨å±‹", share:"å…±æœ‰", leave:"é€€å®¤", clear:"ã‚¯ãƒªã‚¢",
    lang:"æ—¥æœ¬èª", langFlag:"ğŸ‡¯ğŸ‡µ",
    joinTitle:"åå‰ã‚’å…¥ã‚Œã¦å‚åŠ ",
    joinDesc:"åå‰ã¯3æ–‡å­—ã¾ã§ã€‚URLãŒåŒã˜ãªã‚‰åŒã˜éƒ¨å±‹ã€‚è½ã¡ç€ã„ã¦éŠã¶å ´ã€‚",
    joinGuide:[
      "ğŸ“¨ ãƒãƒ£ãƒƒãƒˆé€ä¿¡ è‹±èªã¯10èªãƒ»æ—¥æœ¬èªã¯15æ–‡å­—ã¾ã§ã€‚60ç§’ã§æ¶ˆãˆã‚‹",
      "ğŸ“Œ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ é ­ä¸Šã«å°ã•ãå›ºå®šã€‚ã‚‚ã†ä¸€åº¦ğŸ“Œã‚¿ãƒƒãƒ—ã§è§£é™¤",
      "ğŸ–‹ï¸ æ›¸ç½® è¶³å…ƒã«å°ã•ãæ®‹ã™ã€‚ã²ã¨ã‚Šä¸€ä»¶ã€‚æ›´æ–°å¯ã€‚ğŸ—‘ï¸ã§ã‚¯ãƒªã‚¢ã€‚8æ™‚é–“ã§è‡ªå‹•å‰Šé™¤",
      "ğŸ–±ï¸ PCï¼šãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç§»å‹•ãƒ»ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚³ç§»å‹• / ğŸ“± ã‚¹ãƒãƒ›ï¼šãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç§»å‹•ãƒ»ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ãƒã‚³ç§»å‹•ãƒ»ãƒ”ãƒ³ãƒã§ã‚ºãƒ¼ãƒ ",
      "ğŸ”— ã§ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ãƒ•ãƒ¬ãƒ³ãƒ‰ã‚’æ‹›å¾…"
    ],
    hint:"ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç§»å‹•ã€‚ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—/ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ãƒã‚³ãŒç§»å‹•ã€‚ãƒ”ãƒ³ãƒã§ã‚ºãƒ¼ãƒ ã€‚",
    helpContent:`
<h3 style="margin:0 0 8px">ä½¿ã„æ–¹</h3>
<ul style="margin:6px 0 14px 18px; line-height:1.7; color:#374151; font-size:14px">
  <li>å…¥å®¤æ™‚ã«åå‰ã‚’3æ–‡å­—ã§å…¥åŠ›</li>
  <li>ç”»é¢ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç§»å‹•ã€ãƒ”ãƒ³ãƒã§ã‚ºãƒ¼ãƒ ï¼ˆ0.4ã€œ2.0ï¼‰</li>
  <li>ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ— / ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§è‡ªåˆ†ã®çŒ«ãŒç§»å‹•</li>
  <li>ğŸ“¨ï¼šçŸ­æ–‡ãƒãƒ£ãƒƒãƒˆï¼ˆéè‹±èª15æ–‡å­— / è‹±èª10èªã€60ç§’ã§è‡ªå‹•æ¶ˆå»ï¼‰</li>
  <li>ğŸ“Œï¼šé ­ä¸Šã«å°ã•ãå›ºå®šï¼ˆã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨è§£é™¤ï¼‰</li>
  <li>ğŸ–‹ï¸ï¼šè¶³å…ƒã«æ›¸ãç½®ãï¼ˆ1äºº1ä»¶ã€æ›´æ–°å¯ã€ğŸ—‘ï¸ã§å‰Šé™¤ã€8æ™‚é–“ã§è‡ªå‹•éè¡¨ç¤ºï¼‰</li>
  <li>ğŸª‘ï¼šåº§ã‚‹/ç«‹ã¤ã®åˆ‡æ›¿ï¼ˆã‚¿ãƒ–ãŒèƒŒæ™¯ã®æ™‚ã¯è‡ªå‹•ã§åº§ã‚‹ï¼‰</li>
  <li>ğŸ’¢ï¼šå¨åš‡ï¼ˆ3ç§’ã®ã‚¨ãƒ¢ãƒ¼ãƒˆï¼‰</li>
  <li>ğŸ†•ï¼šæ–°ã—ã„éƒ¨å±‹ã‚’ä½œæˆã€‚å…¨å“¡ã«æ¡ˆå†…ãŒå‡ºã‚‹</li>
  <li>ğŸ”—ï¼šURLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãƒ•ãƒ¬ãƒ³ãƒ‰æ‹›å¾…</li>
  <li>ğŸšªï¼šé€€å®¤ï¼ˆè¨˜éŒ²ã‚’å‰Šé™¤ã—ã¦å®‰å…¨ã«é›¢è„±ï¼‰</li>
</ul>
<div style="font-size:12px; color:#6b7280">ãƒ’ãƒ³ãƒˆï¼šä¸Šã®çŒ«ã‚¢ã‚¤ã‚³ãƒ³ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨ã€ä»Šã„ã‚‹å‚åŠ è€…ã®åå‰ã‚’ä¸€æ™‚è¡¨ç¤ºã€‚</div>
<div style="font-size:12px; color:#9ca3af; margin-top:8px">ä½œè€…X: <a href="https://x.com/RARA_vrc" target="_blank" rel="noopener">@RARA_vrc</a></div>
`,
    rcTitle:"æ¥ç¶šãŒåˆ‡ã‚ŒãŸ",
    rcDesc:"ã“ã®ã‚¿ãƒ–ã¯ä¼‘æ†©ä¸­ã€‚ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã¯åº§ã£ã¦æ®‹ã£ã¦ã„ã‚‹ã€‚å†æ¥ç¶šã§å‹•ã‘ã‚‹ã€‚",
    reconnect:"å†æ¥ç¶š", close:"é–‰ã˜ã‚‹",
    namesPrefix:"ã„ã¾ã®å‚åŠ è€…ï¼š"
  },
  en:{
    brand:"Black Cats Plaza",
    help:"Help",
    poseSit:"Sit", poseStand:"Stand",
    anger:"Emote",
    soundOn:"Sound", soundMute:"Muted",
    newRoom:"New", share:"Share", leave:"Leave", clear:"Clear",
    lang:"English", langFlag:"ğŸ‡ºğŸ‡¸",
    joinTitle:"Enter your name",
    joinDesc:"Up to 3 characters. Same URL = same room. A slow, cozy plaza.",
    joinGuide:[
      "ğŸ“¨ Chat: 10 words (English) / 15 chars (nonâ€‘English). Disappears in 60s.",
      "ğŸ“Œ Status: small fixed tag above your cat. Tap ğŸ“Œ again to clear.",
      "ğŸ–‹ï¸ Note: small sticky near your feet. One per person. Updatable. Autoâ€‘clears in 8 hours.",
      "ğŸ–±ï¸ Desktop: drag to pan, doubleâ€‘click to move / ğŸ“± Mobile: drag to pan, doubleâ€‘tap to move, pinch to zoom",
      "Invite friends with ğŸ”— Copy Link"
    ],
    hint:"Drag to pan. Doubleâ€‘tap / doubleâ€‘click to move. Pinch to zoom.",
    helpContent:`
<h3 style="margin:0 0 8px">How to play</h3>
<ul style="margin:6px 0 14px 18px; line-height:1.7; color:#374151; font-size:14px">
  <li>Enter a 3â€‘char name when joining</li>
  <li>Drag to pan, pinch to zoom (0.4â€“2.0)</li>
  <li>Doubleâ€‘tap / doubleâ€‘click to move your cat</li>
  <li>ğŸ“¨: short chat (nonâ€‘EN 15 chars / EN 10 words, autoâ€‘vanish in 60s)</li>
  <li>ğŸ“Œ: fixed tiny status above your head (tap again to clear)</li>
  <li>ğŸ–‹ï¸: note near your feet (1 per user, editable, ğŸ—‘ï¸ clears, autoâ€‘expires in 8h)</li>
  <li>ğŸª‘: toggle sit/stand (autoâ€‘sit when tab is backgrounded)</li>
  <li>ğŸ’¢: quick emote (3s)</li>
  <li>ğŸ†•: create a new room; a banner invites everyone</li>
  <li>ğŸ”—: copy URL to invite friends</li>
  <li>ğŸšª: leave the room safely</li>
</ul>
<div style="font-size:12px; color:#6b7280">Tip: tap the title to see a quick list of participants.</div>
<div style="font-size:12px; color:#9ca3af; margin-top:8px">Author X: <a href="https://x.com/RARA_vrc" target="_blank" rel="noopener">@RARA_vrc</a></div>
`,
    rcTitle:"Disconnected",
    rcDesc:"This tab is resting. Your cat remains seated. Reconnect anytime.",
    reconnect:"Reconnect", close:"Close",
    namesPrefix:"Participants: "
  }
};
let LOCALE = (localStorage.getItem("yuru_lang")||"ja");

/* ===== ã‚µã‚¦ãƒ³ãƒ‰ ===== */
let AC=null, masterGain=null, muted = localStorage.getItem("yuru_mute")==="1";
function unlockAudio(){
  if(!AC){
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(!Ctx) return;
    AC = new Ctx();
    masterGain = AC.createGain();
    masterGain.gain.value = muted ? 0 : 0.24;
    masterGain.connect(AC.destination);
  }
  if(AC && AC.state==="suspended") AC.resume();
}
function setupAudioUnlock(){
  const once=()=>{ unlockAudio(); document.removeEventListener("pointerdown", once); document.removeEventListener("keydown", once); };
  document.addEventListener("pointerdown", once, {passive:true});
  document.addEventListener("keydown", once);
  enterBtn.addEventListener("click", unlockAudio, {once:true});
}
setupAudioUnlock();
function tone({freq=880, dur=0.12, type="sine", vol=0.7, attack=0.005, release=0.12}={}){
  if (!AC) return;
  const osc = AC.createOscillator();
  const g = AC.createGain();
  osc.type = type; osc.frequency.value = freq;
  osc.connect(g); g.connect(masterGain || AC.destination);
  const t = AC.currentTime;
  g.gain.setValueAtTime(0, t);
  g.gain.linearRampToValueAtTime(vol, t + attack);
  g.gain.exponentialRampToValueAtTime(0.0001, t + attack + release);
  osc.start(t);
  osc.stop(t + dur + 0.25);
}
function playLogin(){ if (!muted && AC) { tone({freq:880, type:"triangle", vol:0.55, dur:0.12}); setTimeout(()=> tone({freq:1320, type:"triangle", vol:0.55, dur:0.12}), 140); } }
function playMessage(){ if (!muted && AC) { tone({freq:700, type:"sine", vol:0.5, dur:0.09}); } }
function renderMuteButton(){ document.getElementById("soundIcon").textContent = muted ? "ğŸ”‡" : "ğŸ””"; document.getElementById("lblSound").textContent = muted ? (LOCALE==="ja"?" ãƒŸãƒ¥ãƒ¼ãƒˆ":" Muted") : (LOCALE==="ja"?" éŸ³ã‚ªãƒ³":" Sound"); }
muteBtn.addEventListener("click", ()=>{ muted=!muted; if(masterGain) masterGain.gain.value = muted ? 0 : 0.24; localStorage.setItem("yuru_mute", muted ? "1":"0"); renderMuteButton(); });
renderMuteButton();

/* ===== çŠ¶æ…‹ ===== */
let uid = null;
let me = { name:"", x:0.5, y:0.7, dir:1, pose:"stand", msg:"", msgAt:0, pinMsg:"", pinAt:0, connected:true, idle:false, emo:"none", emoAt:0, lastActive:0 };
let target = {x: me.x, y: me.y};
let lastSync = 0, lastHeartbeat = 0, lastInputAt = Date.now();
let zoom=1, panX=0, panY=0, userPanned=false;
let panning=false, panStartX=0, panStartY=0, dragStartX=0, dragStartY=0;

/* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
const clamp01 = v => Math.max(0, Math.min(1, v));
const escapeHTML = s => s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
const isASCIIish = s => /^[\x00-\x7F]+$/.test(s);
const countWordsASCII = s => s.trim().split(/\s+/).filter(Boolean).length;
function setText(el, html){ el.innerHTML = html; }
function toast(text, ms=90000){ hintText.textContent=text; hint.style.opacity=.95; hint.style.display="flex"; clearTimeout(toast._t); toast._t=setTimeout(()=> hint.style.display="none", ms); }
hintClose.addEventListener("click", ()=>{ hint.style.display="none"; clearTimeout(toast._t); });

function worldSize(){ return { w: world.offsetWidth, h: world.offsetHeight }; }
function applyView(){ worldWrap.style.transform = `translate(${panX}px, ${panY}px) scale(${zoom})`; zoomLabel.textContent = `${Math.round(zoom*100)}%`; }

/* clientåº§æ¨™ -> æ­£è¦åŒ– */
function toNormFromClient(cx,cy){
  const r = play.getBoundingClientRect();
  const {w,h} = worldSize();
  const lx = (cx - r.left - panX)/zoom;
  const ly = (cy - r.top  - panY)/zoom;
  return { x: clamp01(lx / w), y: clamp01(ly / h) };
}
/* æ­£è¦åŒ– -> ç”»é¢pxï¼ˆä¸–ç•Œâ†’ãƒ“ãƒ¥ãƒ¼ï¼‰ */
function toPxLocal(nx,ny){
  const {w,h} = worldSize();
  return { x: panX + nx*w*zoom, y: panY + ny*h*zoom };
}
function pingAt(nx,ny){
  const p = document.createElement("span");
  p.style.cssText="position:absolute;width:10px;height:10px;border-radius:999px;border:2px solid "+getComputedStyle(document.documentElement).getPropertyValue('--accent')+";opacity:.7;pointer-events:none;transform:translate(-50%,-50%) scale(.2);animation:ping .8s ease-out forwards";
  p.style.left = `${toPxLocal(nx,ny).x}px`;
  p.style.top  = `${toPxLocal(nx,ny).y}px`;
  p.className = "ping";
  play.appendChild(p);
  p.addEventListener("animationend", ()=>p.remove());
}

/* ===== è¨€èª ===== */
function applyLang(){
  const T = I18N[LOCALE];
  brandTitle.textContent = T.brand;
  document.getElementById("lblHelp").textContent  = " " + T.help;
  document.getElementById("lblPose").textContent  = " " + (me.pose==="sit" ? T.poseStand : T.poseSit);
  document.getElementById("lblAnger").textContent = " " + T.anger;
  document.getElementById("lblNew").textContent   = " " + T.newRoom;
  document.getElementById("lblShare").textContent = " " + T.share;
  document.getElementById("lblLeave").textContent = " " + T.leave;
  document.getElementById("lblClear").textContent = " " + T.clear;
  document.getElementById("lblLang").textContent  = " " + T.lang;
  document.getElementById("langIcon").textContent = T.langFlag;
  hintText.textContent = T.hint;
  document.getElementById("joinTitle").textContent = T.joinTitle;
  document.getElementById("joinDesc").textContent  = T.joinDesc;
  const g = document.getElementById("joinGuide"); g.innerHTML = T.joinGuide.map(s=>`<div>${s}</div>`).join("");
  document.getElementById("rcTitle").textContent = T.rcTitle;
  document.getElementById("rcDesc").textContent  = T.rcDesc;
  renderMuteButton();
}
applyLang();
langBtn.addEventListener("click", ()=>{
  LOCALE = (LOCALE==="ja"?"en":"ja");
  localStorage.setItem("yuru_lang", LOCALE);
  applyLang();
});

/* ===== Firebase refs ===== */
function playersRefOf(room){ return ref(db, `worlds/${room}/players`); }
function myRef(){ return ref(db, `worlds/${WORLD_ID}/players/${uid}`); }
function notesRefOf(room){ return ref(db, `worlds/${room}/notes`); }
function myNoteRef(){ return ref(db, `worlds/${WORLD_ID}/notes/${uid}`); }
function metaRef(){ return ref(db, `worlds/${WORLD_ID}/meta`); }
const playersRef = playersRefOf(WORLD_ID);
const notesRef = notesRefOf(WORLD_ID);

/* ===== å‚åŠ ãƒ»èªè¨¼ ===== */
nameInput.value = ""; // æ¯å›å…¥åŠ›ã™ã‚‹æ–¹å¼
enterBtn.addEventListener("click", startJoin);
nameInput.addEventListener("keydown", e=>{ if(e.key==="Enter") startJoin(); });

async function startJoin(){
  const n = nameInput.value.trim();
  if([...n].length===0){ warn.textContent = (LOCALE==="ja"?"1ã€œ3æ–‡å­—":"1â€“3 chars"); return; }
  if([...n].length>3){  warn.textContent = (LOCALE==="ja"?"3æ–‡å­—ã¾ã§":"Up to 3 chars"); return; }
  me.name = n;

  // ä¸€æ—¦ã‚µã‚¤ãƒ³ã‚¤ãƒ³
  try{
    await signInAnonymously(auth);
  }catch(e){
    alert("åŒ¿åèªè¨¼ã«å¤±æ•—ã€‚Authenticationè¨­å®šã‚’ç¢ºèªã€‚");
    console.error("[auth] signIn failed:", e);
    return;
  }
}

/* ===== æ¥ç¶šçŠ¶æ…‹ãƒ¢ãƒ‹ã‚¿ï¼ˆ.info/connectedï¼‰ ===== */
const infoConnRef = ref(db, ".info/connected");
onValue(infoConnRef, snap=>{
  const isConn = !!snap.val();
  if(!uid) return;
  if(isConn){
    reconnect.style.display="none";
    safeUpdate({connected:true, lastActive: serverTimestamp(), idle: document.hidden});
  }else{
    reconnect.style.display="flex";
  }
});
reconnectBtn.addEventListener("click", ()=>{ reconnect.style.display="none"; safeUpdate({connected:true, lastActive: serverTimestamp()}); });
reconnectClose.addEventListener("click", ()=> reconnect.style.display="none");

/* ===== onAuth ===== */
onAuthStateChanged(auth, async (user)=>{
  if(!user) return;
  uid = user.uid;

  // å…¥å®¤åˆ¶é™ï¼ˆROOM_CAPï¼‰
  try{
    const snap = await get(playersRef);
    const data = snap.val()||{};
    const now = Date.now();
    const active = Object.values(data).filter(p=>p && p.connected && (now - (p.lastActive||0)) < PARK_GRACE_MS);
    if(active.length >= ROOM_CAP){
      document.getElementById("full").style.display="flex";
      await signOut(auth);
      return;
    }
  }catch(e){ console.warn("room cap check failed:", e); }

  // è‡ªåˆ†ã®åˆæœŸä½ç½®
  me.x = Math.random()*0.8 + 0.1; me.y = Math.random()*0.4 + 0.5; target={x:me.x,y:me.y};
  join.style.display = "none";

  ensureMineDom();
  await mountPresence();
  listenWorld();
  loop();
  toast(I18N[LOCALE].hint, 90000);
});

/* ===== ãƒ—ãƒ¬ã‚¼ãƒ³ã‚¹ ===== */
async function mountPresence(){
  try{
    await set(myRef(), {
      name: me.name, x: me.x, y: me.y, dir: me.dir, pose: me.pose,
      msg: "", msgAt: 0, pinMsg:"", pinAt:0,
      connected: true, idle: false, emo:"none", emoAt:0,
      lastActive: serverTimestamp()
    });
  }catch(e){ console.error("[rtdb] initial set failed:", e); }
  // onDisconnectã¯å‰Šé™¤ã›ãšã€beforeunload ã§æ˜ç¤ºå‰Šé™¤
  window.addEventListener("beforeunload", ()=>{
    try{ navigator.sendBeacon; }catch{}
    // æ˜ç¤ºçš„é›¢è„±æ™‚ã®ã¿å‰Šé™¤ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†/ãƒªãƒ­ãƒ¼ãƒ‰æƒ³å®šï¼‰
    const xhr = new XMLHttpRequest();
    xhr.open("POST", db._repoInfo_.secureToken ? db._repoInfo_.secureToken : "/", false);
  });
}

/* ===== é›¢è„±ï¼ˆå®‰å…¨ã«å‰Šé™¤ï¼‰ ===== */
leaveBtn.addEventListener("click", async ()=>{
  if(!uid) return;
  try{ await set(myRef(), null); }catch(e){ console.warn("leave failed:", e); }
  toast(LOCALE==="ja"?"é€€å®¤ã—ãŸ":"Left the room", 3000);
  location.reload();
});

/* ===== ä¸–ç•Œè³¼èª­ãƒ»æç”» ===== */
const domMap = new Map(); // uid -> dom bundle
let initialPlayersLoaded = false;
let allPlayersData = {};
onValue(playersRef, snap=>{
  const data = snap.val() || {};
  allPlayersData = data;
  const ids = Object.keys(data);
  const now = Date.now();

  // ã‚«ã‚¦ãƒ³ãƒˆï¼šconnected && 6æ™‚é–“ä»¥å†…
  const activeIds = ids.filter(id=> data[id] && data[id].connected && (now - (data[id].lastActive||0)) < PARK_GRACE_MS );
  countDock.textContent = `ğŸˆâ€â¬› ${activeIds.length}`;

  if (initialPlayersLoaded) {
    for (const id of ids) {
      if (!domMap.has(id) && id !== uid) playLogin();
    }
  }

  const seen = new Set(ids);
  for(const id of ids){
    let pdom = domMap.get(id);
    if(!pdom){ pdom = createPlayerDom(id); domMap.set(id, pdom); world.appendChild(pdom.wrap); }
    renderPlayer(pdom, data[id], id===uid);
  }
  for(const [id,pdom] of domMap){ if(!seen.has(id)){ pdom.wrap.remove(); domMap.delete(id); } }

  initialPlayersLoaded = true;
});

function createPlayerDom(id){
  const wrap = document.createElement("div");
  wrap.className = "p";

  const imgStand = document.createElement("img");
  imgStand.className = "catImg stand"; imgStand.src = CAT_STAND_URL; imgStand.alt="cat";
  const imgSit = document.createElement("img");
  imgSit.className = "catImg sit"; imgSit.src = CAT_SIT_URL; imgSit.alt="cat";
  const imgAng = document.createElement("img");
  imgAng.className = "catImg angry"; imgAng.src = CAT_ANGRY_URL; imgAng.alt="angry";

  const nameEl = document.createElement("div"); nameEl.className = "name";
  const bubbleChat = document.createElement("div"); bubbleChat.className = "bubble chat"; bubbleChat.style.display="none";
  const bubblePin  = document.createElement("div"); bubblePin.className  = "bubble pin";  bubblePin.style.display="none";

  wrap.appendChild(nameEl); wrap.appendChild(bubbleChat); wrap.appendChild(bubblePin);
  wrap.appendChild(imgStand); wrap.appendChild(imgSit); wrap.appendChild(imgAng);
  return {wrap, nameEl, bubbleChat, bubblePin, imgStand, imgSit, imgAng, _lastMsgKey:null, _ready:false};
}

function renderPlayer(pdom, data, isSelf){
  if(!data) return;
  const {w,h} = worldSize();
  pdom.wrap.style.left = `${data.x * w}px`;
  pdom.wrap.style.top  = `${data.y * h}px`;

  const nearBottom = data.y > 0.86;
  pdom.nameEl.classList.toggle("flip", nearBottom);
  pdom.bubbleChat.classList.toggle("bump", nearBottom);
  pdom.bubblePin.classList.toggle("bump", nearBottom);

  pdom.nameEl.textContent = data.name || "ãªãªã—";
  pdom.wrap.classList.toggle("sit", data.pose==="sit");
  pdom.imgStand.classList.toggle("right", data.dir===-1);
  pdom.imgSit.classList.toggle("right", data.dir===-1);
  pdom.imgAng.classList.toggle("right", data.dir===-1);
  pdom.wrap.classList.toggle("emo-angry", data.emo==="angry" && (Date.now() - (data.emoAt||0) < EMO_SHOW_MS));
  pdom.wrap.classList.toggle("idle", !!data.idle);
  pdom.wrap.classList.toggle("offline", !data.connected);

  // Chat
  const raw = data.msg || ""; const msgAt = data.msgAt || 0; const key = `${raw}|${msgAt}`;
  if(raw && key !== pdom._lastMsgKey){
    const firstRender = !pdom._ready; pdom._ready = true; pdom._lastMsgKey = key;
    const textEscaped = escapeHTML(raw);
    pdom.bubbleChat.innerHTML = isASCIIish(raw) ? textEscaped : escapeHTML(raw);
    pdom.bubbleChat.style.display = "block";
    const age = typeof msgAt==="number" ? (Date.now()-msgAt) : 0;
    const remain = Math.max(1200, BUBBLE_MS - Math.max(0,age));
    clearTimeout(pdom._chatTimer); pdom._chatTimer = setTimeout(()=>{ pdom.bubbleChat.style.display = "none"; }, remain);
    if (!firstRender && !isSelf) playMessage();
  }else if(!raw){
    pdom.bubbleChat.style.display = "none";
  }

  // Pin
  if(data.pinMsg){
    pdom.bubblePin.textContent = data.pinMsg;
    pdom.bubblePin.style.display = "block";
  }else{
    pdom.bubblePin.style.display = "none";
  }
}

/* ===== Notesï¼ˆæ›¸ãç½®ãï¼‰ ===== */
const noteDom = new Map(); // uid -> el
onValue(notesRef, snap=>{
  const data = snap.val()||{};
  const now = Date.now();
  const {w,h} = worldSize();

  // æ›´æ–°ãƒ»ç”Ÿæˆ
  for(const [id, n] of Object.entries(data)){
    if(!n) continue;
    if(now - (n.updatedAt||0) > NOTE_TTL_MS){ // è¡¨ç¤ºã ã‘æŠ‘åˆ¶ï¼ˆè‡ªå‹•å‰Šé™¤ã¯ã—ãªã„ï¼‰
      const el = noteDom.get(id); if(el){ el.remove(); noteDom.delete(id); }
      continue;
    }
    let el = noteDom.get(id);
    if(!el){
      el = document.createElement("div");
      el.className="noteItem";
      notesLayer.appendChild(el);
      noteDom.set(id, el);
    }
    el.textContent = n.text || "";
    const nearBottom = (n.y||0) > 0.92;
    el.classList.toggle("flip", nearBottom);
    el.style.left = `${(n.x||0)*w}px`;
    el.style.top  = `${(n.y||0)*h}px`;
  }
  // å‰Šé™¤
  for(const [id,el] of noteDom){
    if(!data[id]){ el.remove(); noteDom.delete(id); }
  }
});

noteBtn.addEventListener("click", async ()=>{
  const raw = msgInput.value.trim();
  if(!raw){ toast(LOCALE==="ja"?"æ›¸ãç½®ãã¯ç©ºã§ã™":"Note is empty", 3000); return; }
  const now = Date.now();
  try{
    await set(myNoteRef(), { text: raw.slice(0,100), author: me.name, uid, updatedAt: serverTimestamp(), x: me.x, y: me.y });
    toast(LOCALE==="ja"?"æ›¸ãç½®ãã‚’æ®‹ã—ãŸ":"Note posted", 2000);
  }catch(e){ console.warn("note set failed:", e); toast(LOCALE==="ja"?"æ›¸ãç½®ãã«å¤±æ•—":"Failed to post note", 2500); }
});
noteClearBtn.addEventListener("click", async ()=>{
  try{ await set(myNoteRef(), null); toast(LOCALE==="ja"?"æ›¸ãç½®ãã‚’æ¶ˆã—ãŸ":"Note cleared", 2000); }
  catch(e){ console.warn("note clear failed:", e); toast(LOCALE==="ja"?"æ›¸ãç½®ãå‰Šé™¤ã«å¤±æ•—":"Failed to clear note", 2500); }
});

/* ===== å…¥åŠ›UIï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ ===== */
function validateMessage(raw){
  if(!raw) return {ok:false};
  if(isASCIIish(raw)){ if(countWordsASCII(raw)>10 || raw.length>100) return {ok:false}; }
  else { if(Array.from(raw).length>NON_ASCII_LIMIT) return {ok:false}; }
  return {ok:true};
}
const hintLang = document.getElementById("hintLang");
msgInput.addEventListener("input", ()=>{
  const v = msgInput.value;
  lastInputAt = Date.now();
  if(isASCIIish(v)){ const w=countWordsASCII(v); hintLang.textContent=`è‹±èªï¼š${Math.min(w,10)} / 10 èª`; }
  else { const len=Array.from(v).length; hintLang.textContent=`éè‹±èªï¼š${Math.min(len,NON_ASCII_LIMIT)} / ${NON_ASCII_LIMIT}`; }
  sendBtn.disabled = !validateMessage(v).ok;
});
sendBtn.addEventListener("click", sendMsg);
msgInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMsg(); }});

/* ===== é€ä¿¡ ===== */
let lastSentAt = 0;
function sendMsg(){
  const raw = msgInput.value.trim(); if(!validateMessage(raw).ok) return;
  const nowMs = Date.now(); if(nowMs - lastSentAt < 300) return; lastSentAt = nowMs;
  me.msg = raw; me.msgAt = nowMs; ensureMineDom();
  msgInput.value=""; sendBtn.disabled=true;
  safeUpdate({ msg: raw, msgAt: serverTimestamp() });
}
pinBtn.addEventListener("click", ()=>{
  if(me.pinMsg){ me.pinMsg=""; me.pinAt=0; safeUpdate({pinMsg:"", pinAt:0}); }
  else{
    const raw = msgInput.value.trim(); if(!raw) return;
    me.pinMsg = raw.slice(0,100); me.pinAt = Date.now();
    safeUpdate({pinMsg: me.pinMsg, pinAt: serverTimestamp()});
  }
});

/* ===== ç«‹ã¤/åº§ã‚‹ + å¨åš‡ ===== */
function togglePose(){
  me.pose = (me.pose === "stand") ? "sit" : "stand";
  document.getElementById("lblPose").textContent = " " + (me.pose==="sit" ? I18N[LOCALE].poseStand : I18N[LOCALE].poseSit);
  safeUpdate({pose: me.pose});
}
poseTopBtn.addEventListener("click", togglePose);
window.addEventListener("keydown", e=>{ if(e.key.toLowerCase()==="s"){ togglePose(); }});

angerBtn.addEventListener("click", ()=>{
  me.emo="angry"; me.emoAt=Date.now();
  safeUpdate({emo:"angry", emoAt: serverTimestamp()});
  setTimeout(()=> safeUpdate({emo:"none"}), EMO_SHOW_MS+200);
});

/* ===== æ–°ã—ã„éƒ¨å±‹ ===== */
let migrateTimer=null, migrateUrl=null;
newRoomBtn.addEventListener("click", async ()=>{
  const id = makeRoomId();
  const u = new URL(location.href); u.searchParams.set("room", id);
  migrateUrl = u.toString();
  try{
    await update(metaRef(), { nextRoom: migrateUrl, by: me.name, at: serverTimestamp() });
    showMigrate(migrateUrl);
  }catch(e){ console.warn("meta update failed:", e); }
});
function showMigrate(urlStr){
  document.getElementById("migrateText").textContent = LOCALE==="ja"?"ğŸ†• æ–°ã—ã„éƒ¨å±‹ãŒä½œã‚‰ã‚ŒãŸ":"ğŸ†• New room created";
  document.getElementById("migrate").style.display="flex";
  clearTimeout(migrateTimer); migrateTimer = setTimeout(()=> document.getElementById("migrate").style.display="none", MIGRATE_TTL_MS);
}
document.getElementById("migrateGo").addEventListener("click", ()=>{ if(migrateUrl) location.href=migrateUrl; });
document.getElementById("migrateClose").addEventListener("click", ()=>{ document.getElementById("migrate").style.display="none"; });

onValue(metaRef(), snap=>{
  const m = snap.val()||{};
  if(m && m.nextRoom && typeof m.nextRoom==="string"){ migrateUrl = m.nextRoom; showMigrate(migrateUrl); }
});

/* ===== å…±æœ‰ ===== */
shareBtn.addEventListener("click", async ()=>{
  const invite = new URL(location.href);
  invite.searchParams.set("room", WORLD_ID);
  invite.hash = invite.hash.replace(/room=[^&]+&?/,'').replace(/[#&]$/,'');
  try{
    if(navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(invite.toString());
      toast(LOCALE==="ja"?"URLã‚’ã‚³ãƒ”ãƒ¼ã—ãŸï¼ˆåŒã˜éƒ¨å±‹ã«å…¥ã‚Œã‚‹ï¼‰":"URL copied", 2500);
    }else{
      prompt(LOCALE==="ja"?"ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ã­":"Copy this URL", invite.toString());
    }
  }catch(e){ console.warn("clipboard failed:", e); }
});

/* ===== ãƒ˜ãƒ«ãƒ— ===== */
helpBtn.addEventListener("click", ()=>{
  helpDialog.innerHTML = `<div style="padding:16px 16px 12px; max-width:560px">${I18N[LOCALE].helpContent}<div style="display:flex; gap:8px; justify-content:flex-end"><button class="btn" id="helpClose">${LOCALE==="ja"?"OK":"OK"}</button></div></div>`;
  helpDialog.showModal();
  helpDialog.querySelector("#helpClose").addEventListener("click", ()=> helpDialog.close());
});

/* ===== å‚åŠ è€…åã‚’ä¸€æ™‚è¡¨ç¤º ===== */
brandTitle.addEventListener("click", ()=>{
  const now = Date.now();
  const names = Object.values(allPlayersData).filter(p=>p && p.connected && (now - (p.lastActive||0)) < PARK_GRACE_MS).map(p=>p.name||"ãªãªã—");
  namesPeek.textContent = (I18N[LOCALE].namesPrefix || "") + (names.length? names.join("ãƒ»") : (LOCALE==="ja"?"ï¼ˆãªã—ï¼‰":"(none)"));
  namesPeek.style.display="block"; clearTimeout(namesPeek._t); namesPeek._t = setTimeout(()=> namesPeek.style.display="none", 2500);
});

/* ===== ãƒ‘ãƒ³ãƒ»ã‚ºãƒ¼ãƒ ãƒ»ç§»å‹• ===== */
function setTargetFromClient(cx,cy){
  const pt = toNormFromClient(cx,cy);
  const pxNow = toPxLocal(me.x, me.y).x; const pxNext = toPxLocal(pt.x, pt.y).x;
  target.x=pt.x; target.y=pt.y; me.dir = (pxNext >= pxNow) ? 1 : -1;
  safeUpdate({dir: me.dir}); pingAt(pt.x,pt.y);
}

/* ãƒ‰ãƒ©ãƒƒã‚°ã§ãƒ‘ãƒ³ */
play.addEventListener("pointerdown", e=>{
  if(e.button!==0 && e.buttons!==1) return;
  panning=true; dragStartX=e.clientX; dragStartY=e.clientY; panStartX=panX; panStartY=panY;
  play.classList.add("dragging");
  try{ play.setPointerCapture(e.pointerId); }catch{}
});
play.addEventListener("pointermove", e=>{
  if(!panning) return;
  panX=panStartX + (e.clientX-dragStartX);
  panY=panStartY + (e.clientY-dragStartY);
  userPanned=true; applyView();
});
function endPan(e){ if(!panning) return; panning=false; play.classList.remove("dragging"); try{ play.releasePointerCapture(e.pointerId); }catch{} }
play.addEventListener("pointerup", endPan);
play.addEventListener("pointercancel", endPan);

/* ãƒã‚¦ã‚¹/ãƒšãƒ³ï¼šãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç§»å‹•ï¼ˆå®‰å®šåŒ–ï¼‰ */
let lastClickTime=0, lastClickX=0, lastClickY=0;
play.addEventListener("pointerup", e=>{
  if(e.pointerType!=="mouse" && e.pointerType!=="pen") return;
  const moved=Math.hypot(e.clientX-dragStartX, e.clientY-dragStartY);
  if(moved>4) return;
  const now=Date.now(), dt=now-lastClickTime, dist=Math.hypot(e.clientX-lastClickX, e.clientY-lastClickY);
  if(dt<300 && dist<18){ setTargetFromClient(e.clientX, e.clientY); lastClickTime=0; return; }
  lastClickTime=now; lastClickX=e.clientX; lastClickY=e.clientY;
});

/* ã‚¹ãƒãƒ›ï¼šãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ  */
let gesture=null;
play.addEventListener("touchstart", e=>{
  if(e.touches.length===2){
    e.preventDefault();
    const [a,b]=e.touches; const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY;
    gesture={d:Math.hypot(dx,dy), z:zoom, px:panX, py:panY, cx:(a.clientX+b.clientX)/2, cy:(a.clientY+b.clientY)/2};
  }
},{passive:false});
play.addEventListener("touchmove", e=>{
  if(gesture && e.touches.length===2){
    e.preventDefault();
    const [a,b]=e.touches; const dx=a.clientX-b.clientX, dy=a.clientY-b.clientY; const dist=Math.hypot(dx,dy);
    const nz=Math.max(ZMIN,Math.min(ZMAX, gesture.z*(dist/gesture.d)));
    const worldX=(gesture.cx - gesture.px)/gesture.z, worldY=(gesture.cy - gesture.py)/gesture.z;
    zoom=nz; panX=e.changedTouches[0].clientX - worldX*zoom; panY=e.changedTouches[0].clientY - worldY*zoom; userPanned=true; applyView();
  }
},{passive:false});
play.addEventListener("touchend", e=>{
  if(gesture && e.touches.length===0) { gesture=null; }
},{passive:true});

/* ã‚¹ãƒãƒ›ï¼šãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã§ç§»å‹• */
let lastTapTime=0, lastTapX=0, lastTapY=0;
play.addEventListener("touchend", e=>{
  if(e.touches.length>0) return;
  const t=Date.now(); const touch=e.changedTouches[0]; const x=touch.clientX, y=touch.clientY;
  const dt=t-lastTapTime, dist=Math.hypot(x-lastTapX, y-lastTapY);
  if(dt<300 && dist<24){ setTargetFromClient(x,y); lastTapTime=0; } else { lastTapTime=t; lastTapX=x; lastTapY=y; }
},{passive:true});

/* ãƒ›ã‚¤ãƒ¼ãƒ«ã§ã‚ºãƒ¼ãƒ  */
play.addEventListener("wheel", e=>{
  e.preventDefault();
  const delta = e.deltaY;
  const scale = Math.exp(-delta/600); // ãªã‚ã‚‰ã‹
  const nz = Math.max(ZMIN, Math.min(ZMAX, zoom*scale));
  const r = play.getBoundingClientRect();
  const cx = e.clientX - r.left, cy = e.clientY - r.top;
  const worldX=(cx - panX)/zoom, worldY=(cy - panY)/zoom;
  zoom = nz;
  panX = cx - worldX*zoom; panY = cy - worldY*zoom;
  applyView();
},{passive:false});

/* ã‚ºãƒ¼ãƒ ãƒœã‚¿ãƒ³ */
function zoomTo(nz){
  nz = Math.max(ZMIN, Math.min(ZMAX, nz));
  const r = play.getBoundingClientRect();
  const cx = r.width/2, cy = r.height/2;
  const worldX=(cx - panX)/zoom, worldY=(cy - panY)/zoom;
  zoom = nz; panX = cx - worldX*zoom; panY = cy - worldY*zoom; applyView();
}
zoomInBtn.addEventListener("click", ()=> zoomTo(zoom*1.15));
zoomOutBtn.addEventListener("click",()=> zoomTo(zoom/1.15));

/* ===== ãƒ«ãƒ¼ãƒ— ===== */
let lastT = performance.now();
function loop(){
  const t=performance.now(); const dt=Math.max(0, Math.min(0.05,(t-lastT)/1000)); lastT=t;
  const {w,h} = worldSize();
  const pxPos = toPxLocal(me.x,me.y), pxTarget=toPxLocal(target.x,target.y);
  const dx=pxTarget.x-pxPos.x, dy=pxTarget.y-pxPos.y, dist=Math.hypot(dx,dy);
  const step=SPEED_PX_PER_S*dt;
  if(dist>1){ const nx=pxPos.x+(dx/dist)*step, ny=pxPos.y+(dy/dist)*step; const nn={x: clamp01((nx - panX)/zoom / w), y: clamp01((ny - panY)/zoom / h)}; me.x=nn.x; me.y=nn.y; }
  else { me.x=target.x; me.y=target.y; }

  ensureMineDom();

  // idleåŒ–
  if(Date.now()-lastInputAt > IDLE_MS){ if(!me.idle){ me.idle=true; safeUpdate({idle:true}); } }
  else if(me.idle){ me.idle=false; safeUpdate({idle:false}); }

  // åŒæœŸãƒ»å¿ƒæ‹
  if((t-lastSync)>=80){ safeUpdate({x:me.x, y:me.y}); lastSync=t; }
  if((t-lastHeartbeat)>=HEARTBEAT_MS){ safeUpdate({lastActive: serverTimestamp(), connected:true}); lastHeartbeat=t; }
  requestAnimationFrame(loop);
}

/* ===== è‡ªåˆ†DOM ===== */
function ensureMineDom(){
  if(!uid) return;
  if(!domMap.get(uid)){ const d=createPlayerDom(uid); domMap.set(uid,d); world.appendChild(d.wrap); }
  renderPlayer(domMap.get(uid), me, true);
}

/* ===== å¯è¦–æ€§ï¼ˆèƒŒæ™¯â†’åº§ã‚‹ï¼‰ ===== */
document.addEventListener("visibilitychange", ()=>{
  if(document.hidden){ me.pose="sit"; safeUpdate({pose:"sit", idle:true}); }
  else{ safeUpdate({idle:false, connected:true, lastActive: serverTimestamp()}); }
});

/* ===== æ–°è¦å…¥å®¤æ¼”å‡º ===== */
function spawnBurst(nx,ny){
  for(let i=0;i<8;i++) setTimeout(()=> pingAt(nx,ny), i*60);
}
function afterJoinPing(){ spawnBurst(me.x, me.y); }

/* ===== å®‰å…¨æ›´æ–° ===== */
async function safeUpdate(patch){
  if(!uid) return;
  try{ await update(myRef(), patch); }
  catch(e){ console.error("[rtdb] update failed:", patch, e); }
}

/* ===== åˆæœŸåŒ– ===== */
applyView();
worldLabel.textContent = `room: ${WORLD_ID}`;
helpDialog.addEventListener("close", ()=>{});
hint.addEventListener("transitionend", ()=>{});
document.getElementById("migrate").style.display="none";

/* ===== å‚åŠ ãƒœã‚¿ãƒ³å¾Œã®æ¼”å‡º ===== */
enterBtn.addEventListener("click", ()=> setTimeout(afterJoinPing, 350));
/* å‚åŠ äººæ•°ã‚’ã‚¿ãƒƒãƒ—ã§è¡¨ç¤ºï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã‚‚å¯ï¼‰ */
countDock.addEventListener("click", ()=> brandTitle.click() );
</script>
</body>
</html>
