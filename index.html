<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no, maximum-scale=1">
<title>ã‚†ã‚‹ãƒã‚³ã²ã‚ã°</title>
<meta name="color-scheme" content="light only">

<!-- çŒ«ç”»åƒï¼ˆå·¦å‘ãPNGï¼‰ -->
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png" as="image" crossorigin>
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_sitting.png"  as="image" crossorigin>
<link rel="preload" href="https://raw.githubusercontent.com/RARA-vrc/blackcat/main/angerCAT.png"    as="image" crossorigin>

<style>
  :root{
    --bg:#fffdf9; --panel:#ffffff; --ink:#1a1a1a; --muted:#6b7280;
    --accent:#ff7aa2; --accent-ink:#fff; --border:#e5e7eb;
    --barH:60px; --ring:3px; --ringColor:rgba(255,122,162,.45);
    --pin-bg:#ffe7ef; --pin-bd:#ffc6d7;
    --burstA:#ff7aa2; --burstB:#ffc0d2; --burstInk:#111;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  html,body{height:100%; margin:0; font-family:ui-sans-serif,system-ui,-apple-system,"Hiragino Kaku Gothic ProN",Meiryo,"Segoe UI",Roboto,sans-serif; background:var(--bg); color:var(--ink)}
  body,button,input{touch-action:manipulation}
  #app{position:fixed; inset:0; display:flex; flex-direction:column}

  header{padding: calc(env(safe-area-inset-top) + 4px) 12px 8px; border-bottom:1px solid var(--border); background:var(--panel); position:relative; z-index:3}
  header .row{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; row-gap:6px}
  .brand{display:flex; align-items:center; gap:10px; min-width:0; flex:1 1 260px}
  .brand .catBtn{width:28px; height:28px; border-radius:8px; display:grid; place-items:center; cursor:pointer; border:1px solid var(--border); background:#fff}
  .brand h1{font-size:clamp(14px, 2.6vw, 16px); font-weight:800; margin:0; white-space:nowrap}
  .chip{border:1px solid var(--border); background:#fafafa; border-radius:999px; padding:6px 10px; white-space:nowrap; max-width:50vw; overflow:hidden; text-overflow:ellipsis}
  .meta{display:flex; align-items:center; gap:8px; flex:0 0 auto; flex-wrap:wrap}
  .btn{appearance:none; border:0; background:var(--accent); color:var(--accent-ink); border-radius:12px; padding:10px 12px; font-size:14px; font-weight:800; cursor:pointer; min-height:40px; display:inline-flex; align-items:center; gap:6px; white-space:nowrap; flex:0 0 auto}
  .btn.ghost{background:transparent; color:var(--ink); border:1px solid var(--border)}
  .btn.iconOnly{padding:10px; min-width:44px}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .btn:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  .icon{font-variant-emoji:emoji; font-size:16px}
  .txt{display:inline-block}
  @media (max-width:560px){ .chip{max-width:60vw; font-size:12px} .btn.ghost .txt{display:none} .btn.ghost{padding:10px} }

  #play{
    position:relative; flex:1; overflow:hidden; cursor:crosshair;
    background-image:
      radial-gradient(circle at 1px 1px, #f1f3f5 1px, transparent 0),
      radial-gradient(1200px 420px at 50% 120%, #f7f7f7 0%, transparent 60%);
    background-size:18px 18px, auto; background-position:0 0, 0 0;
    user-select:none; touch-action:none;
  }
  .ping{position:absolute; width:10px; height:10px; border-radius:999px; border:2px solid var(--accent); opacity:.7; pointer-events:none; transform:translate(-50%,-50%) scale(.2); animation:ping .8s ease-out forwards}
  @keyframes ping{80%{opacity:.15; transform:translate(-50%,-50%) scale(2.0)} 100%{opacity:0; transform:translate(-50%,-50%) scale(2.6)}}

  #bar{height:var(--barH); display:flex; align-items:center; gap:8px; border-top:1px solid var(--border); background:var(--panel); padding:8px 10px; padding-bottom:calc(8px + env(safe-area-inset-bottom)); flex-wrap:nowrap; white-space:nowrap; overflow:hidden}
  #msgWrap{flex:1 1 auto; display:flex; align-items:center; gap:8px; min-width:0; overflow:hidden; white-space:nowrap}
  #msg{flex:1 1 auto; min-width:160px; font-size:16px; padding:8px 10px; border:1px solid var(--border); border-radius:12px; outline:none; background:#fff; height:38px; line-height:22px; white-space:nowrap}
  #msg:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  #helper{flex:0 0 auto; display:flex; align-items:center; gap:8px; font-size:12px; color:#6b7280; max-width:34%; overflow:hidden; text-overflow:ellipsis; user-select:none}
  @media (max-width:980px){ #helper{display:none} }

  /* ãƒ¬ã‚¤ãƒ¤ãƒ¼é †ï¼šãƒãƒ£ãƒƒãƒˆ > åæœ­ > ãƒ”ãƒ³ > çŒ« > æ›¸ãç½®ãï¼ˆèƒŒæ™¯ï¼‰ */
  .p{position:absolute; left:0; top:0; transform:translate3d(0,0,0) translate(-50%, -80%); will-change:transform; width:78px; height:78px; z-index:10}
  .catImg{width:78px; height:78px; display:block; object-fit:contain; pointer-events:none; transition:transform .18s ease; position:relative; z-index:0}
  .catImg.right{transform:scaleX(-1)}
  .catImg.sit{display:none}
  .catImg.angry{display:none}
  .sit .catImg.stand{display:none}
  .sit .catImg.sit{display:block}
  .emo-angry .catImg.stand, .emo-angry .catImg.sit{display:none}
  .emo-angry .catImg.angry{display:block}

  .name{position:absolute; left:50%; top:78px; transform:translateX(-50%); background:rgba(17,17,17,.95); color:#fff; font-size:12px; padding:2px 8px; border-radius:999px; white-space:nowrap; max-width:180px; text-overflow:ellipsis; overflow:hidden; letter-spacing:.2px; border:1px solid rgba(0,0,0,.6); z-index:20; pointer-events:none; will-change:transform}
  .name.flip{top:auto; bottom:84px}

  .bubble{position:absolute; left:50%; transform:translateX(-50%); background:#fff; color:#111; border:1px solid var(--border); border-radius:12px; padding:8px 10px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:min(86vw, 520px); box-shadow:0 8px 22px rgba(0,0,0,.06); pointer-events:none; display:none}
  .bubble.chat{bottom:94px; font-size:14px; z-index:30}
  .bubble.pin {bottom:122px; background:var(--pin-bg); border-color:var(--pin-bd); font-size:0.66em; padding:6px 9px; z-index:10}
  .bubble.chat.bump{bottom:148px}
  .bubble.pin.bump {bottom:182px}

  #notesLayer{position:absolute; inset:0; pointer-events:none; z-index:0}
  .noteItem{position:absolute; transform:translate3d(0,0,0) translate(-50%, -120%); background:var(--pin-bg); border:1px solid var(--pin-bd); border-radius:10px; padding:4px 6px; font-size:0.5rem; color:#111; white-space:nowrap; text-overflow:ellipsis; overflow:hidden; max-width:50vw; box-shadow:0 4px 12px rgba(0,0,0,.06)}
  .noteItem.flip{ transform:translate3d(0,0,0) translate(-50%, 18px) }

  /* å…¥å®¤ãƒ¯ãƒ¼ãƒ—æ¼”å‡º */
  .join-burst{position:absolute; left:0; top:0; pointer-events:none; width:0; height:0; z-index:5}
  .join-burst .ring{position:absolute; left:0; top:0; width:12px; height:12px; border:2px solid var(--burstA); border-radius:999px; transform:translate(-50%,-50%) scale(.3); opacity:.8; animation:joinRing .9s cubic-bezier(.2,.8,.2,1) forwards}
  @keyframes joinRing{
    60%{ box-shadow:0 0 32px rgba(255,122,162,.45); }
    100%{ transform:translate(-50%,-50%) scale(9.5); opacity:0; box-shadow:0 0 0 rgba(0,0,0,0); }
  }
  .join-burst .spark{position:absolute; left:0; top:0; width:6px; height:6px; background:radial-gradient(circle at 30% 30%, #fff 0, #fff 18%, var(--burstB) 19%, var(--burstA) 100%); border-radius:50%; transform:translate(-50%,-50%); opacity:.95; animation:joinSpark .9s ease-out forwards}
  @keyframes joinSpark{
    to{ transform:translate(var(--dx), var(--dy)); opacity:0; }
  }
  .p.warp{ animation:warpIn .48s cubic-bezier(.2,.8,.2,1) both }
  @keyframes warpIn{
    0%{ transform:translate3d(var(--px), var(--py), 0) translate(-50%,-80%) scale(.9); filter:drop-shadow(0 0 0 rgba(255,122,162,0)); }
    60%{ filter:drop-shadow(0 0 18px rgba(255,122,162,.45)); }
    100%{ transform:translate3d(var(--px), var(--py), 0) translate(-50%,-80%) scale(1); filter:none; }
  }

  #namesPeek{position:fixed; left:50%; top:calc(8px + env(safe-area-inset-top)); transform:translateX(-50%); z-index:5; background:rgba(0,0,0,.8); color:#fff; font-size:13px; border-radius:12px; padding:8px 10px; max-width:90vw; white-space:normal; display:none}
  #migrate{position:fixed; left:50%; top:64px; transform:translateX(-50%); z-index:50; background:#111; color:#fff; border-radius:12px; padding:10px 12px; font-size:14px; display:none}
  #migrate button{margin-left:8px; border:0; background:#fff; color:#111; font-weight:800; padding:6px 10px; border-radius:10px; cursor:pointer}

  #join{position:fixed; inset:0; background:rgba(255,255,255,.9); display:flex; align-items:center; justify-content:center; z-index:100}
  #join .card{width:min(92vw,520px); border:1px solid var(--border); border-radius:18px; background:#fff; padding:18px 16px 16px; box-shadow:0 18px 60px rgba(0,0,0,.08)}
  #join h2{margin:0 0 8px; font-size:18px}
  #join p{margin:0 0 12px; font-size:14px; color:#555; line-height:1.6}
  #join .row{display:flex; gap:10px}
  #join input{flex:1; font-size:18px; padding:12px 12px; border:1px solid var(--border); border-radius:12px; outline:none; background:#fff}
  #join input:focus-visible{outline:var(--ring) solid var(--ringColor); outline-offset:2px}
  #join button{padding:12px 14px; border-radius:12px; background:var(--accent); color:#fff; font-weight:800; font-size:16px; border:0; cursor:pointer; white-space:nowrap}
  #warn{color:#b40000; font-size:13px; min-height:1.4em}
  .subtle{font-size:12px; color:#6b7280}

  #hint{position:fixed; right:10px; bottom:calc(var(--barH) + 10px + env(safe-area-inset-bottom)); background:#000; color:#fff; font-size:12px; padding:8px 10px; border-radius:10px; opacity:.85; z-index:4}
  #full{position:fixed; inset:0; background:rgba(255,255,255,.9); display:none; align-items:center; justify-content:center; z-index:200}
  #full .card{width:min(92vw,520px); border:1px solid var(--border); border-radius:18px; background:#fff; padding:18px 16px 16px; box-shadow:0 18px 60px rgba(0,0,0,.08)}

  @media (prefers-reduced-motion: reduce){
    .p{transition:none}
    .join-burst{display:none}
    .p.warp{animation:none}
    .ping{animation:none; display:none}
  }
</style>
</head>
<body>
<div id="app">
  <header>
    <div class="row">
      <div class="brand">
        <div id="playersBtn" class="catBtn" role="button" tabindex="0" title="ã„ã¾ã®åå‰ä¸€è¦§">ğŸˆâ€â¬›</div>
        <h1 id="brandTitle">ã‚†ã‚‹ãƒã‚³ã²ã‚ã°</h1>
        <span class="chip" id="worldLabel" aria-live="polite"></span>
        <span class="chip" id="countLabel" aria-live="polite" title="ã„ã¾ã„ã‚‹ãƒã‚³ã®æ•°">ğŸˆâ€â¬› 0</span>
      </div>
      <div class="meta">
        <button id="poseTopBtn"   class="btn ghost" title="ç«‹ã¤/åº§ã‚‹"><span class="icon" aria-hidden="true">ğŸª‘</span><span class="txt" id="lblPose"> åº§ã‚‹</span></button>
        <button id="angerBtn"     class="btn ghost" title="å¨åš‡"><span class="icon" aria-hidden="true">ğŸ’¢</span><span class="txt" id="lblAnger"> å¨åš‡</span></button>
        <button id="muteBtn"      class="btn ghost" title="éŸ³ã®ã‚ªãƒ³/ã‚ªãƒ•"><span class="icon" aria-hidden="true">ğŸ””</span><span class="txt" id="lblSound"> éŸ³ã‚ªãƒ³</span></button>
        <button id="newRoomBtn"   class="btn ghost" title="æ–°ã—ã„éƒ¨å±‹ã‚’ä½œã‚‹"><span class="icon" aria-hidden="true">ğŸ†•</span><span class="txt" id="lblNew"> æ–°éƒ¨å±‹</span></button>
        <button id="shareBtn"     class="btn ghost" title="URLã‚’ã‚³ãƒ”ãƒ¼"><span class="icon" aria-hidden="true">ğŸ”—</span><span class="txt" id="lblShare"> å…±æœ‰</span></button>
        <button id="noteClearBtn" class="btn ghost" title="è‡ªåˆ†ã®æ›¸ãç½®ãã‚’æ¶ˆã™"><span class="icon" aria-hidden="true">ğŸ—‘ï¸</span><span class="txt" id="lblClear"> ã‚¯ãƒªã‚¢</span></button>
        <button id="helpBtn"      class="btn ghost" title="ä½¿ã„æ–¹"><span class="icon" aria-hidden="true">â”</span><span class="txt" id="lblHelp"> ãƒ˜ãƒ«ãƒ—</span></button>
        <button id="langBtn"      class="btn ghost" title="è¨€èªåˆ‡æ›¿"><span class="icon" aria-hidden="true" id="langIcon">ğŸ‡¯ğŸ‡µ</span><span class="txt" id="lblLang"> æ—¥æœ¬èª</span></button>
      </div>
    </div>
  </header>

  <div id="play" aria-label="play-area">
    <div id="notesLayer"></div>
  </div>

  <div id="bar">
    <div id="msgWrap">
      <input id="msg" type="text" inputmode="text" autocomplete="off" placeholder="(15æ–‡å­— / 10 words)" aria-label="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å…¥åŠ›">
      <div id="helper"><span id="hintLang">éè‹±èªï¼š0/15</span><span aria-hidden="true" id="hintKeys">Enteré€ä¿¡ / Sã§åº§ã‚‹</span></div>
    </div>
    <button id="pinBtn"  class="btn iconOnly" title="ãƒ”ãƒ³ç•™ã‚"><span class="icon" aria-hidden="true">ğŸ“Œ</span></button>
    <button id="noteBtn" class="btn iconOnly" title="æ›¸ãç½®ã"><span class="icon" aria-hidden="true">ğŸ–‹ï¸</span></button>
    <button id="send"    class="btn iconOnly" disabled title="é€ä¿¡"><span class="icon" aria-hidden="true">ğŸ“¨</span></button>
  </div>

  <div id="hint" aria-live="polite">ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã§è‡ªåˆ†ã®çŒ«ãŒã‚†ã£ãã‚Šç§»å‹•</div>
</div>

<div id="namesPeek" aria-live="polite"></div>
<div id="migrate" role="alert"><span id="migrateText">ğŸ†• æ–°ã—ã„éƒ¨å±‹ãŒä½œã‚‰ã‚ŒãŸ</span><button id="migrateGo">ç§»å‹•</button></div>

<!-- Joinï¼ˆæ¯å›ç©ºæ¬„ï¼‰ -->
<div id="join" role="dialog" aria-modal="true" aria-label="åå‰å…¥åŠ›">
  <div class="card">
    <h2 id="joinTitle">åå‰ã‚’å…¥ã‚Œã¦å‚åŠ </h2>
    <p id="joinDesc">åå‰ã¯3æ–‡å­—ã¾ã§ã€‚URLãŒåŒã˜ãªã‚‰åŒã˜éƒ¨å±‹ã€‚è½ã¡ç€ã„ã¦éŠã¶å ´ã€‚</p>
    <div class="row">
      <input id="nameInput" maxlength="3" aria-label="åå‰ï¼ˆ3æ–‡å­—ã¾ã§ï¼‰">
      <button id="enterBtn">ã¯ã˜ã‚ã‚‹</button>
    </div>
    <div id="warn" role="status" aria-live="polite"></div>
    <p class="subtle" id="joinHint">éŸ³ãŒå‡ºãªã„ã¨ãã¯ä¸€åº¦ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰ãƒŸãƒ¥ãƒ¼ãƒˆã‚’ç¢ºã‹ã‚ã‚‹ã€‚</p>
  </div>
</div>

<dialog id="helpDialog"></dialog>
<div id="full" style="display:none"></div>

<script type="module">
/* ========= ç”»åƒURL ========= */
const CAT_STAND_URL = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_standing.png";
const CAT_SIT_URL   = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/CAT_sitting.png";
const CAT_ANGRY_URL = "https://raw.githubusercontent.com/RARA-vrc/blackcat/main/angerCAT.png";

/* ========= è¨­å®š ========= */
const NOTE_TTL_MS = 8*60*60*1000;   // 8æ™‚é–“
const EMO_SHOW_MS = 3000;
const ROOM_CAP    = 10;

/* ========= i18n ========= */
const I18N = {
  ja:{
    brand:"ã‚†ã‚‹ãƒã‚³ã²ã‚ã°",
    roomCount:(n)=>`ğŸˆâ€â¬› ${n}`,
    namesPeek:(list)=>`ã„ã¾ã®å‚åŠ è€…ï¼š ${list}`,
    poseSit:"åº§ã‚‹", poseStand:"ç«‹ã¤",
    anger:"å¨åš‡",
    soundOn:"éŸ³ã‚ªãƒ³", soundMute:"ãƒŸãƒ¥ãƒ¼ãƒˆ",
    newRoom:"æ–°éƒ¨å±‹", share:"å…±æœ‰", clear:"ã‚¯ãƒªã‚¢", help:"ãƒ˜ãƒ«ãƒ—", lang:"æ—¥æœ¬èª",
    msgPlaceholder:"(15æ–‡å­— / 10 words)",
    hintKeys:"Enterã§é€ä¿¡  Sã§åº§ã‚‹",
    helperASCII:(w)=>`è‹±èªï¼š${w}/10`,
    helperCJK:(n)=>`éè‹±èªï¼š${n}/15`,
    hint:"ç”»é¢ã‚’ã‚¿ãƒƒãƒ—ã§è‡ªåˆ†ã®çŒ«ãŒã‚†ã£ãã‚Šç§»å‹•",

    helpHtml:`<h3 style="margin:0 0 8px">ä½¿ã„æ–¹</h3>
      <ul style="margin:0 0 12px 18px; line-height:1.7; color:#374151; font-size:14px">
        <li>ã‚¿ãƒƒãƒ—ã‚„ã‚¯ãƒªãƒƒã‚¯ã§ãã®å ´æ‰€ã¸ç§»å‹•ã™ã‚‹ã€‚å‹•ãã¯ã‚†ã£ãŸã‚Š</li>
        <li>å…¥åŠ›æ¬„ã¯ä¸€è¡Œã€‚Enterã§é€ä¿¡ã€‚è‹±èªã¯10èªã¾ã§ã€‚éè‹±èªã¯15æ–‡å­—ã¾ã§</li>
        <li>ä¸€èˆ¬ãƒãƒ£ãƒƒãƒˆã¯60ç§’ã§æ¶ˆãˆã‚‹</li>
        <li>ğŸª‘ã§ç«‹ã¤ã¨åº§ã‚‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã€‚Sã‚­ãƒ¼ã§ã‚‚åˆ‡ã‚Šæ›¿ãˆ</li>
        <li>ğŸ’¢ã§å¨åš‡ã€‚è¡¨ç¤ºã¯3ç§’</li>
        <li>ğŸ“Œã¯é ­ä¸Šã«å›ºå®šã€‚å°ã•ã‚ã§æ·¡ã„ãƒ”ãƒ³ã‚¯ã€‚ã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨å¤–ã‚Œã‚‹</li>
        <li>ğŸ–‹ï¸ã¯æ›¸ãç½®ãã€‚çŒ«ã®ã„ãŸå ´æ‰€ã«å°ã•ãæ®‹ã‚‹ã€‚1äºº1ä»¶ã€‚æ›´æ–°ã§ãã‚‹ã€‚8æ™‚é–“ã§è‡ªå‹•å‰Šé™¤ã€‚ğŸ—‘ï¸ã§æ¶ˆã›ã‚‹</li>
        <li>ğŸˆâ€â¬›ã‚’æŠ¼ã™ã¨å‚åŠ è€…ã®åå‰ã‚’çŸ­ãè¡¨ç¤º</li>
        <li>ğŸ”—ã§URLã‚’ã‚³ãƒ”ãƒ¼ã€‚åŒã˜URLã¯åŒã˜éƒ¨å±‹</li>
        <li>ğŸ†•ã§æ–°ã—ã„éƒ¨å±‹ã‚’ä½œã‚‹ã€‚å…¨å“¡ã«ç§»å‹•ãƒãƒŠãƒ¼ãŒå‡ºã‚‹</li>
        <li>éƒ¨å±‹ã¯æœ€å¤§10äºº</li>
        <li>åå‰ã¯3æ–‡å­—ã¾ã§ã€‚ç¯€åº¦ã‚ã‚‹è¨€è‘‰ã§éŠã¶</li>
      </ul>`,

    notify:{
      join:(n)=>`${n} ãŒå…¥å®¤ã—ãŸ`,
      leave:(n)=>`${n} ãŒé€€å®¤ã—ãŸ`,
      pinOn:"ãƒ”ãƒ³ã‚’å›ºå®šã—ãŸ",
      pinOff:"ãƒ”ãƒ³ã‚’å¤–ã—ãŸ",
      noteSaved:"æ›¸ãç½®ãã‚’æ®‹ã—ãŸ",
      noteUpdated:"æ›¸ãç½®ãã‚’æ›´æ–°ã—ãŸ",
      noteCleared:"æ›¸ãç½®ãã‚’æ¶ˆã—ãŸ",
      urlCopied:"URLã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã€‚åŒã˜éƒ¨å±‹ã«å…¥ã‚Œã‚‹",
      newRoomBy:(n)=>`${n} ãŒæ–°ã—ã„éƒ¨å±‹ã‚’ä½œæˆ`,
      full:"æº€å“¡ã ã€‚10äººã¾ã§",
      online:"ã‚ªãƒ³ãƒ©ã‚¤ãƒ³",
      offline:"ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã€‚å†æ¥ç¶šå¾…ã¡",
      errorAuth:"èªè¨¼ã‚¨ãƒ©ãƒ¼ã€‚ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‹è¨­å®šã‚’ç¢ºèª"
    }
  },
  en:{
    brand:"Yuru Neko Plaza",
    roomCount:(n)=>`ğŸˆâ€â¬› ${n}`,
    namesPeek:(list)=>`Now here: ${list}`,
    poseSit:"Sit", poseStand:"Stand",
    anger:"Anger",
    soundOn:"Sound On", soundMute:"Muted",
    newRoom:"New Room", share:"Share", clear:"Clear", help:"Help", lang:"English",
    msgPlaceholder:"(15 chars / 10 words)",
    hintKeys:"Enter to send  S to sit",
    helperASCII:(w)=>`EN: ${w}/10`,
    helperCJK:(n)=>`Nonâ€‘EN: ${n}/15`,
    hint:"Tap to move your cat slowly",

    helpHtml:`<h3 style="margin:0 0 8px">How to play</h3>
      <ul style="margin:0 0 12px 18px; line-height:1.7; color:#374151; font-size:14px">
        <li>Tap or click to move. Motion stays calm</li>
        <li>Oneâ€‘line input. Press Enter to send. English up to 10 words. Nonâ€‘English up to 15 characters</li>
        <li>Regular chat fades in 60 seconds</li>
        <li>ğŸª‘ toggles stand and sit. S key also works</li>
        <li>ğŸ’¢ shows an anger emote for 3 seconds</li>
        <li>ğŸ“Œ pins a small message above your cat. Press again to remove</li>
        <li>ğŸ–‹ï¸ leaves a tiny note at your catâ€™s position. One per person. Editable. Autoâ€‘deletes after 8 hours. Use ğŸ—‘ï¸ to clear</li>
        <li>Press ğŸˆâ€â¬› to show names for a moment</li>
        <li>ğŸ”— copies the URL. Same URL joins the same room</li>
        <li>ğŸ†• creates a new room and shows a migrate banner to everyone</li>
        <li>Up to 10 people in a room</li>
        <li>Names up to 3 characters. Keep it friendly</li>
      </ul>`,

    notify:{
      join:(n)=>`${n} joined`,
      leave:(n)=>`${n} left`,
      pinOn:"Pinned",
      pinOff:"Unpinned",
      noteSaved:"Left a note",
      noteUpdated:"Updated the note",
      noteCleared:"Cleared the note",
      urlCopied:"URL copied. Same URL joins this room",
      newRoomBy:(n)=>`${n} created a new room`,
      full:"Room is full. Max 10",
      online:"Online",
      offline:"Offline. Waiting to reconnect",
      errorAuth:"Auth error. Check network or settings"
    }
  }
};
let LANG = localStorage.getItem("yuru_lang") || "ja";

/* ========= Firebase ========= */
const firebaseConfig = {
  apiKey:"AIzaSyCUpt4XLfSSZLt0VhJon926--c-I2tRMkE",
  authDomain:"blackcat-67716.firebaseapp.com",
  databaseURL:"https://blackcat-67716-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"blackcat-67716",
  storageBucket:"blackcat-67716.appspot.com",
  messagingSenderId:"124690483795",
  appId:"1:124690483795:web:73b5b2ba28f4e4d503d4a6",
  measurementId:"G-R47HW00266"
};

/* ========= ãƒ«ãƒ¼ãƒ ID ========= */
const url=new URL(location.href);
const qp=url.searchParams.get("room");
const hp=(location.hash.match(/room=([^&]+)/)||[])[1];
function makeRoomId(){ const t=Date.now().toString(36).slice(-6); const r=crypto.getRandomValues(new Uint32Array(1))[0].toString(36).slice(-5); return `plaza-${t}-${r}`; }
function setURLRoom(id){ const u=new URL(location.href); u.searchParams.set("room",id); u.hash=u.hash.replace(/room=[^&]+&?/,'').replace(/[#&]$/,''); history.replaceState({}, "", u.toString()); }
let WORLD_ID=qp||hp||null; if(!WORLD_ID){ WORLD_ID=makeRoomId(); setURLRoom(WORLD_ID); }

/* ========= Firebase SDK ========= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, onValue, set, update, serverTimestamp, onDisconnect, get, remove }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
import { getAuth, signInAnonymously, onAuthStateChanged }
  from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);
const auth=getAuth(app);

/* ========= DOM ========= */
const play=document.getElementById("play");
const notesLayer=document.getElementById("notesLayer");
const bar=document.getElementById("bar");
const msgInput=document.getElementById("msg");
const sendBtn=document.getElementById("send");
const pinBtn=document.getElementById("pinBtn");
const noteBtn=document.getElementById("noteBtn");
const noteClearBtn=document.getElementById("noteClearBtn");
const poseTopBtn=document.getElementById("poseTopBtn");
const angerBtn=document.getElementById("angerBtn");
const join=document.getElementById("join");
const nameInput=document.getElementById("nameInput");
const enterBtn=document.getElementById("enterBtn");
const warn=document.getElementById("warn");
const worldLabel=document.getElementById("worldLabel");
const countLabel=document.getElementById("countLabel");
const shareBtn=document.getElementById("shareBtn");
const helpBtn=document.getElementById("helpBtn");
const helpDialog=document.getElementById("helpDialog");
const hintLang=document.getElementById("hintLang");
const hintKeys=document.getElementById("hintKeys");
const muteBtn=document.getElementById("muteBtn");
const playersBtn=document.getElementById("playersBtn");
const namesPeek=document.getElementById("namesPeek");
const full=document.getElementById("full");
const newRoomBtn=document.getElementById("newRoomBtn");
const migrate=document.getElementById("migrate");
const migrateText=document.getElementById("migrateText");
const migrateGo=document.getElementById("migrateGo");
const langBtn=document.getElementById("langBtn");
const brandTitle=document.getElementById("brandTitle");
const langIcon=document.getElementById("langIcon");
const lblPose=document.getElementById("lblPose");
const lblAnger=document.getElementById("lblAnger");
const lblSound=document.getElementById("lblSound");
const lblNew=document.getElementById("lblNew");
const lblShare=document.getElementById("lblShare");
const lblClear=document.getElementById("lblClear");
const lblHelp=document.getElementById("lblHelp");
const lblLang=document.getElementById("lblLang");
const joinTitle=document.getElementById("joinTitle");
const joinDesc=document.getElementById("joinDesc");
const joinHint=document.getElementById("joinHint");

worldLabel.textContent=`room: ${WORLD_ID}`;
countLabel.textContent=I18N[LANG].roomCount(0);

/* ========= ã‚µã‚¦ãƒ³ãƒ‰ ========= */
let AC=null, masterGain=null; let muted=localStorage.getItem("yuru_mute")==="1";
function unlockAudio(){ if(!AC){ const Ctx=window.AudioContext||window.webkitAudioContext; if(!Ctx) return; AC=new Ctx(); masterGain=AC.createGain(); masterGain.gain.value=muted?0:0.24; masterGain.connect(AC.destination); } if(AC&&AC.state==="suspended") AC.resume(); }
function setupAudioUnlock(){ const once=()=>{unlockAudio(); document.removeEventListener("pointerdown", once); document.removeEventListener("keydown", once);}; document.addEventListener("pointerdown", once, {passive:true}); document.addEventListener("keydown", once); enterBtn.addEventListener("click", unlockAudio, {once:true}); } setupAudioUnlock();
function tone({freq=880,dur=0.12,type="sine",vol=0.7,attack=0.005,release=0.12}={}){ if(!AC) return; const osc=AC.createOscillator(); const g=AC.createGain(); osc.type=type; osc.frequency.value=freq; osc.connect(g); g.connect(masterGain||AC.destination); const t=AC.currentTime; g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+attack); g.gain.exponentialRampToValueAtTime(0.0001,t+attack+release); osc.start(t); osc.stop(t+dur+0.25); }
function playLogin(){ if(!muted&&AC){ tone({freq:880,type:"triangle",vol:0.55,dur:0.12}); setTimeout(()=>tone({freq:1320,type:"triangle",vol:0.55,dur:0.12}),140); } }
function playMessage(){ if(!muted&&AC){ tone({freq:700,type:"sine",vol:0.5,dur:0.09}); } }
function renderMuteButton(){ lblSound.textContent = muted ? I18N[LANG].soundMute : I18N[LANG].soundOn; }
muteBtn.addEventListener("click", ()=>{ muted=!muted; if(masterGain) masterGain.gain.value=muted?0:0.24; localStorage.setItem("yuru_mute", muted?"1":"0"); renderMuteButton(); });

/* ========= çŠ¶æ…‹ ========= */
const lastShownName=new Map();
let hasOwnNote=false;

let uid=null;
let joined=false;
let mounted=false;

let me={ name:"", x:0.5, y:0.7, dir:1, pose:"stand", msg:"", msgAt:0, pinMsg:"", emo:"none", emoAt:0 };
let target={x:me.x,y:me.y};
let lastSync=0, lastHeartbeat=0;
const SYNC_INTERVAL_MS=80, HEARTBEAT_MS=15000, BUBBLE_MS=60000, NON_ASCII_LIMIT=15;

/* ========= util ========= */
const now = ()=>performance.now();
const clamp01=v=>Math.max(0,Math.min(1,v));
const isASCIIish=s=>/^[\x00-\x7F]+$/.test(s);
const countWordsASCII=s=>s.trim().split(/\s+/).filter(Boolean).length;
function getPlayRect(){ const r=play.getBoundingClientRect(); return (r.width<=0||r.height<=0)?null:r; }
function toNorm(cx,cy){ const r=getPlayRect(); if(!r) return {x:target.x,y:target.y}; return {x:clamp01((cx-r.left)/r.width), y:clamp01((cy-r.top)/r.height)}; }
function toPx(nx,ny){ const r=getPlayRect(); if(!r) return {x:0,y:0}; return {x:nx*r.width, y:ny*r.height}; }
function roundPx(v){ return Math.round(v); }
function pingAt(nx,ny){ const r=getPlayRect(); if(!r) return; const {x,y}=toPx(nx,ny); const s=document.createElement("span"); s.className="ping"; s.style.left=`${x}px`; s.style.top=`${y}px`; play.appendChild(s); s.addEventListener("animationend",()=>s.remove()); }
function toast(text){ const el=document.getElementById("hint"); el.textContent=text; el.style.opacity=.95; clearTimeout(toast._t); toast._t=setTimeout(()=> el.style.opacity=.85,1500); }
function normalizeName(s){ if(typeof s!=="string") return ""; const t=s.trim(); return t.length?Array.from(t).slice(0,3).join(""):""; }
function resolveLabelName(userId, incoming){ const prev=lastShownName.get(userId)||""; const n=normalizeName(incoming); if(n){ lastShownName.set(userId,n); return n; } if(prev){ return prev; } const fb="ãªãªã—"; lastShownName.set(userId, fb); return fb; }

/* ========= Refs ========= */
function playersRefOf(room){ return ref(db, `worlds/${room}/players`); }
function myRef(){ return ref(db, `worlds/${WORLD_ID}/players/${uid}`); }
function notesRootRef(){ return ref(db, `worlds/${WORLD_ID}/notes`); }
function noteRefOf(u){ return ref(db, `worlds/${WORLD_ID}/notes/${u}`); }
function metaRef(){ return ref(db, `worlds/${WORLD_ID}/meta`); }
const playersRef=playersRefOf(WORLD_ID);

/* ========= i18n é©ç”¨ ========= */
function applyLang(){
  const T=I18N[LANG];
  document.documentElement.lang = (LANG==="ja"?"ja":"en");
  brandTitle.textContent=T.brand;
  countLabel.textContent=T.roomCount((latestPlayers && Object.keys(latestPlayers).length)||0);
  lblPose.textContent = me.pose==="stand" ? ` ${T.poseSit}` : ` ${T.poseStand}`;
  lblAnger.textContent=` ${T.anger}`;
  renderMuteButton();
  lblNew.textContent=` ${T.newRoom}`;
  lblShare.textContent=` ${T.share}`;
  lblClear.textContent=` ${T.clear}`;
  lblHelp.textContent=` ${T.help}`;
  lblLang.textContent=` ${T.lang}`;
  langIcon.textContent = (LANG==="ja"?"ğŸ‡¯ğŸ‡µ":"ğŸ‡ºğŸ‡¸");
  msgInput.placeholder=T.msgPlaceholder;
  hintKeys.textContent=T.hintKeys;
  document.getElementById("hint").textContent=T.hint;
  joinTitle.textContent = T.joinTitle;
  joinDesc.innerHTML   = T.joinDesc;
  enterBtn.textContent = T.joinStart || "ã¯ã˜ã‚ã‚‹";
  joinHint.textContent = T.joinHint;
  const v=msgInput.value;
  if(isASCIIish(v)){ hintLang.textContent=T.helperASCII(Math.min(countWordsASCII(v),10)); }
  else{ hintLang.textContent=T.helperCJK(Math.min(Array.from(v).length, NON_ASCII_LIMIT)); }
}
langBtn.addEventListener("click", ()=>{ LANG=(LANG==="ja")?"en":"ja"; localStorage.setItem("yuru_lang", LANG); applyLang(); });

/* ========= å‚åŠ ï¼ˆæ¯å›ç©ºæ¬„ã‹ã‚‰ï¼‰ ========= */
nameInput.addEventListener("input", ()=>{ const n=nameInput.value.trim(); if([...n].length>3) nameInput.value = Array.from(n).slice(0,3).join(""); });
enterBtn.addEventListener("click", startJoin);
nameInput.addEventListener("keydown", e=>{ if(e.key==="Enter") startJoin(); });

async function startJoin(){
  const n=normalizeName(nameInput.value);
  if(!n){ warn.textContent=LANG==="ja"?"1ã€œ3æ–‡å­—":"1â€“3 chars"; return; }
  warn.textContent="";
  me.name=n; joined=true; me.pose="stand"; me.pinMsg="";
  join.style.display="none";
  if(uid && !mounted){ await initAfterAuth(); }
}

/* ========= åŒ¿åãƒ­ã‚°ã‚¤ãƒ³ï¼ˆèµ·å‹•ç›´å¾Œï¼‰ ========= */
initAuthOnBoot();
async function initAuthOnBoot(){
  try{ await signInAnonymously(auth); }
  catch(e){ console.error("[auth] signInAnonymously failed:", e); toast(I18N[LANG].notify.errorAuth); }
}
onAuthStateChanged(auth, async user=>{
  if(!user) return;
  uid=user.uid;
  if(joined && !mounted){ await initAfterAuth(); }
});

/* ========= åˆæœŸåŒ– ========= */
async function initAfterAuth(){
  me.x=Math.random()*0.8+0.1; me.y=Math.random()*0.4+0.5; target={x:me.x,y:me.y};
  ensureMineDom();
  const ok=await ensureCapacity(); if(!ok){ showFull(); return; }
  await mountPresence(true);
  startLoop();
  subscribePlayers();
  subscribeNotes();
  subscribeMeta();
  mounted=true;
}
async function ensureCapacity(){
  try{ const snap=await get(playersRef); const n=snap.exists()?snap.numChildren():0; return n<ROOM_CAP; }
  catch(e){ console.warn("capacity check failed:", e); return true; }
}
function showFull(){ full.style.display="flex"; full.innerHTML=`<div class="card"><h3>${LANG==="ja"?"æº€å“¡ã ":"Room is full"}</h3><p style="margin-top:0">${LANG==="ja"?"10äººã¾ã§":"Max 10 players"}</p></div>`; }

async function mountPresence(forceStand=false){
  try{
    const initialName=normalizeName(me.name);
    lastShownName.set(uid, initialName);
    await set(myRef(), {
      name: initialName,
      x:me.x, y:me.y, dir:me.dir,
      pose: forceStand?"stand":me.pose,
      msg:"", msgAt:0, pinMsg:"", pinAt:0,
      emo:"none", emoAt:0,
      lastActive: serverTimestamp()
    });
  }catch(e){ console.error("[rtdb] initial set failed:", e); }
  try{ onDisconnect(myRef()).remove(); }catch(e){ console.warn("[rtdb] onDisconnect failed:", e); }
}

/* ========= è³¼èª­ï¼šplayers ========= */
const domMap=new Map();
let initialPlayersLoaded=false;
let latestPlayers={};

function subscribePlayers(){
  onValue(playersRef, snap=>{
    const data=snap.val()||{};
    latestPlayers=data;
    const ids=Object.keys(data);
    countLabel.textContent=I18N[LANG].roomCount(ids.length);

    const seen=new Set(ids);
    for(const id of ids){
      let pdom=domMap.get(id);
      const isNew = !pdom;
      if(isNew){
        pdom=createPlayerDom(id);
        domMap.set(id,pdom);
        play.appendChild(pdom.wrap);
        // æ—¢ã«ãƒ«ãƒ¼ãƒ ãŒèµ°ã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ä»–è€…ãŒå…¥ã£ã¦ããŸã‚‰æ¼”å‡ºã¨éŸ³
        if(initialPlayersLoaded && id!==uid){
          const p=data[id];
          if(p){ joinBurstAt(p.x, p.y); }
          warpPulse(pdom);
          playLogin();
          const nm=resolveLabelName(id, data[id]?.name);
          toast(I18N[LANG].notify.join(nm));
        }
      }
      if(id===uid){
        const serverName=normalizeName(data[id]?.name);
        if(serverName){ me.name=serverName; lastShownName.set(uid, serverName); }
      }
      renderPlayer(pdom, data[id], id===uid);
    }

    for(const [id,pdom] of domMap){
      if(!seen.has(id)){
        const leftName = lastShownName.get(id) || "ãªãªã—";
        if(initialPlayersLoaded && id!==uid) toast(I18N[LANG].notify.leave(leftName));
        pdom.wrap.remove(); domMap.delete(id); lastShownName.delete(id);
      }
    }

    initialPlayersLoaded=true;
  }, (err)=>console.error("players onValue error:", err));
}

/* ========= å…¥å®¤æ¼”å‡ºï¼šå…‰ã®è¼ªï¼‹ã‚¹ãƒ‘ãƒ¼ã‚¯ï¼‹çŒ«ã‚°ãƒ­ãƒ¼ ========= */
function joinBurstAt(nx, ny){
  const r=getPlayRect(); if(!r) return;
  const {x,y}=toPx(nx,ny);
  const fx=document.createElement("div");
  fx.className="join-burst";
  fx.style.left=`${x}px`; fx.style.top=`${y}px`;
  const ring=document.createElement("div"); ring.className="ring"; fx.appendChild(ring);
  const N=14;
  for(let i=0;i<N;i++){
    const th=(Math.PI*2/N)*i + Math.random()*0.25;
    const dist=64 + Math.random()*36;
    const dx=Math.cos(th)*dist, dy=Math.sin(th)*dist;
    const s=document.createElement("span");
    s.className="spark";
    s.style.setProperty("--dx", `${dx.toFixed(1)}px`);
    s.style.setProperty("--dy", `${dy.toFixed(1)}px`);
    // å°ã•ãªã‚†ã‚‰ã
    s.style.animationDelay = `${(Math.random()*0.06).toFixed(3)}s`;
    fx.appendChild(s);
  }
  play.appendChild(fx);
  setTimeout(()=>fx.remove(), 950);
}
function warpPulse(pdom){
  // ä½ç½®å›ºå®šã®ã¾ã¾è»½ãã‚¹ã‚±ãƒ¼ãƒ«ã‚¤ãƒ³
  const r=getPlayRect(); if(!r) return;
  const mat = pdom.wrap.style.transform.match(/translate3d\(([^)]+)\)/);
  let px=0, py=0;
  if(mat){ const [ax,ay]=mat[1].split(",").map(s=>parseFloat(s)); px=ax||0; py=ay||0; }
  pdom.wrap.style.setProperty("--px", `${px}px`);
  pdom.wrap.style.setProperty("--py", `${py}px`);
  pdom.wrap.classList.add("warp");
  setTimeout(()=>pdom.wrap.classList.remove("warp"), 520);
}

/* ========= è³¼èª­ï¼šnotes ========= */
const notesDomMap=new Map();
onValue(notesRootRef(), snap=>{
  const nowMs=Date.now(); const seen=new Set(); hasOwnNote=false;
  snap.forEach(ch=>{
    const v=ch.val()||{}; const ts=Number(v.updatedAt||v.at||0);
    const alive=ts>0 && (nowMs-ts)<=NOTE_TTL_MS; const id=ch.key;
    if(alive){ upsertNoteDom(id,v); seen.add(id); if(id===uid) hasOwnNote=true; }
    else{ if(id===uid){ remove(noteRefOf(uid)).catch(()=>{}); } }
  });
  for(const [id,el] of notesDomMap){ if(!seen.has(id)){ el.remove(); notesDomMap.delete(id); } }
  noteClearBtn.disabled=!hasOwnNote;
});
function upsertNoteDom(ownerUid,data){
  let el=notesDomMap.get(ownerUid);
  if(!el){ el=document.createElement("div"); el.className="noteItem"; notesLayer.appendChild(el); notesDomMap.set(ownerUid, el); }
  el.textContent=data.text||""; el.dataset.x=String(data.x??0.5); el.dataset.y=String(data.y??0.7);
  positionNoteDom(el, Number(el.dataset.x), Number(el.dataset.y));
}
function positionNoteDom(el,nx,ny){ const r=getPlayRect(); if(!r) return; const px=roundPx(nx*r.width), py=roundPx(ny*r.height); const topSpace=py-130; if(topSpace<0){ el.classList.add("flip"); }else{ el.classList.remove("flip"); } el.style.transform=`translate3d(${px}px, ${py}px, 0) ${el.classList.contains("flip")?"translate(-50%, 18px)":"translate(-50%, -120%)"}`; }
window.addEventListener("resize", ()=>{ for(const [,el] of notesDomMap){ positionNoteDom(el, Number(el.dataset.x), Number(el.dataset.y)); } });

/* ========= ãƒ¡ã‚¿ï¼šæ–°éƒ¨å±‹é€šçŸ¥ ========= */
let NEXT_ROOM_ID=null;
onValue(metaRef(), snap=>{
  const m=snap.val()||{};
  if(m.nextRoom && m.at){
    NEXT_ROOM_ID=m.nextRoom;
    const byName=(latestPlayers[m.by]?.name)?resolveLabelName(m.by, latestPlayers[m.by].name):(LANG==="ja"?"ã ã‚Œã‹":"someone");
    migrateText.textContent=`ğŸ†• ${I18N[LANG].notify.newRoomBy(byName)}`;
    migrate.style.display="block";
  }else{
    migrate.style.display="none";
  }
});
migrateGo.addEventListener("click", ()=>{ if(!NEXT_ROOM_ID) return; const u=new URL(location.href); u.searchParams.set("room", NEXT_ROOM_ID); location.href=u.toString(); });

/* ========= ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼DOM ========= */
function createPlayerDom(id){
  const wrap=document.createElement("div"); wrap.className="p stand";
  const nameEl=document.createElement("div"); nameEl.className="name";
  const bubble=document.createElement("div"); bubble.className="bubble chat";
  const pinBubble=document.createElement("div"); pinBubble.className="bubble pin";
  const standImg=new Image(); standImg.src=CAT_STAND_URL; standImg.className="catImg stand";
  const sitImg  =new Image(); sitImg.src  =CAT_SIT_URL;   sitImg.className="catImg sit";
  const angryImg=new Image(); angryImg.src=CAT_ANGRY_URL; angryImg.className="catImg angry";
  wrap.appendChild(nameEl); wrap.appendChild(pinBubble); wrap.appendChild(bubble); wrap.appendChild(standImg); wrap.appendChild(sitImg); wrap.appendChild(angryImg);
  return {wrap, nameEl, bubbleEl:bubble, pinBubbleEl:pinBubble, standImg, sitImg, angryImg, _lastShownMsgAt:0, _flip:false, _id:id};
}
function renderPlayer(pdom, data, isSelf){
  const r=getPlayRect(); if(!r) return;
  const px=roundPx(data.x*r.width), py=roundPx(data.y*r.height);
  pdom.wrap.style.transform=`translate3d(${px}px, ${py}px, 0) translate(-50%, -80%)`;
  if(data.pose==="sit"){ pdom.wrap.classList.add("sit"); pdom.wrap.classList.remove("stand"); } else { pdom.wrap.classList.add("stand"); pdom.wrap.classList.remove("sit"); }
  const right=(data.dir===1); pdom.standImg.classList.toggle("right", right); pdom.sitImg.classList.toggle("right", right); pdom.angryImg.classList.toggle("right", right);
  const emoActive=(data.emo==="angry") && (Date.now()-Number(data.emoAt||0) <= EMO_SHOW_MS); pdom.wrap.classList.toggle("emo-angry", emoActive);

  const decidedName=resolveLabelName(pdom._id, data?.name);
  if(pdom.nameEl.textContent!==decidedName) pdom.nameEl.textContent=decidedName;

  // ä¸‹ç«¯ã§ã®é‡ãªã‚Šå›é¿
  const barH=bar.getBoundingClientRect().height||0;
  const visibleBottom=r.height-barH;
  const wantFlip=(py+110 > visibleBottom);
  if(!pdom._flip && wantFlip){ pdom.nameEl.classList.add("flip"); pdom._flip=true; }
  else if(pdom._flip && (py+130 < visibleBottom)){ pdom.nameEl.classList.remove("flip"); pdom._flip=false; }
  pdom.bubbleEl.classList.toggle("bump", pdom._flip);
  pdom.pinBubbleEl.classList.toggle("bump", pdom._flip);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆ60ç§’ï¼‰
  const raw=data.msg||""; const msgAt=Number(data.msgAt||0);
  if(raw && msgAt>0){
    const REPLAY_GUARD_MS=4000; const nowAbs=Date.now(); const isReplaySelf=isSelf && (msgAt - pdom._lastShownMsgAt < REPLAY_GUARD_MS);
    if(msgAt>pdom._lastShownMsgAt && !isReplaySelf){
      pdom.bubbleEl.textContent=raw; pdom.bubbleEl.style.display="block";
      clearTimeout(pdom._bubbleTimer);
      const age=Math.max(0, nowAbs-msgAt); const remain=Math.max(1200, 60000 - age);
      pdom._bubbleTimer=setTimeout(()=>{ pdom.bubbleEl.style.display="none"; }, remain);
      pdom._lastShownMsgAt=msgAt; if(!isSelf) playMessage();
    }
  }else{ pdom.bubbleEl.style.display="none"; }

  const pinText=data.pinMsg||""; pdom.pinBubbleEl.style.display=pinText?"block":"none"; if(pinText) pdom.pinBubbleEl.textContent=pinText;
}
function ensureMineDom(){ if(!uid) return; if(!domMap.get(uid)){ const d=createPlayerDom(uid); domMap.set(uid,d); play.appendChild(d.wrap); } const data={x:me.x,y:me.y,dir:me.dir,pose:me.pose,msg:me.msg,msgAt:me.msgAt,pinMsg:me.pinMsg,name:(lastShownName.get(uid)||normalizeName(me.name)),emo:me.emo,emoAt:me.emoAt}; renderPlayer(domMap.get(uid), data, true); }

/* ========= å…¥åŠ›/é€ä¿¡ ========= */
let lastSentAt=0;
msgInput.addEventListener("input", ()=>{
  const v=msgInput.value;
  if(isASCIIish(v)){ const w=countWordsASCII(v); hintLang.textContent=I18N[LANG].helperASCII(Math.min(w,10)); }
  else{ const len=Array.from(v).length; hintLang.textContent=I18N[LANG].helperCJK(Math.min(len,NON_ASCII_LIMIT)); }
  sendBtn.disabled=!validateMessage(v).ok;
});
sendBtn.addEventListener("click", sendMsg);
msgInput.addEventListener("keydown", e=>{ if(e.key==="Enter"){ e.preventDefault(); sendMsg(); }});
function validateMessage(raw){ if(!raw) return {ok:false}; if(isASCIIish(raw)){ if(countWordsASCII(raw)>10 || raw.length>100) return {ok:false}; } else { if(Array.from(raw).length>NON_ASCII_LIMIT) return {ok:false}; } return {ok:true}; }
function sendMsg(){ const raw=msgInput.value.trim(); if(!validateMessage(raw).ok) return; const nowMs=Date.now(); if(nowMs-lastSentAt<500) return; lastSentAt=nowMs; me.msg=raw; me.msgAt=nowMs; ensureMineDom(); const mine=domMap.get(uid); if(mine){ mine._lastShownMsgAt=nowMs; } msgInput.value=""; sendBtn.disabled=true; safeUpdate({msg:raw, msgAt:serverTimestamp()}); }

/* ========= ãƒ”ãƒ³ ========= */
function renderPinBtn(){ pinBtn.setAttribute("aria-pressed", me.pinMsg?"true":"false"); } renderPinBtn();
pinBtn.addEventListener("click", ()=>{
  if(me.pinMsg){ me.pinMsg=""; renderPinBtn(); safeUpdate({pinMsg:"", pinAt:0}); const mine=domMap.get(uid); if(mine){ mine.pinBubbleEl.style.display="none"; } toast(I18N[LANG].notify.pinOff); return; }
  const typed=msgInput.value.trim(); const pick=typed?typed:(me.msg?me.msg:""); if(!pick){ toast(LANG==="ja"?"ãƒ”ãƒ³ã«å…¥ã‚Œã‚‹æ–‡ãŒãªã„":"Nothing to pin"); return; }
  if(typed && !validateMessage(typed).ok){ toast(LANG==="ja"?"æ–‡å­—æ•°ã®ä¸Šé™ã‚’è¶…ãˆãŸ":"Too long"); return; }
  me.pinMsg=pick; renderPinBtn(); const mine=domMap.get(uid); if(mine){ mine.pinBubbleEl.textContent=pick; mine.pinBubbleEl.style.display="block"; } safeUpdate({pinMsg:pick, pinAt:serverTimestamp()}); toast(I18N[LANG].notify.pinOn);
});

/* ========= æ›¸ãç½®ã ========= */
noteBtn.addEventListener("click", async ()=>{
  const typed=msgInput.value.trim(); const pick=typed?typed:(me.msg?me.msg:""); if(!pick){ toast(LANG==="ja"?"æ›¸ãç½®ãã™ã‚‹æ–‡ãŒãªã„":"Nothing to note"); return; }
  if(typed && !validateMessage(typed).ok){ toast(LANG==="ja"?"æ–‡å­—æ•°ã®ä¸Šé™ã‚’è¶…ãˆãŸ":"Too long"); return; }
  try{
    const r=noteRefOf(uid); const nowXY={x:me.x,y:me.y}; const snap=await get(r); const authorName=normalizeName(me.name);
    if(snap.exists()){ await update(r,{text:pick,author:authorName,uid:uid||"",x:nowXY.x,y:nowXY.y,updatedAt:serverTimestamp()}); toast(I18N[LANG].notify.noteUpdated); }
    else{ await set(r,{text:pick,author:authorName,uid:uid||"",x:nowXY.x,y:nowXY.y,at:serverTimestamp(),updatedAt:serverTimestamp()}); toast(I18N[LANG].notify.noteSaved); }
  }catch(e){ console.error("note set/update failed:", e); toast(LANG==="ja"?"æ›¸ãç½®ãã«å¤±æ•—":"Note failed"); }
});
noteClearBtn.addEventListener("click", async ()=>{ if(!uid) return; try{ await remove(noteRefOf(uid)); toast(I18N[LANG].notify.noteCleared); }catch(e){ console.error("note clear failed:", e); toast(LANG==="ja"?"å‰Šé™¤ã«å¤±æ•—":"Failed to clear"); } });

/* ========= å¨åš‡ ========= */
angerBtn.addEventListener("click", ()=>{ me.emo="angry"; me.emoAt=Date.now(); ensureMineDom(); safeUpdate({emo:"angry", emoAt:serverTimestamp()}); setTimeout(()=>{ if(Date.now()-me.emoAt>=EMO_SHOW_MS){ me.emo="none"; ensureMineDom(); } }, EMO_SHOW_MS+120); });

/* ========= ãƒãƒ¼ã‚º ========= */
function renderPoseTopBtn(){ lblPose.textContent = " " + (me.pose==="stand" ? I18N[LANG].poseSit : I18N[LANG].poseStand); } renderPoseTopBtn();
poseTopBtn.addEventListener("click", togglePose);
window.addEventListener("keydown", e=>{ const tag=(e.target && e.target.tagName)?e.target.tagName.toLowerCase():""; if(tag==="input"||tag==="textarea"||(e.target&&e.target.isContentEditable)) return; if(e.key.toLowerCase()==="s"){ togglePose(); }});
function togglePose(){ me.pose=(me.pose==="stand")?"sit":"stand"; renderPoseTopBtn(); safeUpdate({pose:me.pose}); }

/* ========= ã‚¿ãƒƒãƒ—ç§»å‹• ========= */
function setTargetFromEvent(e){ const pt=(e.touches&&e.touches[0])?e.touches[0]:e; const {x,y}=toNorm(pt.clientX, pt.clientY); const pxNow=toPx(me.x, me.y).x; const pxNext=toPx(x,y).x; target.x=x; target.y=y; me.dir=(pxNext>=pxNow)?1:-1; safeUpdate({dir:me.dir}); pingAt(x,y); }
play.addEventListener("pointerdown", setTargetFromEvent);
play.addEventListener("touchstart", setTargetFromEvent, {passive:true});
play.addEventListener("dblclick", e=>{ e.preventDefault(); }, {passive:false});

/* ========= ãƒ«ãƒ¼ãƒ— ========= */
let loopStarted=false; let lastT=now();
function startLoop(){ if(loopStarted) return; loopStarted=true; requestAnimationFrame(loop); }
function loop(){ const t=now(); const dt=Math.max(0, Math.min(0.05,(t-lastT)/1000)); lastT=t; const r=getPlayRect(); if(!r){ requestAnimationFrame(loop); return; } const pxPos=toPx(me.x,me.y), pxTarget=toPx(target.x,target.y); const dx=pxTarget.x-pxPos.x, dy=pxTarget.y-pxPos.y, dist=Math.hypot(dx,dy); const step=120*dt; if(dist>1){ const nx=pxPos.x+(dx/dist)*step, ny=pxPos.y+(dy/dist)*step; const nn=toNorm(nx+r.left, ny+r.top); me.x=nn.x; me.y=nn.y; } else { me.x=target.x; me.y=target.y; } ensureMineDom(); const tt=performance.now(); if((tt-lastSync)>=SYNC_INTERVAL_MS){ safeUpdate({x:me.x,y:me.y}); lastSync=tt; } if((tt-lastHeartbeat)>=HEARTBEAT_MS){ safeUpdate({lastActive:serverTimestamp()}); lastHeartbeat=tt; } requestAnimationFrame(loop); }

/* ========= æ›¸ãè¾¼ã¿ ========= */
async function safeUpdate(patch){ if(!uid) return; try{ await update(myRef(), patch); }catch(e){ console.error("[rtdb] update failed:", patch, e); } }

/* ========= åç°¿ ========= */
function peekNames(){ const names=Object.entries(latestPlayers).map(([id,p])=>resolveLabelName(id,p?.name)); const list=names.length?names.join(" / "):(LANG==="ja"?"ã„ã¾ã¯èª°ã‚‚ã„ãªã„":"Nobody here"); namesPeek.textContent=I18N[LANG].namesPeek(list); namesPeek.style.display="block"; clearTimeout(peekNames._t); peekNames._t=setTimeout(()=>namesPeek.style.display="none", 2500); }
["click","keydown"].forEach(ev=>{ playersBtn.addEventListener(ev, e=>{ if(ev==="keydown" && e.key!=="Enter" && e.key!==" ") return; peekNames(); }); });

/* ========= å…±æœ‰/ãƒ˜ãƒ«ãƒ—/æ–°éƒ¨å±‹ ========= */
shareBtn.addEventListener("click", async ()=>{ const invite=new URL(location.href); invite.searchParams.set("room", WORLD_ID); invite.hash=invite.hash.replace(/room=[^&]+&?/,'').replace(/[#&]$/,''); try{ if(navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(invite.toString()); toast(I18N[LANG].notify.urlCopied); } else { prompt(LANG==="ja"?"ã“ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ã­":"Copy this URL", invite.toString()); } }catch(e){ console.warn("clipboard failed:", e); } });
helpBtn.addEventListener("click", ()=>{ helpDialog.innerHTML=`<div style="padding:16px 16px 12px; max-width:560px">${I18N[LANG].helpHtml}<div style="display:flex; gap:8px; justify-content:flex-end"><button id="helpClose" class="btn">OK</button></div></div>`; helpDialog.showModal(); helpDialog.querySelector("#helpClose").addEventListener("click", ()=>helpDialog.close(), {once:true}); });
newRoomBtn.addEventListener("click", async ()=>{ const id=makeRoomId(); try{ await update(metaRef(), {nextRoom:id, by:uid||"", at:serverTimestamp()}); toast(LANG==="ja"?"æ–°ã—ã„éƒ¨å±‹ã‚’ä½œã£ãŸ":"New room created"); }catch(e){ console.error("set nextRoom failed:", e); toast(LANG==="ja"?"æ–°ã—ã„éƒ¨å±‹ã®ä½œæˆã«å¤±æ•—":"Failed to create"); } });

/* ========= ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¡¨ç¤º ========= */
window.addEventListener("online", ()=>toast(I18N[LANG].notify.online));
window.addEventListener("offline", ()=>toast(I18N[LANG].notify.offline));

(function(){ const needs=["apiKey","authDomain","databaseURL","projectId","appId"]; if(needs.some(k=>!firebaseConfig[k])) toast("Firebaseã®configã‚’å…¥ã‚Œã¦ã‹ã‚‰ä½¿ã†"); worldLabel.textContent=`room: ${WORLD_ID}`; applyLang(); })();
msgInput.dispatchEvent(new Event("input"));
</script>
</body>
</html>
